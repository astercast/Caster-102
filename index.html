<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Caster101</title>
    <link rel="icon" type="image/webp" href="/images/favicon.webp">
    <!-- Performance: Preconnect to external APIs -->
    <link rel="preconnect" href="https://api.coingecko.com">
    <link rel="preconnect" href="https://api.spacescan.io">
    <link rel="preconnect" href="https://api.v2.tibetswap.io">
    <link rel="preconnect" href="https://xchscan.com">
    <link rel="preconnect" href="https://api.mintgarden.io">
    <style>
        /* Optimized font loading - reduced to essential families */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=Press+Start+2P&display=swap');
        
        @font-face {
            font-family: 'Valve Occult';
            src: local('Cinzel Bold'), local('Cinzel-Bold');
            font-weight: 600;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
            overflow-x: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 14px;
            height: 14px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.75);
            border: none;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #fbbf24, #dc2626);
            border: none;
            border: none;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #fcd34d, #ef4444);
        }

        body {
            font-family: 'Valve Occult', 'Cinzel', 'Press Start 2P', cursive;
            background: linear-gradient(180deg, #0a0a0a 0%, #1a0000 50%, #0a0a0a 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        @keyframes gentleFloat {

            0%,
            100% {
                opacity: 0.2;
                transform: translateY(0);
            }

            50% {
                opacity: 0.4;
                transform: translateY(-10px);
            }
        }

        @keyframes growShrink {
            0%, 100% {
                transform: scale(1);
                opacity: 0.3;
            }
            50% {
                transform: scale(1.15);
                opacity: 0.5;
            }
        }

        @keyframes slowRotate {
            0% {
                transform: rotate(0deg);
                opacity: 0.25;
            }
            50% {
                opacity: 0.4;
            }
            100% {
                transform: rotate(360deg);
                opacity: 0.25;
            }
        }

        @keyframes floatAndGrow {
            0%, 100% {
                transform: translateY(0) scale(1);
                opacity: 0.2;
            }
            50% {
                transform: translateY(-15px) scale(1.1);
                opacity: 0.45;
            }
        }

        @keyframes gentleRotateFloat {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
                opacity: 0.25;
            }
            50% {
                transform: translateY(-10px) rotate(5deg);
                opacity: 0.4;
            }
        }

        .bg-collage {
            position: fixed;
            inset: 0;
            pointer-events: none;
            opacity: 0.3;
            filter: blur(1px) brightness(0.7);
            z-index: 0;
        }

        .bg-image {
            position: absolute;
            border: none;
            border: none;
            object-fit: cover;
            /* Animation set inline */
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .glitter {
            position: fixed;
            pointer-events: none;
            animation: twinkle 2s ease-in-out infinite;
            z-index: 1;
            will-change: opacity, transform;
            transform: translate3d(0, 0, 0); /* GPU acceleration */
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 12px;
            padding-bottom: 40px;
            position: relative;
            z-index: 10;
        }

        /* Mobile: No layout changes - full desktop view */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
                padding-bottom: 40px;
            }
        }

        .header {
            background: linear-gradient(to right, rgba(220, 38, 38, 0.65), rgba(251, 191, 36, 0.65), rgba(220, 38, 38, 0.65));
            border: 2px solid rgba(251, 191, 36, 0.7);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(220, 38, 38, 0.4),
                        0 0 0 1px rgba(251, 191, 36, 0.3),
                        0 0 40px rgba(251, 191, 36, 0.2);
            position: relative;
            z-index: 12;
        }

        /* Ensure all text in header stays above images */
        .header * {
            position: relative;
            z-index: 16;
        }

        .title {
            font-size: 42px;
            font-weight: 900;
            text-align: center;
            letter-spacing: 12px;
            text-transform: uppercase;
            margin-bottom: 10px;
            padding: 8px;
            background: none;
            border: none;
            border-radius: 8px;
            text-shadow: none;
            line-height: 1.2;
            position: relative;
            z-index: 20;
        }

        /* Mobile: Keep desktop font sizes */
        @media (max-width: 768px) {
            .title {
                font-size: 42px;
                letter-spacing: 12px;
                padding: 8px;
            }
        }
        
        /* Small mobile: Keep desktop fonts */
        @media (max-width: 480px) {
            .title {
                font-size: 42px;
                letter-spacing: 12px;
            }
        }

        .marquee {
            color: #fbbf24;
            font-size: 24px;
            font-weight: bold;
            margin-top: 8px;
            overflow: hidden;
            white-space: nowrap;
            font-family: 'Inter', 'Papyrus', 'Copperplate', 'fantasy', serif;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.75);
            position: relative;
            z-index: 20;
            /* Marquee above bouncing images */
        }

        @media (max-width: 768px) {
            .marquee {
                font-size: 24px;
            }
        }

        .marquee-track {
            display: flex;
            width: max-content;
            animation: marqueeScroll 90s linear infinite;
            white-space: nowrap;
        }

        .marquee-span {
            padding-right: 60px;
            display: inline-block;
            white-space: nowrap;
        }

        @keyframes marqueeScroll {
            from { transform: translateX(0); }
            to   { transform: translateX(-50%); }
        }

        .stats {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .stat-badge {
            background: rgba(0, 0, 0, 0.78);
            padding: 6px 12px;
            border: none;
            font-size: 10px;
            font-weight: bold;
            border: none;
        }

        .refresh-btn {
            background: linear-gradient(to right, #dc2626, #fbbf24);
            border: none;
            border: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 18px;
        }

        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            background: linear-gradient(to right, #dc2626, #fbbf24, #dc2626);
            padding: 4px;
            border: none;
        }

        .tab {
            flex: 1;
            padding: 8px 10px;
            font-weight: 600;
            font-size: 11px;
            font-family: 'Inter', 'Segoe UI', sans-serif;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.3px;
            position: relative;
            background: linear-gradient(135deg, rgba(20, 20, 30, 0.6), rgba(10, 10, 20, 0.8));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(220, 38, 38, 0.3);
            border-radius: 10px;
            margin: 0 2px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3),
                        0 0 0 1px rgba(220, 38, 38, 0.15);
            will-change: transform, background; /* Optimize tab switching */
        }
        
        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(251, 191, 36, 0.5), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.95), rgba(251, 191, 36, 0.85));
            color: #000;
            border: 1px solid rgba(251, 191, 36, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(251, 191, 36, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3),
                        0 0 0 1px rgba(251, 191, 36, 0.4),
                        0 0 30px rgba(251, 191, 36, 0.2);
        }
        
        .tab.active::before {
            opacity: 1;
        }

        .tab:not(.active) {
            color: rgba(255, 255, 255, 0.9);
        }

        .tab-emoji {
            font-size: 0.7em;
            opacity: 0.85;
        }

        /* Desktop: show full labels, hide short labels */
        .tab-label-short {
            display: none;
        }

        .tab-label-full {
            display: inline;
        }

        .tab:hover:not(.active) {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(251, 191, 36, 0.1));
            border: 1px solid rgba(251, 191, 36, 0.4);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.1),
                        0 0 0 1px rgba(251, 191, 36, 0.2),
                        0 0 20px rgba(251, 191, 36, 0.1);
        }

        /* Mobile tabs: Keep desktop size */
        @media (max-width: 768px) {
            .tab {
                font-size: 11px;
                padding: 8px 10px;
                margin: 0 2px;
                letter-spacing: 0.3px;
            }
        }

        .content {
            display: none;
        }

        .content.active {
            display: block;
        }

        .filter-section {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: linear-gradient(135deg, rgba(20, 20, 30, 0.7), rgba(10, 10, 20, 0.85));
            border: 1px solid rgba(220, 38, 38, 0.4);
            padding: 8px 16px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3),
                        0 0 0 1px rgba(220, 38, 38, 0.2);
        }

        .filter-btn.active {
            background: #fbbf24;
            color: black;
            transform: scale(1.05);
        }

        .search-bar {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            border: none;
            border: none;
            background: rgba(0, 0, 0, 0.78);
            color: #fbbf24;
            font-weight: bold;
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #dc2626;
        }

        /* Keep desktop grid structure on mobile */
        .chain-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* New Responsive & Layout Styles */
        .market-columns {
            display: flex;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .market-columns {
                gap: 12px;
            }
        }

        .market-column {
            flex: 1;
            background: #0a0a0a;
            border: none;
            padding: 10px;
            border: none;
        }

        @media (max-width: 768px) {
            .market-column {
                padding: 6px;
                border: none;
                border: none;
            }
        }

        .market-column.base-column {
            border: none;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
        }

        .market-column.chia-column {
            border: none;
            box-shadow: 0 0 15px rgba(132, 204, 22, 0.2);
        }

        .column-header {
            padding: 12px;
            font-weight: 900;
            font-size: 16px;
            text-align: center;
            border: 2px solid rgba(74, 222, 128, 0.5);
            border-radius: 8px;
            margin-bottom: 12px;
            font-family: 'Inter', sans-serif;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3),
                        0 0 0 1px rgba(74, 222, 128, 0.3),
                        0 0 20px rgba(74, 222, 128, 0.2);
        }

        /* Mobile: Keep desktop header styling */
        @media (max-width: 768px) {
            .column-header {
                font-size: 16px;
            }
        }

        .column-header.base {
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.3), transparent);
            color: #3b82f6;
            text-shadow: 0 0 10px #3b82f6;
        }

        .column-header.chia {
            background: linear-gradient(90deg, transparent, rgba(132, 204, 22, 0.3), transparent);
            color: #84cc16;
            text-shadow: 0 0 10px #84cc16;
        }

        .token-card {
            background: linear-gradient(135deg, rgba(20, 20, 30, 0.9), rgba(10, 10, 20, 0.95));
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(251, 191, 36, 0.25);
            border-radius: 14px;
            padding: 14px 18px;
            margin-bottom: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.08),
                        0 2px 8px rgba(251, 191, 36, 0.05);
            content-visibility: auto;
            contain: layout style paint;
        }
        
        .token-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(251, 191, 36, 0.08), 
                transparent
            );
            transition: left 0.5s ease;
            pointer-events: none;
        }
        
        .token-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(251, 191, 36, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(220, 38, 38, 0.03) 0%, transparent 50%);
            pointer-events: none;
            opacity: 0.6;
        }

        @media (max-width: 768px) {
            .token-card {
                padding: 10px 12px;
                margin-bottom: 6px;
                border-radius: 10px;
            }
        }

        /* Desktop specific interactions */
        @media (min-width: 769px) {
            .token-card:hover {
                transform: translateY(-3px) scale(1.01) translate3d(0, 0, 0);
                border: 1px solid rgba(251, 191, 36, 0.7);
                box-shadow: 0 12px 32px rgba(251, 191, 36, 0.2),
                            0 6px 16px rgba(0, 0, 0, 0.5),
                            inset 0 1px 0 rgba(255, 255, 255, 0.15),
                            0 0 0 1px rgba(251, 191, 36, 0.4),
                            0 0 24px rgba(251, 191, 36, 0.25),
                            inset 0 0 30px rgba(251, 191, 36, 0.03);
                background: linear-gradient(135deg, rgba(35, 35, 45, 0.95), rgba(20, 20, 30, 0.98));
                cursor: pointer;
                z-index: 10;
            }
            
            .token-card:hover::before {
                left: 100%;
            }

            .token-card:hover::after {
                content: "↗ VIEW";
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, rgba(251, 191, 36, 0.25), rgba(251, 191, 36, 0.12));
                color: #fbbf24;
                padding: 8px 18px;
                border-radius: 8px;
                border: 1px solid rgba(251, 191, 36, 0.4);
                font-size: 11px;
                font-weight: 700;
                letter-spacing: 1px;
                pointer-events: none;
                opacity: 0;
                animation: fadeInCenter 0.25s forwards;
                z-index: 20;
                backdrop-filter: blur(4px);
                white-space: nowrap;
            }

            @keyframes fadeInCenter {
                from { opacity: 0; transform: translate(-50%, -50%) scale(0.85); }
                to   { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }
        }
        /* ↑ @media (min-width: 769px) closed */

        .token-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .token-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0;
        }

        .token-info {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }

        .token-symbol {
            font-size: 28px;
            line-height: 1;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .token-symbol {
                font-size: 28px;
            }
        }

        .token-name {
            font-size: 15px;
            color: #fbbf24;
            font-weight: 700;
            font-family: 'Cinzel', serif;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            line-height: 1.2;
        }

        @media (max-width: 768px) {
            .token-name {
                font-size: 15px;
                letter-spacing: 0.5px;
            }
        }

        .token-price {
            font-weight: 700;
            color: white;
            font-family: 'Cinzel', serif;
            font-size: 16px;
            line-height: 1.2;
        }

        @media (max-width: 768px) {
            .token-price {
                font-size: 16px;
            }
        }

        .token-change {
            font-size: 15px;
            font-weight: bold;
            margin-top: 2px;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .token-change {
                font-size: 13px;
            }
        }

        .chain-badge {
            display: none;
        }

        .token-stats {
            display: none;
        }

        .contract-info {
            display: none;
        }

        .address-input-section {
            background: rgba(0, 0, 0, 0.82);
            border: none;
            border: none;
            border: none;
            padding: 16px;
            margin-bottom: 24px;
        }

        .input-group {
            display: flex;
            gap: 8px;
        }

        .address-input {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border: none;
            background: rgba(0, 0, 0, 0.78);
            color: #fbbf24;
            font-weight: bold;
            font-size: 12px;
        }

        .track-btn {
            padding: 10px 20px;
            background: linear-gradient(to right, #fbbf24, #dc2626);
            border: none;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 12px;
            color: black;
        }

        .total-value {
            background: linear-gradient(to right, #dc2626, #000000);
            border: none;
            border: none;
            padding: 24px;
            margin-bottom: 24px;
        }

        .total-amount {
            font-size: 32px;
            font-weight: bold;
            color: #fbbf24;
            margin: 8px 0;
        }

        .footer {
            text-align: center;
            border: none;
            border: none;
            padding: 16px;
            background: linear-gradient(to right, #dc2626, #000000);
            margin-top: 32px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #fbbf24;
        }

        .quick-links {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            justify-content: center;
            overflow-x: auto;
        }

        .quick-link-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(251, 191, 36, 0.7);
            border-radius: 6px;
            color: white;
            text-decoration: none;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(8px);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .quick-link-btn:hover {
            transform: translateY(-2px);
            border-color: rgba(251, 191, 36, 1);
            background: rgba(251, 191, 36, 0.1);
        }

        /* Mobile: Desktop quick links */
        @media (max-width: 768px) {
            .quick-link-btn {
                font-size: 13px;
                padding: 10px 14px;
            }
        }

        .warp-btn {
            border: none;
            color: #a855f7;
            box-shadow: 0 0 12px rgba(168, 85, 247, 0.3);
        }

        .warp-btn:hover {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.2));
            color: #d946ef;
            border: none;
            box-shadow: 0 4px 20px rgba(217, 70, 239, 0.5);
        }

        /* Treasury Split Responsive - Keep 2 columns on mobile */
        .treasury-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 768px) {
            .treasury-split {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
        }

        /* Spotify Mini Player */
        .spotify-mini {
            position: relative;
            margin: 20px auto 8px;
            max-width: 680px;
            background: linear-gradient(135deg, rgba(8, 12, 20, 0.95), rgba(16, 20, 30, 0.92));
            border: 1px solid rgba(29, 185, 84, 0.35);
            border-radius: 14px;
            box-shadow: 0 10px 26px rgba(0, 0, 0, 0.45), 0 0 24px rgba(29, 185, 84, 0.08);
            backdrop-filter: blur(12px);
            padding: 10px 12px 8px;
        }

        .spotify-mini-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 6px;
        }

        .spotify-mini-title {
            font-family: 'Cinzel', serif;
            font-size: 11px;
            letter-spacing: 0.8px;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
        }

        .spotify-mini-title span {
            color: #1db954;
            font-weight: 700;
        }

        .spotify-mini-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spotify-mini-btn {
            border: 1px solid rgba(29, 185, 84, 0.45);
            background: rgba(29, 185, 84, 0.15);
            color: #b7f3cc;
            font-size: 9px;
            padding: 5px 8px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .spotify-mini-btn:hover {
            background: rgba(29, 185, 84, 0.25);
            border-color: rgba(29, 185, 84, 0.8);
            transform: translateY(-1px);
        }

        .spotify-mini-close {
            border: none;
            background: rgba(255, 255, 255, 0.12);
            color: rgba(255, 255, 255, 0.7);
            width: 24px;
            height: 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            transition: all 0.2s ease;
        }

        .spotify-mini-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .spotify-mini-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .spotify-mini-controls button {
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.85);
            font-size: 11px;
            padding: 5px 8px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            transition: all 0.2s ease;
        }

        .spotify-mini-controls button:hover {
            background: rgba(255, 255, 255, 0.16);
        }

        .spotify-mini-embed {
            width: 100%;
            height: 124px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(0, 0, 0, 0.4);
        }

        @media (max-width: 768px) {
            .spotify-mini {
                margin: 16px auto 6px;
                max-width: 100%;
                padding: 8px 10px 6px;
            }

            .spotify-mini-title {
                font-size: 10px;
                letter-spacing: 0.6px;
            }

            .spotify-mini-controls {
                flex-wrap: wrap;
            }

            .spotify-mini-embed {
                height: 110px;
            }
        }

        /* ==========================================================
           MOBILE RESPONSIVE LAYOUT — Premium Redesign
           Modern, minimal typography with Space Grotesk + Inter.
           Desktop is completely untouched.
           ========================================================== */

        @media (max-width: 768px) {

            /* ── Global Mobile Typography ── */
            body {
                font-family: 'Space Grotesk', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
                -webkit-font-smoothing: antialiased !important;
                -moz-osx-font-smoothing: grayscale !important;
                letter-spacing: -0.01em !important;
            }

            /* ── Page Flip Animations for Swipe Navigation ── */
            @keyframes flipInLeft {
                from {
                    transform: perspective(1200px) rotateY(-90deg);
                    opacity: 0;
                }
                to {
                    transform: perspective(1200px) rotateY(0);
                    opacity: 1;
                }
            }

            @keyframes flipInRight {
                from {
                    transform: perspective(1200px) rotateY(90deg);
                    opacity: 0;
                }
                to {
                    transform: perspective(1200px) rotateY(0);
                    opacity: 1;
                }
            }

            @keyframes flipOutLeft {
                from {
                    transform: perspective(1200px) rotateY(0);
                    opacity: 1;
                }
                to {
                    transform: perspective(1200px) rotateY(90deg);
                    opacity: 0;
                }
            }

            @keyframes flipOutRight {
                from {
                    transform: perspective(1200px) rotateY(0);
                    opacity: 1;
                }
                to {
                    transform: perspective(1200px) rotateY(-90deg);
                    opacity: 0;
                }
            }

            .content {
                transform-style: preserve-3d !important;
            }

            .content.flip-in-left {
                animation: flipInLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards !important;
            }

            .content.flip-in-right {
                animation: flipInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards !important;
            }

            .content.flip-out-left {
                animation: flipOutLeft 0.3s cubic-bezier(0.4, 0, 0.6, 1) forwards !important;
            }

            .content.flip-out-right {
                animation: flipOutRight 0.3s cubic-bezier(0.4, 0, 0.6, 1) forwards !important;
            }

            /* ── Base Layout ── */
            .container {
                padding: 10px !important;
                padding-bottom: 80px !important;
                max-width: 100% !important;
            }

            .bg-collage {
                display: none !important;
            }

            /* ── Header ── */
            .header {
                padding: 16px 14px !important;
                margin-bottom: 14px !important;
                border-radius: 16px !important;
                border-width: 1px !important;
            }

            .title {
                font-size: 24px !important;
                letter-spacing: 4px !important;
                padding: 4px !important;
                margin-bottom: 6px !important;
                font-weight: 700 !important;
            }

            .marquee {
                font-family: 'Inter', sans-serif !important;
                font-size: 11px !important;
                font-weight: 500 !important;
                margin-top: 6px !important;
                letter-spacing: 0.02em !important;
                opacity: 0.85 !important;
            }

            .marquee-span {
                padding-right: 40px !important;
            }

            .stats {
                gap: 6px !important;
                margin-top: 8px !important;
                justify-content: center !important;
                flex-wrap: wrap !important;
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                text-align: center !important;
            }

            .stat-badge {
                font-family: 'Inter', sans-serif !important;
                font-size: 10px !important;
                font-weight: 600 !important;
                padding: 5px 10px !important;
                border-radius: 8px !important;
                letter-spacing: 0.02em !important;
                justify-content: center !important;
            }

            /* ── Tab Navigation — Fixed bottom bar ── */
            .tabs {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 99999 !important;
                display: grid !important;
                grid-template-columns: repeat(6, 1fr) !important;
                gap: 0 !important;
                padding: 0 !important;
                margin: 0 !important;
                border-radius: 0 !important;
                background: rgba(5, 5, 10, 0.97) !important;
                backdrop-filter: blur(20px) !important;
                -webkit-backdrop-filter: blur(20px) !important;
                border: none !important;
                border-top: 1px solid rgba(251, 191, 36, 0.25) !important;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.6) !important;
                overflow: visible !important;
                flex-wrap: nowrap !important;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab {
                flex: none !important;
                font-family: 'Inter', sans-serif !important;
                font-size: 8px !important;
                font-weight: 700 !important;
                padding: 8px 2px 10px !important;
                white-space: nowrap !important;
                min-width: 0 !important;
                border-radius: 0 !important;
                letter-spacing: 0 !important;
                text-transform: uppercase !important;
                border: none !important;
                box-shadow: none !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                gap: 3px !important;
                color: rgba(255,255,255,0.5) !important;
                background: transparent !important;
                transition: color 0.2s, background 0.15s !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }

            .tab.active {
                color: #fbbf24 !important;
                background: rgba(251, 191, 36, 0.1) !important;
                box-shadow: inset 0 2px 0 #fbbf24 !important;
            }

            /* Show emoji as icon above label in bottom bar */
            .tab-emoji {
                display: inline !important;
                font-size: 16px !important;
                line-height: 1 !important;
            }

            /* Hide the second emoji (after label text) */
            .tab .tab-emoji:last-child {
                display: none !important;
            }

            /* Show short labels, hide full labels on mobile */
            .tab-label-full {
                display: none !important;
            }

            .tab-label-short {
                display: block !important;
                font-size: 7px !important;
                line-height: 1.1 !important;
                letter-spacing: 0.02em !important;
            }

            /* ── Market Tab ── */

            /* Quick Links — compact pill row */
            .quick-links {
                flex-wrap: nowrap !important;
                gap: 6px !important;
                justify-content: flex-start !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                padding-bottom: 2px !important;
            }
            .quick-links::-webkit-scrollbar { display: none; }

            .quick-link-btn {
                font-family: 'Inter', sans-serif !important;
                font-size: 10px !important;
                font-weight: 600 !important;
                padding: 8px 12px !important;
                border-radius: 10px !important;
                border-width: 1px !important;
                letter-spacing: 0.01em !important;
            }

            /* Search bar */
            .search-input {
                font-family: 'Inter', sans-serif !important;
                font-size: 14px !important;
                font-weight: 500 !important;
                padding: 12px 12px 12px 38px !important;
                border-radius: 12px !important;
                letter-spacing: 0 !important;
            }

            /* Featured Tokens — stack */
            .featured-tokens-grid {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
                margin-bottom: 16px !important;
            }

            /* Filter buttons — modern pills */
            .filter-section {
                gap: 8px !important;
            }

            .filter-btn {
                font-family: 'Space Grotesk', sans-serif !important;
                padding: 9px 14px !important;
                font-size: 12px !important;
                font-weight: 600 !important;
                border-radius: 10px !important;
                letter-spacing: 0.02em !important;
            }

            /* Market Columns — SIDE BY SIDE on mobile */
            .market-columns {
                flex-direction: row !important;
                gap: 6px !important;
            }

            .market-column {
                flex: 1 !important;
                min-width: 0 !important;
                width: 50% !important;
                padding: 3px !important;
                border-radius: 12px !important;
            }

            .column-header {
                font-family: 'Space Grotesk', sans-serif !important;
                font-size: 12px !important;
                font-weight: 700 !important;
                padding: 8px 6px !important;
                margin-bottom: 6px !important;
                border-radius: 8px !important;
                letter-spacing: 0.04em !important;
                text-transform: uppercase !important;
                min-height: 40px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }

            /* Token Cards — compact vertical layout for half-width */
            .token-card {
                padding: 10px 8px !important;
                margin-bottom: 6px !important;
                border-radius: 10px !important;
                border-width: 1px !important;
                min-height: 135px !important;
                display: flex !important;
                flex-direction: column !important;
            }

            .token-grid {
                gap: 6px !important;
            }

            /* Reflow token-header to vertical stack */
            .token-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 6px !important;
            }

            /* Top row: emoji + name */
            .token-info {
                gap: 8px !important;
                width: 100% !important;
            }

            /* Shrink the emoji icon box */
            .token-info > div:first-child {
                width: 28px !important;
                height: 28px !important;
                min-width: 28px !important;
                border-radius: 8px !important;
            }

            .token-symbol {
                font-size: 14px !important;
            }

            .token-name {
                font-family: 'Space Grotesk', sans-serif !important;
                font-size: 11px !important;
                font-weight: 600 !important;
                letter-spacing: 0.02em !important;
                text-transform: uppercase !important;
                color: rgba(255, 255, 255, 0.95) !important;
                line-height: 1.3 !important;
                word-break: break-word !important;
            }

            /* Chain label under name */
            .token-info div:last-child > div:last-child {
                font-size: 8px !important;
            }

            /* Price + change row: full width, left-aligned */
            .token-header > div:last-child {
                text-align: left !important;
                width: 100% !important;
                display: flex !important;
                align-items: baseline !important;
                gap: 6px !important;
            }

            .token-price {
                font-family: 'Space Grotesk', sans-serif !important;
                font-size: 13px !important;
                font-weight: 700 !important;
                letter-spacing: -0.01em !important;
                font-variant-numeric: tabular-nums !important;
            }

            .token-change {
                font-family: 'Inter', sans-serif !important;
                font-size: 10px !important;
                font-weight: 600 !important;
                font-variant-numeric: tabular-nums !important;
                margin-top: 0 !important;
            }

            /* Market cap footer row — tighter */
            .token-card > div:last-child {
                margin-top: 6px !important;
                padding-top: 6px !important;
                padding: 4px 0 !important;
            }

            .token-card > div:last-child span:first-child {
                font-size: 8px !important;
            }

            .token-card > div:last-child span:last-child {
                font-size: 11px !important;
            }

            /* Merkl Magic Box */
            #merkl-section {
                padding: 16px !important;
                margin-top: 20px !important;
                border-radius: 16px !important;
            }

            #merkl-section h3 {
                font-family: 'Space Grotesk', sans-serif !important;
                font-size: 18px !important;
            }

            #merkl-pools {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            /* ── Portfolio / Bag Tab ── */
            #portfolio h1 {
                font-family: 'Space Grotesk', sans-serif !important;
                font-size: 24px !important;
                font-weight: 700 !important;
                letter-spacing: 0 !important;
            }

            #portfolio p {
                font-family: 'Inter', sans-serif !important;
            }

            .wallet-input-row {
                flex-direction: column !important;
                gap: 10px !important;
            }

            #track-btn {
                width: 100% !important;
                box-sizing: border-box !important;
                font-family: 'Space Grotesk', sans-serif !important;
                font-weight: 700 !important;
                border-radius: 12px !important;
                letter-spacing: 0.03em !important;
            }

            #walletAddress {
                font-family: 'Inter', sans-serif !important;
                font-size: 13px !important;
                border-radius: 12px !important;
            }

            /* ── Treasury Tab ── */
            .treasury-wrapper {
                padding: 8px !important;
            }

            .treasury-main-header {
                padding: 20px 14px !important;
                border-radius: 16px !important;
                margin-bottom: 16px !important;
                border-width: 1px !important;
            }

            .portfolio-label {
                font-family: 'Inter', sans-serif !important;
                font-size: 11px !important;
                font-weight: 600 !important;
                letter-spacing: 0.12em !important;
                text-transform: uppercase !important;
                opacity: 0.7 !important;
            }

            #portfolio-grand-total {
                font-family: 'Space Grotesk', sans-serif !important;
                font-size: 36px !important;
                font-weight: 700 !important;
                letter-spacing: -0.02em !important;
                margin-bottom: 18px !important;
                font-variant-numeric: tabular-nums !important;
            }

            .portfolio-breakdown {
                flex-direction: column !important;
                gap: 8px !important;
                align-items: stretch !important;
            }

            .breakdown-item {
                padding: 12px 16px !important;
                justify-content: space-between !important;
                flex-wrap: nowrap !important;
                gap: 10px !important;
                border-radius: 12px !important;
            }

            .breakdown-icon {
                font-size: 20px !important;
            }

            .breakdown-label {
                font-family: 'Inter', sans-serif !important;
                font-size: 12px !important;
                font-weight: 500 !important;
                letter-spacing: 0.01em !important;
            }

            .breakdown-value {
                font-family: 'Space Grotesk', sans-serif !important;
                font-size: 18px !important;
                font-weight: 700 !important;
                font-variant-numeric: tabular-nums !important;
            }

            /* Holdings — SIDE BY SIDE on mobile */
            .holdings-split {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }

            .holdings-column {
                border-radius: 12px !important;
                min-width: 0 !important;
            }

            .holdings-column-header {
                padding: 8px 6px !important;
                min-height: 40px !important;
            }

            .header-title {
                font-family: 'Space Grotesk', sans-serif !important;
                font-size: 12px !important;
                font-weight: 700 !important;
                flex-wrap: wrap !important;
                gap: 4px !important;
                letter-spacing: 0 !important;
            }

            .header-title .header-icon {
                font-size: 16px !important;
            }

            .header-stats {
                font-family: 'Inter', sans-serif !important;
                font-size: 10px !important;
                flex-direction: column !important;
                gap: 2px !important;
            }

            .column-total {
                font-family: 'Space Grotesk', sans-serif !important;
                font-size: 13px !important;
                font-variant-numeric: tabular-nums !important;
            }

            .holdings-list {
                max-height: 400px !important;
                overflow-y: auto !important;
                padding: 6px !important;
            }

            /* Make treasury holding items uniform size */
            .holdings-list > div,
            #base-holdings-list > div,
            #chia-holdings-list > div {
                min-height: 75px !important;
            }

            /* Treasury split — SIDE BY SIDE */
            .treasury-split {
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
            }

            /* NFT Collections */
            #nft-section-inline {
                margin-top: 24px !important;
            }

            #collections-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important;
                gap: 10px !important;
            }

            /* ── How To Cast Tab ── */
            #howto > div {
                padding: 14px !important;
            }

            #howto h1 {
                font-family: 'Space Grotesk', sans-serif !important;
                font-size: 26px !important;
                font-weight: 700 !important;
                letter-spacing: 0 !important;
            }

            #howto h2 {
                font-family: 'Space Grotesk', sans-serif !important;
                font-size: 18px !important;
                font-weight: 600 !important;
            }

            #howto h3 {
                font-family: 'Space Grotesk', sans-serif !important;
                font-size: 18px !important;
                font-weight: 700 !important;
            }

            #howto p, #howto div {
                font-family: 'Inter', sans-serif !important;
            }

            .howto-images-grid {
                grid-template-columns: 1fr !important;
            }

            #howto div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            /* ── Book of Wizard Tab ── */
            #book .quick-link-btn {
                font-family: 'Space Grotesk', sans-serif !important;
                font-size: 13px !important;
                font-weight: 600 !important;
                border-radius: 12px !important;
            }

            .spotify-mini {
                max-width: 100% !important;
                margin: 14px auto 6px !important;
                border-radius: 16px !important;
            }

            .spotify-mini-title {
                font-family: 'Inter', sans-serif !important;
                font-size: 10px !important;
                font-weight: 600 !important;
            }

            .spotify-mini-btn {
                font-family: 'Inter', sans-serif !important;
                border-radius: 8px !important;
            }

            .spotify-mini-controls button {
                font-family: 'Inter', sans-serif !important;
            }

            /* Twitter/X feed */
            #tw-widget {
                height: 400px !important;
            }

            /* ── Caster Valley Tab — optimized mobile iframe ── */
            #caster-valley-frame {
                min-height: 500px !important;
                height: 60vh !important;
                border-radius: 14px !important;
            }

            /* Wrapper around valley iframe */
            #valley > div > div {
                border-radius: 14px !important;
                overflow: hidden !important;
            }

            /* ── Footer — clean & minimal ── */
            .footer {
                padding: 16px 12px !important;
                margin-top: 24px !important;
                border-radius: 14px 14px 0 0 !important;
            }

            .footer p, .footer div {
                font-family: 'Inter', sans-serif !important;
            }

            /* ── Video Miniplayer — Right-edge slide-out drawer ── */
            #video-miniplayer {
                position: fixed !important;
                top: 0 !important;
                right: 0 !important;
                left: auto !important;
                bottom: 0 !important;
                width: 60vw !important;
                max-width: 240px !important;
                height: 100vh !important;
                height: 100dvh !important;
                border-radius: 20px 0 0 20px !important;
                border-right: none !important;
                transform: translateX(0) !important;
                transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1) !important;
                cursor: default !important;
                z-index: 999999 !important;
                flex-direction: column !important;
                overflow-y: auto !important;
                box-shadow: -8px 0 40px rgba(0,0,0,0.7), 0 0 30px rgba(251,191,36,0.15) !important;
            }

            #video-miniplayer.mobile-drawer-closed {
                transform: translateX(100%) !important;
                pointer-events: none !important;
            }

            /* Disable drag on mobile */
            #video-miniplayer-header {
                cursor: default !important;
            }

            /* Dark overlay when drawer is open — controlled by JS, not forced visible */
            /* #wtv-drawer-overlay visibility is managed by JS only */

            /* WTV mobile tab — skinnier button */
            #wtv-mobile-tab {
                width: 22px !important;
                height: 70px !important;
                top: 55% !important;
                padding: 5px 2px !important;
            }

            /* Bottom tab nav — larger, easier to see */
            .tabs {
                padding: 6px 0 !important;
            }

            .tab {
                padding: 10px 3px 12px !important;
                gap: 4px !important;
            }

            .tab-emoji {
                font-size: 18px !important;
            }

            .tab-label-short {
                font-size: 8px !important;
                font-weight: 700 !important;
            }

            /* ── Inline style overrides for font consistency ── */
            #xch-featured div,
            #wxch-featured div {
                font-family: 'Space Grotesk', 'Inter', sans-serif !important;
            }

            #xch-price, #wxch-price {
                font-family: 'Space Grotesk', sans-serif !important;
                font-size: 20px !important;
                font-weight: 700 !important;
                font-variant-numeric: tabular-nums !important;
            }

            #xch-change, #wxch-change {
                font-family: 'Inter', sans-serif !important;
                font-size: 11px !important;
                font-weight: 600 !important;
            }

            /* Sort info tooltip — fit mobile screen */
            #sort-info-tooltip {
                width: calc(100vw - 40px) !important;
                max-width: 320px !important;
                right: -10px !important;
                border-radius: 14px !important;
            }

            #sort-info-tooltip div {
                font-family: 'Inter', sans-serif !important;
            }
        }

        /* ── Extra Small Screens (≤ 480px) ── */

        @media (max-width: 480px) {

            .container {
                padding: 6px !important;
            }

            .header {
                padding: 12px 10px !important;
                border-radius: 14px !important;
            }

            .title {
                font-size: 20px !important;
                letter-spacing: 3px !important;
            }

            .tab {
                font-size: 7px !important;
                padding: 6px 2px 8px !important;
            }

            .tab-emoji {
                font-size: 14px !important;
            }

            .tab-label-short {
                font-size: 6px !important;
            }

            .quick-link-btn {
                font-size: 9px !important;
                padding: 7px 10px !important;
            }

            .token-symbol {
                font-size: 12px !important;
            }

            .token-info > div:first-child {
                width: 24px !important;
                height: 24px !important;
                min-width: 24px !important;
            }

            .token-price {
                font-size: 11px !important;
            }

            .token-name {
                font-size: 10px !important;
            }

            .token-change {
                font-size: 9px !important;
            }

            .column-header {
                font-size: 11px !important;
                padding: 6px 4px !important;
            }

            .token-card {
                padding: 8px 6px !important;
            }

            .token-info > div:first-child {
                width: 26px !important;
                height: 26px !important;
                min-width: 26px !important;
            }

            .header-title {
                font-size: 11px !important;
            }

            .holdings-column-header {
                padding: 8px 6px !important;
            }

            #portfolio-grand-total {
                font-size: 28px !important;
            }

            #portfolio h1 {
                font-size: 20px !important;
            }

            #howto h1 {
                font-size: 22px !important;
            }

            .breakdown-item .breakdown-label {
                font-size: 11px !important;
            }

            .breakdown-item .breakdown-value {
                font-size: 16px !important;
            }

            #tw-widget {
                height: 320px !important;
            }

            #caster-valley-frame {
                min-height: 350px !important;
                height: 50vh !important;
            }

            .footer p {
                font-size: 11px !important;
            }

            /* 480px - drawer more square for smaller screens */
            #video-miniplayer {
                width: 70vw !important;
                max-width: 220px !important;
            }
        }

        /* ── Desktop-only: Ensure viewport change doesn't break wide screens ── */
        @media (min-width: 769px) {
            .container {
                max-width: 1200px;
                margin: 0 auto;
            }
        }
    </style>
</head>

<body>
    <div class="bg-collage" id="bgCollage"></div>

    <div class="container">
        <div class="header">

            <div class="title" style="
                font-family: 'Cinzel Decorative', 'Cinzel', serif;
                font-size: 84px;
                font-weight: 900;
                letter-spacing: 28px;
                text-transform: uppercase;
                background: linear-gradient(180deg, #ffffff 0%, #fff5b0 15%, #ffd700 40%, #ffb800 65%, #e89900 85%, #d4a800 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                filter: drop-shadow(0 0 18px rgba(255,215,0,0.9)) drop-shadow(0 0 40px rgba(255,165,0,0.6)) drop-shadow(3px 4px 6px rgba(0,0,0,0.9));
                animation: titlePulse 5s ease-in-out infinite;
            ">CASTER101</div>
            <style>
                @keyframes titlePulse {
                    0%, 100% { 
                        filter: drop-shadow(0 0 18px rgba(255,215,0,0.9)) drop-shadow(0 0 40px rgba(255,165,0,0.6)) drop-shadow(3px 4px 6px rgba(0,0,0,0.9));
                    }
                    50% { 
                        filter: drop-shadow(0 0 30px rgba(255,215,0,1)) drop-shadow(0 0 60px rgba(255,165,0,0.8)) drop-shadow(3px 4px 6px rgba(0,0,0,0.9));
                    }
                }
                
                /* Mobile responsive for CASTER101 title */
                @media (max-width: 768px) {
                    .header > div[style*="Cinzel Decorative"] {
                        font-size: 28px !important;
                        letter-spacing: 6px !important;
                        padding: 10px 8px !important;
                        margin: 0 -8px !important;
                    }
                }
                
                @media (max-width: 480px) {
                    .header > div[style*="Cinzel Decorative"] {
                        font-size: 20px !important;
                        letter-spacing: 3px !important;
                        padding: 8px 4px !important;
                    }
                }
            </style>
            <div class="marquee">
                <div class="marquee-track">
                    <span class="marquee-span">✨ nothing is financial advice we are just wizards ✨ stack chias and chill ✨ 🏰 Welcome to the Realm of High Yield 🏰 ✨ Wizard is now casting ✨ CryptoPhish are now swimming ✨ 🌾 HARVEST++ 🌾 ✨ guild established in 2021 ✨ it's about to be crazy soon ✨ New Arc New Arc New Arc ✨ 🌙 Eternal Nightspire of Astral Realm Casters 🌙 ✨ lovecaster3000 is typing.... ✨ XCH mooning NOW ✨ Plant Your Seed ✨ We LOVE to cast spells ✨ 🧪 Advanced Yield Alchemy for Chia 🧪 ✨ aWizard is never late or early ✨ New Music Out NOW 🎵 ✨ brought to you by lovecaster3000 ✨ 🔍 The Transparency Revolution? 🔍 ✨ shoutout to the Tang Gang 🍊 ✨</span><span class="marquee-span">✨ nothing is financial advice we are just wizards ✨ stack chias and chill ✨ 🏰 Welcome to the Realm of High Yield 🏰 ✨ Wizard is now casting ✨ CryptoPhish are now swimming ✨ 🌾 HARVEST++ 🌾 ✨ guild established in 2021 ✨ it's about to be crazy soon ✨ New Arc New Arc New Arc ✨ 🌙 Eternal Nightspire of Astral Realm Casters 🌙 ✨ lovecaster3000 is typing.... ✨ XCH mooning NOW ✨ Plant Your Seed ✨ We LOVE to cast spells ✨ 🧪 Advanced Yield Alchemy for Chia 🧪 ✨ aWizard is never late or early ✨ New Music Out NOW 🎵 ✨ brought to you by lovecaster3000 ✨ 🔍 The Transparency Revolution? 🔍 ✨ shoutout to the Tang Gang 🍊 ✨</span><span class="marquee-span">✨ nothing is financial advice we are just wizards ✨ stack chias and chill ✨ 🏰 Welcome to the Realm of High Yield 🏰 ✨ Wizard is now casting ✨ CryptoPhish are now swimming ✨ 🌾 HARVEST++ 🌾 ✨ guild established in 2021 ✨ it's about to be crazy soon ✨ New Arc New Arc New Arc ✨ 🌙 Eternal Nightspire of Astral Realm Casters 🌙 ✨ lovecaster3000 is typing.... ✨ XCH mooning NOW ✨ Plant Your Seed ✨ We LOVE to cast spells ✨ 🧪 Advanced Yield Alchemy for Chia 🧪 ✨ aWizard is never late or early ✨ New Music Out NOW 🎵 ✨ brought to you by lovecaster3000 ✨ 🔍 The Transparency Revolution? 🔍 ✨ shoutout to the Tang Gang 🍊 ✨</span><span class="marquee-span">✨ nothing is financial advice we are just wizards ✨ stack chias and chill ✨ 🏰 Welcome to the Realm of High Yield 🏰 ✨ Wizard is now casting ✨ CryptoPhish are now swimming ✨ 🌾 HARVEST++ 🌾 ✨ guild established in 2021 ✨ it's about to be crazy soon ✨ New Arc New Arc New Arc ✨ 🌙 Eternal Nightspire of Astral Realm Casters 🌙 ✨ lovecaster3000 is typing.... ✨ XCH mooning NOW ✨ Plant Your Seed ✨ We LOVE to cast spells ✨ 🧪 Advanced Yield Alchemy for Chia 🧪 ✨ aWizard is never late or early ✨ New Music Out NOW 🎵 ✨ brought to you by lovecaster3000 ✨ 🔍 The Transparency Revolution? 🔍 ✨ shoutout to the Tang Gang 🍊 ✨</span>
                </div>
            </div>
            <div class="stats">
                <div class="stat-badge" style="border: none; color: #fbbf24;">👀 Visitors: <span
                        id="visitorCount">0</span></div>
                <div class="stat-badge" style="border: none; color: #dc2626;">🔥 Online: 42069</div>
                <a href="https://www.chia.net" target="_blank" class="stat-badge" style="
                    color: #fbbf24;
                    text-decoration: none;
                    border: 1px solid rgba(251,191,36,0.35);
                    background: rgba(251,191,36,0.08);
                    padding: 4px 10px;
                    border-radius: 8px;
                    font-size: 11px;
                    font-family: 'Cinzel', serif;
                    letter-spacing: 0.5px;
                    transition: background 0.2s, border-color 0.2s;
                " onmouseover="this.style.background='rgba(251,191,36,0.18)'" onmouseout="this.style.background='rgba(251,191,36,0.08)'">🌱 chia.net</a>
                <a href="https://vault.chia.net" target="_blank" class="stat-badge" style="
                    color: #fbbf24;
                    text-decoration: none;
                    border: 1px solid rgba(251,191,36,0.35);
                    background: rgba(251,191,36,0.08);
                    padding: 4px 10px;
                    border-radius: 8px;
                    font-size: 11px;
                    font-family: 'Cinzel', serif;
                    letter-spacing: 0.5px;
                    transition: background 0.2s, border-color 0.2s;
                " onmouseover="this.style.background='rgba(251,191,36,0.18)'" onmouseout="this.style.background='rgba(251,191,36,0.08)'">🏦 vault.chia.net</a>
            </div>
        </div>

    <script>
        // Global Treasury Cache Variables
        let _treasuryCache = {
            baseData: null,
            chiaData: null,
            nftData: null,
            timestamp: null
        };
        
    </script>
        <div class="tabs">
            <div class="tab" onclick="showTab('market')"><span class="tab-emoji">📈</span><span class="tab-label-full"> EMOJI MARKET </span><span class="tab-label-short">MARKET</span><span class="tab-emoji">📈</span></div>
            <div class="tab" onclick="showTab('portfolio')"><span class="tab-emoji">💰</span><span class="tab-label-full"> BAG </span><span class="tab-label-short">BAG</span><span class="tab-emoji">💰</span></div>
            <div class="tab" onclick="showTab('treasury')"><span class="tab-emoji">🧙</span><span class="tab-label-full"> aWIZARD TREASURY </span><span class="tab-label-short">VAULT</span><span class="tab-emoji">🧙</span></div>
            <div class="tab" onclick="showTab('howto')"><span class="tab-emoji">🎓</span><span class="tab-label-full"> HOW TO CAST </span><span class="tab-label-short">HOWTO</span><span class="tab-emoji">🎓</span></div>
            <div class="tab" onclick="showTab('book')"><span class="tab-emoji">📜</span><span class="tab-label-full"> BOOK OF WIZARD </span><span class="tab-label-short">BOOK</span><span class="tab-emoji">📜</span></div>
            <div class="tab" onclick="showTab('valley')"><span class="tab-emoji">🎮</span><span class="tab-label-full"> CASTER VALLEY </span><span class="tab-label-short">C.VALLEY</span><span class="tab-emoji">🎮</span></div>
        </div>

        <div id="market" class="content">
            <div class="quick-links">
                <a href="https://dexie.space" target="_blank" class="quick-link-btn" title="Trade here">🦢 dexie.space</a>
                <a href="https://mintgarden.io" target="_blank" class="quick-link-btn" title="Chia NFT marketplace and minting">🍃 mintgarden.io</a>
                <a href="https://dex.9mm.pro" target="_blank" class="quick-link-btn" title="The bread and butter (base warped tokens)">🔫 dex.9mm.pro</a>
                <a href="https://circuitdao.com" target="_blank" class="quick-link-btn" title="Stablecoin magic">💲 circuitdao.com</a>
                <a href="https://wojak.ink" target="_blank" class="quick-link-btn" title="Crazy">🎨 wojak.ink</a>
                <a href="https://crate.ink" target="_blank" class="quick-link-btn" title="Web3 minting experience on Chia">📦 crate.ink</a>
                <a href="https://warp.awizard.dev" target="_blank" class="quick-link-btn warp-btn" title="Warp your bag">
                    <span style="font-size: 14px;">⚡</span>
                    <div style="display: flex; flex-direction: column; line-height: 1;">
                        <span>warp.awizard.dev</span>
                    </div>

                </a>
                <a href="https://discord.gg/awizard" target="_blank" class="quick-link-btn" style="border: none; color: #5865F2; box-shadow: 0 0 12px rgba(88, 101, 242, 0.4);" title="Chat and verify your wallet">💬 discord.gg/awizard</a>
            </div>

            <div class="search-bar">
                <span class="search-icon">🔮</span>
                <input type="text" class="search-input" placeholder="search chia or base asset" id="searchInput"
                    oninput="handleSearch()">
            </div>

            <!-- Featured Tokens: XCH and wXCH -->
            <div class="featured-tokens-grid" style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 16px;
                margin-bottom: 24px;
            ">
                <!-- XCH Featured Box -->
                <div id="xch-featured" onclick="openTokenLink('Chia', 'Native', 'XCH')" style="
                    background: linear-gradient(135deg, rgba(0, 100, 80, 0.3) 0%, rgba(30, 140, 100, 0.25) 100%);
                    backdrop-filter: blur(12px);
                    -webkit-backdrop-filter: blur(12px);
                    border: 1px solid rgba(74, 222, 128, 0.3);
                    border-radius: 12px;
                    padding: 14px 18px;
                    cursor: pointer;
                    transition: all 0.3s;
                    box-shadow: 0 4px 16px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.borderColor='rgba(74,222,128,0.5)';" onmouseout="this.style.transform=''; this.style.borderColor='rgba(74,222,128,0.3)';">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="
                                width: 44px; height: 44px;
                                background: linear-gradient(135deg, #4ade80, #22c55e);
                                border-radius: 10px;
                                display: flex; align-items: center; justify-content: center;
                                font-size: 22px;
                                box-shadow: 0 4px 12px rgba(74,222,128,0.35);
                            ">🌱</div>
                            <div>
                                <div style="font-size: 18px; font-weight: 900; color: white; font-family: 'Cinzel', serif; letter-spacing: 1px;">XCH</div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.5); font-family: 'Cinzel', serif; text-transform: uppercase; letter-spacing: 0.5px;">Chia Network</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div id="xch-price" style="font-size: 22px; font-weight: 900; color: #4ade80; font-family: 'Cinzel', serif;">$0.00</div>
                            <div id="xch-change" style="font-size: 13px; font-weight: 700; margin-top: 2px;">--</div>
                        </div>
                    </div>
                </div>

                <!-- wXCH Featured Box -->
                <div id="wxch-featured" onclick="openTokenLink('Base', '0x36be1d329444aef5d28df3662ec5b4f965cd93e9', 'wXCH')" style="
                    background: linear-gradient(135deg, rgba(30, 80, 150, 0.3) 0%, rgba(50, 120, 180, 0.25) 100%);
                    backdrop-filter: blur(12px);
                    -webkit-backdrop-filter: blur(12px);
                    border: 1px solid rgba(0, 82, 255, 0.3);
                    border-radius: 12px;
                    padding: 14px 18px;
                    cursor: pointer;
                    transition: all 0.3s;
                    box-shadow: 0 4px 16px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.borderColor='rgba(0,82,255,0.5)';" onmouseout="this.style.transform=''; this.style.borderColor='rgba(0,82,255,0.3)';">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="
                                width: 44px; height: 44px;
                                background: linear-gradient(135deg, #0052ff, #0033cc);
                                border-radius: 10px;
                                display: flex; align-items: center; justify-content: center;
                                font-size: 22px;
                                box-shadow: 0 4px 12px rgba(0,82,255,0.4);
                            ">⛓️</div>
                            <div>
                                <div style="font-size: 18px; font-weight: 900; color: white; font-family: 'Cinzel', serif; letter-spacing: 1px;">wXCH</div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.5); font-family: 'Cinzel', serif; text-transform: uppercase; letter-spacing: 0.5px;">Wrapped XCH</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div id="wxch-price" style="font-size: 22px; font-weight: 900; color: #4f87ff; font-family: 'Cinzel', serif;">$0.00</div>
                            <div id="wxch-change" style="font-size: 13px; font-weight: 700; margin-top: 2px;">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filter-section" style="position: relative;">
                <button class="filter-btn active" onclick="sortTokens('name', this)">📝 Name</button>
                <button class="filter-btn" onclick="sortTokens('marketCap', this)">💰 Market Cap</button>
                <button class="filter-btn" onclick="sortTokens('arbitrage', this)">💱 Arbitrage</button>
                
                <!-- Info button -->
                <button onclick="toggleSortInfo()" style="
                    background: rgba(251, 191, 36, 0.15);
                    border: 1px solid rgba(251, 191, 36, 0.4);
                    color: #fbbf24;
                    border-radius: 50%;
                    width: 28px;
                    height: 28px;
                    font-size: 16px;
                    font-weight: 900;
                    cursor: pointer;
                    margin-left: 8px;
                    transition: all 0.2s;
                " onmouseover="this.style.background='rgba(251, 191, 36, 0.25)'; this.style.borderColor='rgba(251, 191, 36, 0.6)';" 
                   onmouseout="this.style.background='rgba(251, 191, 36, 0.15)'; this.style.borderColor='rgba(251, 191, 36, 0.4)';">?</button>

                <!-- Info tooltip -->
                <div id="sort-info-tooltip" style="
                    display: none;
                    position: absolute;
                    top: 45px;
                    right: 0;
                    background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(20, 20, 30, 0.95));
                    border: 2px solid rgba(251, 191, 36, 0.5);
                    border-radius: 12px;
                    padding: 16px;
                    width: 320px;
                    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6), 0 0 40px rgba(251, 191, 36, 0.2);
                    z-index: 1000;
                    backdrop-filter: blur(12px);
                ">
                    <div style="color: #fbbf24; font-weight: 900; font-size: 14px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">
                        📊 Display Info
                    </div>
                    <div style="color: rgba(255, 255, 255, 0.9); font-size: 13px; line-height: 1.6;">
                        <div style="margin-bottom: 10px;">
                            <span style="color: #0052ff; font-weight: 700;">🔵 Base Side:</span><br>
                            Shows 24-hour price change percentage
                        </div>
                        <div style="margin-bottom: 10px;">
                            <span style="color: #4ade80; font-weight: 700;">🌱 Chia Side:</span><br>
                            Shows arbitrage opportunity vs Base price
                        </div>
                        <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(251, 191, 36, 0.2);">
                            <span style="color: #4ade80;">🟢</span> = Chia is cheaper<br>
                            <span style="color: #ef4444;">🔴</span> = Chia is more expensive
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                function toggleSortInfo() {
                    const tooltip = document.getElementById('sort-info-tooltip');
                    tooltip.style.display = tooltip.style.display === 'none' ? 'block' : 'none';
                }
                
                // Close tooltip when clicking outside
                document.addEventListener('click', function(event) {
                    const tooltip = document.getElementById('sort-info-tooltip');
                    const infoBtn = event.target;
                    
                    if (!tooltip.contains(event.target) && infoBtn.textContent !== '?') {
                        tooltip.style.display = 'none';
                    }
                });
            </script>

            <div class="market-columns">
                <!-- Chia Chain Column (Left) -->
                <div class="market-column chia-column">
                    <div class="column-header chia">🌱 Chia</div>
                    <div id="chiaTokenList" class="token-grid"></div>
                </div>

                <!-- Base Chain Column (Right) -->
                <div class="market-column base-column">
                    <div class="column-header base">🔵 Base</div>
                    <div id="baseTokenList" class="token-grid"></div>
                </div>
            </div>

            <!-- Merkl Magic Box -->
            <div id="merkl-section" style="
                margin-top: 32px;
                background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(139, 92, 246, 0.05));
                border: none;
                border: none;
                padding: 24px;
                box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
            ">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div>
                        <h3 style="
                            font-family: 'Inter', 'Segoe UI', sans-serif;
                            font-size: 24px;
                            font-weight: 900;
                            color: #a855f7;
                            margin: 0 0 4px 0;
                            text-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
                        ">✨ Merkl Magic</h3>
                        <p style="font-size: 12px; color: rgba(255,255,255,0.6); margin: 0;">9mm.pro Liquidity Pools - Highest APR</p>
                    </div>
                    <a href="https://app.merkl.xyz/?search=ninemm&sort=apr-desc&test=true" target="_blank" style="
                        padding: 10px 20px;
                        background: linear-gradient(135deg, #a855f7, #8b5cf6);
                        color: white;
                        text-decoration: none;
                        border: none;
                        font-weight: 700;
                        font-size: 14px;
                        transition: all 0.2s;
                        box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
                    " onmouseover="this.style.transform='scale(1.05)';" onmouseout="this.style.transform='scale(1)';">
                        View All Pools →
                    </a>
                </div>
                <div id="merkl-pools" style="
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                    gap: 12px;
                ">
                    <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                        Loading Merkl pools...
                    </div>
                </div>
            </div>
        </div>

        <div id="portfolio" class="content">
            <div style="max-width: 1000px; margin: 0 auto; padding: 20px;">

                <!-- Header -->
                <div style="text-align: center; margin-bottom: 32px;">
                    <h1 style="font-family:'Cinzel Decorative','MedievalSharp',fantasy; font-size:36px; color:#ffd700; text-shadow:0 0 20px rgba(251,191,36,0.8); margin-bottom:8px;">💰 Track Ur Bag</h1>
                    <p style="color:rgba(255,255,255,0.5); font-size:14px;">Enter any Base wallet address to see full holdings + LP positions</p>
                </div>

                <!-- Address Input -->
                <div style="background:linear-gradient(135deg,rgba(20,20,30,0.9),rgba(10,10,20,0.95)); border:2px solid rgba(251,191,36,0.4); border-radius:16px; padding:24px; margin-bottom:28px; backdrop-filter:blur(10px);">
                    <div class="wallet-input-row" style="display:flex; gap:12px; align-items:center;">
                        <div style="flex:1; position:relative;">
                            <span style="position:absolute; left:14px; top:50%; transform:translateY(-50%); font-size:18px; pointer-events:none;">🔍</span>
                            <input type="text" id="walletAddress" placeholder="0x... Base wallet address"
                                style="width:100%; padding:14px 14px 14px 44px; background:rgba(0,0,0,0.4); border:2px solid rgba(251,191,36,0.3); border-radius:12px; color:white; font-size:14px; font-family:'Inter',sans-serif; box-sizing:border-box; transition:border-color 0.2s; outline:none;"
                                onfocus="this.style.borderColor='rgba(251,191,36,0.7)'" onblur="this.style.borderColor='rgba(251,191,36,0.3)'"
                                onkeydown="if(event.key==='Enter') trackAddress()">
                        </div>
                        <button onclick="trackAddress()" id="track-btn" style="padding:14px 28px; background:linear-gradient(135deg,#fbbf24,#f59e0b); border:none; border-radius:12px; color:#000; font-size:15px; font-weight:900; cursor:pointer; white-space:nowrap; transition:all 0.2s; font-family:'Inter',sans-serif; box-shadow:0 4px 16px rgba(251,191,36,0.4);"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(251,191,36,0.6)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(251,191,36,0.4)'">
                            ✨ SCAN BAG
                        </button>
                    </div>
                    <div id="trackedAddressDisplay" style="margin-top:10px;"></div>

                    <!-- Quick presets -->
                    <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap;">
                        <span style="font-size:11px; color:rgba(255,255,255,0.4); align-self:center;">Quick load:</span>
                        <button onclick="document.getElementById('walletAddress').value='0xEEDC069F861880eC1B5f41c9bC7a747DC1cE32b9'; trackAddress();"
                            style="padding:5px 12px; background:rgba(251,191,36,0.12); border:1px solid rgba(251,191,36,0.3); border-radius:8px; color:#fbbf24; font-size:11px; cursor:pointer; font-weight:700;">
                            🧙 0xEEDC...32b9
                        </button>
                    </div>
                </div>

                <!-- Summary Cards (hidden until loaded) -->
                <div id="bag-summary" style="display:none; margin-bottom:24px;">
                    <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:14px; margin-bottom:20px;">
                        <div style="background:linear-gradient(135deg,rgba(30,90,180,0.2),rgba(60,140,220,0.15)); border:2px solid rgba(30,100,180,0.3); border-radius:14px; padding:18px; text-align:center;">
                            <div style="font-size:11px; color:rgba(255,255,255,0.5); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">Total Value</div>
                            <div id="bag-total-value" style="font-size:28px; font-weight:900; color:#fbbf24; font-family:'Anton','Impact',sans-serif;">$0</div>
                        </div>
                        <div style="background:linear-gradient(135deg,rgba(0,82,255,0.15),rgba(0,82,255,0.08)); border:2px solid rgba(0,82,255,0.4); border-radius:14px; padding:18px; text-align:center;">
                            <div style="font-size:11px; color:rgba(255,255,255,0.5); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">Positions</div>
                            <div id="bag-position-count" style="font-size:28px; font-weight:900; color:#60a5fa; font-family:'Anton','Impact',sans-serif;">0</div>
                        </div>
                        <div style="background:linear-gradient(135deg,rgba(99,179,237,0.15),rgba(99,179,237,0.08)); border:2px solid rgba(99,179,237,0.4); border-radius:14px; padding:18px; text-align:center;">
                            <div style="font-size:11px; color:rgba(255,255,255,0.5); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">LP Positions</div>
                            <div id="bag-lp-count" style="font-size:28px; font-weight:900; color:#63b3ed; font-family:'Anton','Impact',sans-serif;">0</div>
                        </div>
                        <div style="background:linear-gradient(135deg,rgba(74,222,128,0.15),rgba(74,222,128,0.08)); border:2px solid rgba(74,222,128,0.4); border-radius:14px; padding:18px; text-align:center;">
                            <div style="font-size:11px; color:rgba(255,255,255,0.5); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">LP Value</div>
                            <div id="bag-lp-value" style="font-size:28px; font-weight:900; color:#4ade80; font-family:'Anton','Impact',sans-serif;">$0</div>
                        </div>
                    </div>

                    <!-- Allocation bar -->
                    <div style="background:rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.1); border-radius:10px; padding:14px; margin-bottom:20px;">
                        <div style="font-size:11px; color:rgba(255,255,255,0.5); margin-bottom:8px; text-transform:uppercase; letter-spacing:1px;">Portfolio Allocation</div>
                        <div id="bag-alloc-bar" style="display:flex; height:10px; border-radius:6px; overflow:hidden; gap:2px;"></div>
                        <div id="bag-alloc-legend" style="display:flex; gap:12px; flex-wrap:wrap; margin-top:8px;"></div>
                    </div>
                </div>

                <!-- Positions List -->
                <div id="portfolioList"></div>
            </div>
        </div>

        <div id="treasury" class="content">
            <div class="treasury-wrapper" style="padding: 20px; max-width: 1400px; margin: 0 auto;">
                

                <div class="treasury-main-header" style="
                    background: linear-gradient(135deg, rgba(70, 58, 25, 0.92) 0%, rgba(160, 132, 60, 0.9) 35%, rgba(50, 42, 20, 0.95) 100%);
                    border: 2px solid rgba(251, 191, 36, 0.6);
                    border-radius: 16px;
                    padding: 32px;
                    margin-bottom: 24px;
                    backdrop-filter: blur(12px);
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(251, 191, 36, 0.3), 0 0 40px rgba(251, 191, 36, 0.2);
                ">
                    <div class="portfolio-total-section" style="text-align: center;">
                        <div class="portfolio-label" style="
                            font-size: 14px;
                            color: rgba(255, 255, 255, 0.6);
                            text-transform: uppercase;
                            letter-spacing: 2px;
                            margin-bottom: 12px;
                        ">Total Portfolio Value</div>
                        <div id="portfolio-grand-total" class="portfolio-value" style="
                            font-size: 56px;
                            font-weight: 900;
                            color: #fbbf24;
                            font-family: 'Anton', 'Impact', sans-serif;
                            text-shadow: 0 0 40px rgba(251, 191, 36, 0.6);
                            margin-bottom: 24px;
                            letter-spacing: 2px;
                        ">$0.00</div>
                        <div class="portfolio-breakdown" style="display: flex; justify-content: center; gap: 48px;">
                            <div class="breakdown-item base-breakdown" style="
                                display: flex;
                                align-items: center;
                                gap: 12px;
                                padding: 12px 24px;
                                background: rgba(0, 0, 0, 0.3);
                                border-radius: 12px;
                                border: 1px solid rgba(0, 82, 255, 0.4);
                            ">
                                <span class="breakdown-icon" style="font-size: 24px;">🔵</span>
                                <span class="breakdown-label" style="font-size: 14px; color: rgba(255, 255, 255, 0.7);">Base Network</span>
                                <span id="base-network-total" class="breakdown-value" style="font-size: 20px; font-weight: 700; color: white;">$0.00</span>
                            </div>
                            <div class="breakdown-item chia-breakdown" style="
                                display: flex;
                                align-items: center;
                                gap: 12px;
                                padding: 12px 24px;
                                background: rgba(0, 0, 0, 0.3);
                                border-radius: 12px;
                                border: 1px solid rgba(74, 222, 128, 0.4);
                            ">
                                <span class="breakdown-icon" style="font-size: 24px;">🌱</span>
                                <span class="breakdown-label" style="font-size: 14px; color: rgba(255, 255, 255, 0.7);">Chia Network</span>
                                <span id="chia-network-total" class="breakdown-value" style="font-size: 20px; font-weight: 700; color: white;">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HOLDINGS VIEW -->
                <div id="holdings-view" class="treasury-view active">
                    <div class="holdings-split" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        
                        <!-- BASE HOLDINGS -->
                        <div class="holdings-column" style="
                            background: linear-gradient(135deg, rgba(20, 20, 30, 0.8), rgba(10, 10, 20, 0.9));
                            border-radius: 16px;
                            overflow: hidden;
                            backdrop-filter: blur(10px);
                            will-change: contents;
                            contain: layout style;
                        ">
                            <div class="holdings-column-header base-header" style="
                                padding: 20px;
                                border-bottom: 2px solid rgba(255, 255, 255, 0.1);
                                background: linear-gradient(135deg, rgba(0, 82, 255, 0.2), rgba(0, 82, 255, 0.1));
                                border: 2px solid rgba(0, 82, 255, 0.5);
                                border-bottom: 2px solid rgba(0, 82, 255, 0.3);
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(0, 82, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.05);
                            ">
                                <div class="header-title" style="display: flex; align-items: center; gap: 12px; font-size: 20px; font-weight: 900; color: white; margin-bottom: 12px;">
                                    <span class="header-icon" style="font-size: 24px;">🔵</span>
                                    <span>Base Network</span>
                                </div>
                                <div class="header-stats" style="display: flex; justify-content: space-between; font-size: 14px; color: rgba(255, 255, 255, 0.6);">
                                    <span id="base-token-count">0 tokens</span>
                                    <span id="base-column-total" class="column-total" style="font-weight: 700; color: #4ade80;">$0.00</span>
                                </div>
                            </div>
                            <div class="holdings-list" id="base-holdings-list" style="padding: 16px; max-height: 450px; overflow-y: auto; will-change: scroll-position; transform: translateZ(0); contain: layout style paint;">
                                <div style="text-align: center; padding: 60px 20px; color: rgba(255, 255, 255, 0.5);">
                                    Loading Base holdings...
                                </div>
                            </div>
                        </div>

                        <!-- CHIA HOLDINGS -->
                        <div class="holdings-column" style="
                            background: linear-gradient(135deg, rgba(20, 20, 30, 0.8), rgba(10, 10, 20, 0.9));
                            border-radius: 16px;
                            overflow: hidden;
                            backdrop-filter: blur(10px);
                            will-change: contents;
                            contain: layout style;
                        ">
                            <div class="holdings-column-header chia-header" style="
                                padding: 20px;
                                border-bottom: 2px solid rgba(255, 255, 255, 0.1);
                                background: linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(74, 222, 128, 0.1));
                                border: 2px solid rgba(74, 222, 128, 0.5);
                                border-bottom: 2px solid rgba(74, 222, 128, 0.3);
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(74, 222, 128, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.05);
                            ">
                                <div class="header-title" style="display: flex; align-items: center; gap: 12px; font-size: 20px; font-weight: 900; color: white; margin-bottom: 12px;">
                                    <span class="header-icon" style="font-size: 24px;">🌱</span>
                                    <span>Chia Network</span>
                                    <button id="refresh-chia-treasury" style="
                                        background: rgba(74, 222, 128, 0.2);
                                        border: 1px solid rgba(74, 222, 128, 0.4);
                                        border-radius: 6px;
                                        color: #4ade80;
                                        padding: 4px 10px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        font-weight: 600;
                                        margin-left: auto;
                                        transition: all 0.2s;
                                    " onmouseover="this.style.background='rgba(74,222,128,0.3)'" onmouseout="this.style.background='rgba(74,222,128,0.2)'" title="Refresh Chia treasury data from Spacescan">
                                        🔄 Refresh
                                    </button>
                                </div>
                                <div class="header-stats" style="display: flex; justify-content: space-between; font-size: 14px; color: rgba(255, 255, 255, 0.6);">
                                    <span id="chia-token-count">0 tokens</span>
                                    <span id="chia-column-total" class="column-total" style="font-weight: 700; color: #4ade80;">$0.00</span>
                                </div>
                                <div id="chia-last-updated" style="font-size: 11px; color: rgba(255, 255, 255, 0.4); margin-top: 6px; text-align: center;"></div>
                            </div>
                            <div class="holdings-list" id="chia-holdings-list" style="padding: 16px; max-height: 450px; overflow-y: auto; will-change: scroll-position; transform: translateZ(0); contain: layout style paint;">
                                <div style="text-align: center; padding: 60px 20px; color: rgba(255, 255, 255, 0.5);">
                                    <div style="font-size: 24px; margin-bottom: 8px;">⏳</div>
                                    <div>Loading Chia holdings...</div>
                                    <div id="chia-cache-status" style="font-size: 11px; margin-top: 8px; opacity: 0.5;"></div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- INLINE NFT COLLECTIONS -->
                    <div id="nft-section-inline" style="margin-top: 32px;">
                        <div style="
                            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.08));
                            border: 2px solid rgba(168, 85, 247, 0.4);
                            border-radius: 16px;
                            padding: 20px 24px;
                            margin-bottom: 20px;
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            flex-wrap: wrap;
                            gap: 16px;
                        ">
                            <div style="font-size: 20px; font-weight: 900; color: white; display: flex; align-items: center; gap: 10px;">
                                <span>🖼️</span>
                                <span>NFT Collections</span>
                            </div>
                            <div style="display: flex; gap: 32px; flex-wrap: wrap;">
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Total NFTs</div>
                                    <div id="total-nft-count" style="font-size: 22px; font-weight: 900; color: #a855f7;">0</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Collections</div>
                                    <div id="total-collections" style="font-size: 22px; font-weight: 900; color: #a855f7;">0</div>
                                </div>

                            </div>
                        </div>
                        <div class="collections-grid" id="collections-grid" style="
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                            gap: 14px;
                        ">
                            <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; color: rgba(255, 255, 255, 0.4);">
                                Loading NFT collections...
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        
        <!-- How to Wizard Section -->
        <div id="howto" class="content">
            <div style="
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            ">
                <!-- Header -->
                <div style="
                    text-align: center;
                    margin-bottom: 40px;
                ">
                    <h1 style="
                        font-family: 'Cinzel Decorative', 'MedievalSharp', fantasy;
                        font-size: 48px;
                        color: #ffd700;
                        text-shadow: 0 0 20px rgba(251, 191, 36, 0.8);
                        margin-bottom: 16px;
                    ">🧙 Awizard Ecosystem</h1>
                    <h2 style="
                        font-size: 24px;
                        color: #fbbf24;
                        margin-bottom: 8px;
                    ">Start Your Journey</h2>
                    <p style="
                        color: rgba(255, 255, 255, 0.7);
                        font-size: 16px;
                    ">The Awizard ecosystem rewards long-term participation across Chia assets, NFTs, and liquidity.<br>
                    Grow your Spell Power by stacking, exploring, and contributing.</p>
                </div>

                <!-- Discord server button -->
                <div style="text-align:center; margin-bottom: 28px;">
                    <a href="https://discord.gg/awizard" target="_blank" rel="noopener" 
                       style="display:inline-flex;align-items:center;gap:8px;background:rgba(88,101,242,0.18);border:1px solid rgba(88,101,242,0.5);border-radius:20px;padding:8px 20px;color:#7289da;font-size:13px;font-weight:600;text-decoration:none;font-family:'Inter',sans-serif;transition:all 0.2s;"
                       onmouseover="this.style.background='rgba(88,101,242,0.32)';this.style.borderColor='rgba(88,101,242,0.9)';"
                       onmouseout="this.style.background='rgba(88,101,242,0.18)';this.style.borderColor='rgba(88,101,242,0.5)';">
                        <svg width="16" height="12" viewBox="0 0 24 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M20.317 1.492a19.84 19.84 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.617-1.25.077.077 0 00-.079-.037A19.736 19.736 0 003.677 1.492a.07.07 0 00-.032.027C.533 6.093-.32 10.557.099 14.964a.08.08 0 00.031.055 19.9 19.9 0 005.993 3.03.078.078 0 00.084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 00-.041-.106 13.107 13.107 0 01-1.872-.892.077.077 0 01-.008-.128 10.2 10.2 0 00.372-.292.074.074 0 01.077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 01.078.01c.12.098.246.198.373.292a.077.077 0 01-.006.127 12.299 12.299 0 01-1.873.892.077.077 0 00-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 00.084.028 19.839 19.839 0 006.002-3.03.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03z" fill="#7289da"/>
                        </svg>
                        Join the Discord Server
                    </a>
                </div>

                <!-- YouTube Video Embed -->
                <div style="
                    margin: 0 auto 40px auto;
                    max-width: 660px;
                    background: rgba(0, 0, 0, 0.5);
                    border: 2px solid rgba(251, 191, 36, 0.4);
                    border-radius: 16px;
                    padding: 14px;
                    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
                ">
                    <div style="
                        position: relative;
                        padding-bottom: 56.25%;
                        height: 0;
                        overflow: hidden;
                        border-radius: 8px;
                    ">
                        <iframe 
                            style="
                                position: absolute;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                border: none;
                            "
                            src="https://www.youtube.com/embed/V7CTinIJrNc?quality=hd" 
                            title="Awizard Tutorial" 
                            frameborder="0"
                            loading="lazy"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen>
                        </iframe>
                    </div>
                </div>

                <!-- Community Note -->
                <div style="
                    margin-bottom: 28px;
                    padding: 16px 22px;
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.08);
                    border-radius: 10px;
                    font-family: 'Inter', sans-serif;
                    font-size: 13px;
                    line-height: 1.7;
                    color: rgba(255,255,255,0.42);
                    font-style: italic;
                    text-align: center;
                    max-width: 780px;
                    margin-left: auto;
                    margin-right: auto;
                    margin-bottom: 32px;
                ">
                    The wizard community is a mix of builders, artists, collectors, and enthusiasts within the Chia ecosystem, united more by curiosity and creativity than by any single role. Before purchasing NFTs or tokens, it is advisable to understand how the Chia network operates, how Chia Asset Tokens function, and how the coinset model works as this foundation provides essential context and reduces unnecessary risk.
                </div>

                <!-- Ecosystem Guide -->
                <div style="
                    background: linear-gradient(135deg, rgba(30, 30, 40, 0.8), rgba(15, 15, 25, 0.9));
                    border: 2px solid rgba(251, 191, 36, 0.4);
                    border-radius: 16px;
                    padding: 32px;
                    margin-bottom: 40px;
                    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
                ">
                    <h3 style="
                        color: #ffd700;
                        font-size: 28px;
                        font-weight: 900;
                        margin-bottom: 24px;
                        text-align: center;
                    ">Getting Started</h3>
                    
                    <div style="
                        display: grid;
                        grid-template-columns: 1fr;
                        gap: 20px;
                        color: rgba(255, 255, 255, 0.9);
                        font-size: 16px;
                        line-height: 1.6;
                    ">
                        <div style="
                            background: rgba(0, 0, 0, 0.3);
                            border-left: 4px solid #4ade80;
                            padding: 16px;
                            border-radius: 8px;
                        ">
                            <div style="color: #fbbf24; font-weight: 900; margin-bottom: 8px;">1️⃣ Stack Chia</div>
                            <div>Accumulate XCH according to your means. This is the foundation of your participation.</div>
                        </div>
                        
                        <div style="
                            background: rgba(0, 0, 0, 0.3);
                            border-left: 4px solid #a855f7;
                            padding: 16px;
                            border-radius: 8px;
                        ">
                            <div style="color: #fbbf24; font-weight: 900; margin-bottom: 8px;">2️⃣ Collect NFTs</div>
                            <div>aWizard NFTs unlock ecosystem utility, access, and reward eligibility. These include Wizard Magic, The Casting, and more. Check in server to see what other NFTs provide spell power rankings.</div>
                        </div>
                        
                        <div style="
                            background: rgba(0, 0, 0, 0.3);
                            border-left: 4px solid #0052ff;
                            padding: 16px;
                            border-radius: 8px;
                        ">
                            <div style="color: #fbbf24; font-weight: 900; margin-bottom: 8px;">3️⃣ Engage with Chia Asset Tokens (CATs)</div>
                            <div>Build positions in ecosystem tokens and provide liquidity on Chia to earn yield while supporting markets.</div>
                        </div>
                        
                        <div style="
                            background: rgba(0, 0, 0, 0.3);
                            border-left: 4px solid #fbbf24;
                            padding: 16px;
                            border-radius: 8px;
                        ">
                            <div style="color: #fbbf24; font-weight: 900; margin-bottom: 8px;">4️⃣ Expand via Warp Bridge (Base)</div>
                            <div>Bridge assets and provide CAT-to-CAT liquidity on Base through 9mmpro for additional opportunities.</div>
                        </div>
                        
                        <div style="
                            background: rgba(0, 0, 0, 0.3);
                            border-left: 4px solid #ef4444;
                            padding: 16px;
                            border-radius: 8px;
                        ">
                            <div style="color: #fbbf24; font-weight: 900; margin-bottom: 8px;">5️⃣ Optimize Yield</div>
                            <div>Learn liquidity strategies and Merkl incentives to maximize rewards over time.</div>
                        </div>
                    </div>
                </div>

                <!-- Rewards & Progression -->
                <div style="
                    background: linear-gradient(135deg, rgba(30, 30, 40, 0.8), rgba(15, 15, 25, 0.9));
                    border: 2px solid rgba(168, 85, 247, 0.4);
                    border-radius: 16px;
                    padding: 32px;
                    margin-bottom: 40px;
                    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
                ">
                    <h3 style="
                        color: #a855f7;
                        font-size: 28px;
                        font-weight: 900;
                        margin-bottom: 24px;
                        text-align: center;
                    ">🔮 Rewards & Progression</h3>
                    
                    <div style="
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 20px;
                        margin-bottom: 24px;
                    ">
                        <div style="
                            background: rgba(0, 0, 0, 0.3);
                            border: 1px solid rgba(74, 222, 128, 0.3);
                            padding: 20px;
                            border-radius: 8px;
                        ">
                            <div style="color: #4ade80; font-weight: 900; font-size: 18px; margin-bottom: 8px;">Soft Staking</div>
                            <div style="color: rgba(255, 255, 255, 0.8);">Hold ecosystem assets to earn passive rewards.</div>
                        </div>
                        
                        <div style="
                            background: rgba(0, 0, 0, 0.3);
                            border: 1px solid rgba(251, 191, 36, 0.3);
                            padding: 20px;
                            border-radius: 8px;
                        ">
                            <div style="color: #fbbf24; font-weight: 900; font-size: 18px; margin-bottom: 8px;">Spell Power Leaderboard</div>
                            <div style="color: rgba(255, 255, 255, 0.8);">Your CAT and NFT holdings determine your rank. Wizards receive weekly Spell Power Tokens based on standing (separate from soft staking).</div>
                        </div>
                    </div>
                    
                    <div style="
                        background: rgba(0, 0, 0, 0.3);
                        border: 1px solid rgba(88, 101, 242, 0.3);
                        padding: 20px;
                        border-radius: 8px;
                    ">
                        <div style="color: #5865F2; font-weight: 900; font-size: 18px; margin-bottom: 8px;">🏰 Discord Integration</div>
                        <div style="color: rgba(255, 255, 255, 0.8);">Verify your wallet using the official guide, then use commands like those shown below. Your on-chain activity becomes recognized and rewarded inside the server.</div>
                    </div>
                </div>

                <!-- Images: Discord Commands + Soft Staking side by side -->
                <div style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 20px;
                    margin-bottom: 40px;
                    align-items: start;" class="howto-images-grid
                ">
                    <div style="text-align: center;">
                        <img src="images/discord-commands.png" alt="Discord Commands" style="
                            max-width: 100%;
                            width: 100%;
                            height: auto;
                            border: 2px solid rgba(251, 191, 36, 0.4);
                            border-radius: 12px;
                            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
                        ">
                        <div style="margin-top: 8px; font-size: 12px; color: rgba(255,255,255,0.5);">Discord Commands</div>
                    </div>
                    <div style="text-align: center;">
                        <img src="images/soft-staking-diagram.png" alt="Soft Staking Diagram" style="
                            max-width: 100%;
                            width: 100%;
                            height: auto;
                            border: 2px solid rgba(74, 222, 128, 0.4);
                            border-radius: 12px;
                            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
                        ">
                        <div style="margin-top: 8px; font-size: 12px; color: rgba(255,255,255,0.5);">Soft Staking Diagram</div>
                    </div>
                </div>


                <!-- Discord server button -->
                <div style="text-align:center; margin: 32px 0 16px 0;">
                    <a href="https://discord.gg/awizard" target="_blank" rel="noopener" 
                       style="display:inline-flex;align-items:center;gap:8px;background:rgba(88,101,242,0.18);border:1px solid rgba(88,101,242,0.5);border-radius:20px;padding:8px 20px;color:#7289da;font-size:13px;font-weight:600;text-decoration:none;font-family:'Inter',sans-serif;transition:all 0.2s;"
                       onmouseover="this.style.background='rgba(88,101,242,0.32)';this.style.borderColor='rgba(88,101,242,0.9)';"
                       onmouseout="this.style.background='rgba(88,101,242,0.18)';this.style.borderColor='rgba(88,101,242,0.5)';">
                        <svg width="16" height="12" viewBox="0 0 24 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M20.317 1.492a19.84 19.84 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.617-1.25.077.077 0 00-.079-.037A19.736 19.736 0 003.677 1.492a.07.07 0 00-.032.027C.533 6.093-.32 10.557.099 14.964a.08.08 0 00.031.055 19.9 19.9 0 005.993 3.03.078.078 0 00.084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 00-.041-.106 13.107 13.107 0 01-1.872-.892.077.077 0 01-.008-.128 10.2 10.2 0 00.372-.292.074.074 0 01.077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 01.078.01c.12.098.246.198.373.292a.077.077 0 01-.006.127 12.299 12.299 0 01-1.873.892.077.077 0 00-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 00.084.028 19.839 19.839 0 006.002-3.03.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03z" fill="#7289da"/>
                        </svg>
                        Join the Discord Server
                    </a>
                </div>

            </div>
        </div>
        
        <div id="book" class="content">
            <div style="
                min-height: 400px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
                border: none;
                border: none;
                background: rgba(0,0,0,0.6);
                padding: 40px;
            ">
                <div
                    style="margin-bottom: 30px; display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 340px;">
                    <!-- Purple Wizard Links Together at Top -->
                    <a href="https://love.awizard.dev/" target="_blank" class="quick-link-btn"
                        style="justify-content: center; padding: 10px 16px; border: 2px solid rgba(217, 70, 239, 0.8); color: #d946ef;">
                        ❤️ aWizard
                    </a>
                    <a href="https://warp.awizard.dev" target="_blank" class="quick-link-btn warp-btn"
                        style="justify-content: center; padding: 10px 16px; border: 2px solid rgba(217, 70, 239, 0.8); color: #d946ef;">
                        ⚡ warp.awizard.dev
                    </a>
                    <a href="https://discord.gg/awizard" target="_blank" class="quick-link-btn"
                        style="justify-content: center; padding: 10px 16px; border: 2px solid rgba(88, 101, 242, 0.8); color: #5865F2;">
                        💬 discord.gg/awizard
                    </a>
                    
                    <!-- Other Links -->
                    <a href="https://mintgarden.io/aWizard" target="_blank" class="quick-link-btn"
                        style="justify-content: center; padding: 10px 16px; border: 2px solid rgba(251, 191, 36, 0.7);">
                        🍃 aWizard mintgarden
                    </a>
                    <a href="https://mintgarden.io/profile/astercast-15a3f45ca34abd78b76241dd346ed1acc696dad22768735a7b929a54679d5922?tab=collections"
                        target="_blank" class="quick-link-btn" style="justify-content: center; padding: 10px 16px; border: 2px solid rgba(251, 191, 36, 0.7);">
                        🍃 astercast mintgarden
                    </a>
                    <a href="https://open.spotify.com/artist/4pYearnilXYOKzJk4qFTxE" target="_blank" class="quick-link-btn"
                        style="justify-content: center; padding: 10px 16px; border: 2px solid rgba(29, 185, 84, 0.8); color: #1db954;">
                        🎵 Spotify
                    </a>
                    <a href="https://x.com/aWizardxch" target="_blank" class="quick-link-btn"
                        style="justify-content: center; padding: 10px 16px; background: rgba(0,0,0,0.8); border: 2px solid rgba(255, 255, 255, 0.7); color: #fff;">
                        ✖ FOLLOW US
                    </a>
                </div>

                <!-- Spotify Mini Player -->
                <div id="spotify-miniplayer" class="spotify-mini">
                    <div class="spotify-mini-header">
                        <div class="spotify-mini-title">Now Playing: <span id="spotify-mini-album">Album Shuffle</span></div>
                        <div class="spotify-mini-actions">
                            <a id="spotify-mini-open" class="spotify-mini-btn" href="https://open.spotify.com/" target="_blank" rel="noopener">Open Spotify</a>
                            <button id="spotify-mini-close" class="spotify-mini-close" title="Close">×</button>
                        </div>
                    </div>
                    <div class="spotify-mini-controls">
                        <button id="spotify-mini-prev" type="button" title="Previous">⏮</button>
                        <button id="spotify-mini-play" type="button" title="Play/Pause">▶</button>
                        <button id="spotify-mini-next" type="button" title="Next">⏭</button>
                        <button id="spotify-mini-shuffle" type="button" title="Shuffle Albums">Shuffle Albums</button>
                    </div>
                    <div id="spotify-embed" class="spotify-mini-embed"></div>
                </div>

                <!-- Latest Tweets from @aWizardxch -->
                <div style="width:100%;max-width:680px;margin-top:16px;">

                    <!-- Section header -->
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;justify-content:center;">
                        <div style="height:1px;flex:1;background:linear-gradient(to right,transparent,rgba(29,161,242,0.35));max-width:120px;"></div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="#1da1f2"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.746l7.73-8.835L1.254 2.25H8.08l4.253 5.622 5.911-5.622zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                            <span style="font-size:12px;color:rgba(29,161,242,0.85);text-transform:uppercase;letter-spacing:2px;font-weight:700;">Latest from @aWizardxch</span>
                        </div>
                        <div style="height:1px;flex:1;background:linear-gradient(to left,transparent,rgba(29,161,242,0.35));max-width:120px;"></div>
                    </div>

                    <!-- Outer glow wrapper -->
                    <div style="position:relative;">
                        <div style="position:absolute;inset:-2px;border-radius:20px;background:linear-gradient(135deg,rgba(29,161,242,0.28),rgba(120,80,255,0.18),rgba(29,161,242,0.12));pointer-events:none;z-index:0;"></div>

                        <!-- Card -->
                        <div id="tw-card" style="position:relative;z-index:1;background:linear-gradient(180deg,rgba(6,12,22,0.96),rgba(5,8,14,0.92));border-radius:18px;overflow:hidden;border:1px solid rgba(29,161,242,0.25);backdrop-filter:blur(12px);">

                            <!-- Profile header strip -->
                            <div style="background:linear-gradient(135deg,rgba(29,161,242,0.16),rgba(120,80,255,0.12));padding:14px 16px;border-bottom:1px solid rgba(29,161,242,0.18);display:flex;align-items:center;gap:12px;">
                                <div style="width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,rgba(29,161,242,0.25),rgba(120,80,255,0.25));display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 0 14px rgba(29,161,242,0.35);border:1px solid rgba(255,255,255,0.12);">
                                    <img src="images/hodl-diamond.png" alt="Hodl Diamond" style="width:34px;height:34px;object-fit:contain;filter:drop-shadow(0 0 8px rgba(29,161,242,0.6));">
                                </div>
                                <div style="text-align:left;">
                                    <div style="font-size:14px;font-weight:800;color:white;letter-spacing:0.3px;">aWizard</div>
                                    <div style="font-size:12px;color:rgba(29,161,242,0.75);margin-top:2px;">@aWizardxch</div>
                                </div>
                                <a href="https://x.com/aWizardxch" target="_blank"
                                   style="margin-left:auto;display:flex;align-items:center;gap:6px;background:rgba(0,0,0,0.55);border:1px solid rgba(255,255,255,0.18);border-radius:20px;padding:7px 14px;color:white;font-size:12px;font-weight:700;text-decoration:none;transition:all 0.2s;"
                                   onmouseover="this.style.background='rgba(29,161,242,0.25)';this.style.borderColor='rgba(29,161,242,0.6)'"
                                   onmouseout="this.style.background='rgba(0,0,0,0.55)';this.style.borderColor='rgba(255,255,255,0.18)'">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="white"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.746l7.73-8.835L1.254 2.25H8.08l4.253 5.622 5.911-5.622z"/></svg>
                                    Follow on X
                                </a>
                            </div>

                            <!-- Nitter Feed: Lightweight, no SDK dependency -->
                            <div style="padding:10px;">
                                <iframe 
                                    id="tw-widget"
                                    src="https://nitter.net/aWizardxch" 
                                    width="100%" 
                                    height="560" 
                                    frameborder="0"
                                    style="border-radius:12px;border:1px solid rgba(29,161,242,0.15);background:rgba(5,10,20,0.8);">
                                </iframe>
                            </div>

                        </div>
                    </div>

                    <!-- Footer link -->
                    <div style="text-align:center;margin-top:12px;">
                        <a href="https://x.com/aWizardxch" target="_blank"
                           style="font-size:11px;color:rgba(29,161,242,0.55);text-decoration:none;letter-spacing:0.5px;transition:color 0.2s;"
                           onmouseover="this.style.color='#1da1f2'" onmouseout="this.style.color='rgba(29,161,242,0.55)'">
                            Follow @aWizardxch on X &#x2192;
                        </a>
                    </div>

                </div>



            </div>
        </div>

        <div id="valley" class="content">
            <div style="
                width: 100%;
                max-width: 1400px;
                margin: 0 auto;
                padding: 16px;
            ">
                <div style="
                    border: 2px solid rgba(251, 191, 36, 0.4);
                    border-radius: 16px;
                    overflow: hidden;
                    background: rgba(0, 0, 0, 0.6);
                    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.45);
                ">
                    <iframe
                        id="caster-valley-frame"
                        title="Caster Valley 3D"
                        src="about:blank"
                        data-src="/caster-valley-3d.html"
                        style="
                            width: 100%;
                            height: 80vh;
                            min-height: 720px;
                            border: none;
                            display: block;
                            background: #000;
                        "
                        allow="fullscreen; autoplay; clipboard-read; clipboard-write"
                        allowfullscreen
                    ></iframe>
                
                </div>
            </div>
        </div>


        <div class="footer">
            <p style="font-weight: bold; font-size: 14px; color: #fbbf24; margin-bottom: 8px;">★彡 aWizard is multi chain
                彡★</p>
            <p style="font-size: 12px; color: #dc2626; font-weight: bold;">Data from spacescan.io & 9mm.pro DEX</p>
            <div style="margin-top: 12px; font-size: 10px; color: rgba(251, 191, 36, 0.6);">© 2025 CASTER101</div>
        </div>
    </div>

    <script>
        // Treasury Loading - simplified to load cache instantly, refresh in background
        function showTreasuryLoadingModal() {
            // REMOVED - no modal
        }
        
        function hideTreasuryLoadingModal() {
            // REMOVED - no modal
        }
        
        // Tab order for swipe navigation
        const tabOrder = ['market', 'portfolio', 'treasury', 'howto', 'book', 'valley'];
        
        // Tab switching function
        function showTab(tabName, direction = null) {
            const isMobile = window.innerWidth <= 768;
            const currentActive = document.querySelector(".content.active");
            const newContent = document.getElementById(tabName);
            
            // Remove animation classes from all content
            document.querySelectorAll(".content").forEach(content => {
                content.classList.remove("flip-in-left", "flip-in-right", "flip-out-left", "flip-out-right");
            });
            
            // Mobile flip animation
            if (isMobile && currentActive && direction && currentActive !== newContent) {
                // Animate out current content
                if (direction === 'left') {
                    currentActive.classList.add('flip-out-right');
                } else if (direction === 'right') {
                    currentActive.classList.add('flip-out-left');
                }
                
                // Wait for out animation, then switch
                setTimeout(() => {
                    document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
                    document.querySelectorAll(".content").forEach(content => content.classList.remove("active"));
                    
                    // Find and activate the correct tab button
                    const tabButtons = document.querySelectorAll(".tab");
                    tabButtons.forEach(tab => {
                        if (tab.getAttribute('onclick')?.includes(tabName)) {
                            tab.classList.add("active");
                        }
                    });
                    
                    // Show new content with flip-in animation
                    newContent.classList.add("active");
                    if (direction === 'left') {
                        newContent.classList.add('flip-in-left');
                    } else if (direction === 'right') {
                        newContent.classList.add('flip-in-right');
                    }
                }, 300);
            } else {
                // No animation - instant switch
                document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
                document.querySelectorAll(".content").forEach(content => content.classList.remove("active"));
                if (event && event.target) event.target.classList.add("active");
                newContent.classList.add("active");
            }
            
            // Update URL hash so refresh restores the same page
            window.location.hash = tabName;
            if (tabName === "treasury") {
                // Try to restore from cache first - show it IMMEDIATELY
                if (_treasuryCache.baseData && _treasuryCache.chiaData && _treasuryCache.nftData) {
                    console.log('💾 Restoring treasury from cache (' + new Date(_treasuryCache.timestamp).toLocaleTimeString() + ')');
                    updateTreasuryDisplay(_treasuryCache.baseData, _treasuryCache.chiaData, _treasuryCache.nftData);
                    window._chiaNFTData = _treasuryCache.nftData;
                    window._chiaXchPrice = _treasuryCache.chiaData?.xchPrice || 4;
                    updateNFTGallery(_treasuryCache.nftData);
                }
                // Load fresh treasury in background - check if function exists
                if (typeof loadComprehensiveTreasury !== 'undefined') {
                    setTimeout(loadComprehensiveTreasury, 100);
                } else {
                    console.warn('⚠️ loadComprehensiveTreasury not yet defined');
                }
            }
            if (tabName === "valley") {
                const frame = document.getElementById('caster-valley-frame');
                if (frame && !frame.dataset.loaded) {
                    frame.src = frame.dataset.src;
                    frame.dataset.loaded = 'true';
                }
            }
        }

        // Hash routing is handled in window.onload below (after all DOM + scripts are ready)
        
        // Configuration for tokens to track - filtered
        const trackedTokens = [
            // Chia Network
            { id: 'xch', symbol: 'XCH', name: 'Chia', chain: 'Chia', assetId: 'Native' },
            { id: 'caster-chia', symbol: '✨❤️‍🔥🧙‍♂️', name: 'Caster', chain: 'Chia', assetId: 'a09af8b0d12b27772c64f89cf0d1db95186dca5b1871babc5108ff44f36305e6' },
            { id: 'spellpower-chia', symbol: '⚡️🪄', name: 'Spellpower', chain: 'Chia', assetId: 'eb2155a177b6060535dd8e72e98ddb0c77aea21fab53737de1c1ced3cb38e4c4' },
            { id: 'byc-chia', symbol: '💸', name: 'Bytecash', displayName: '$BYC', chain: 'Chia', assetId: 'ae1536f56760e471ad85ead45f00d680ff9cca73b8cc3407be778f1c0c606eac' },
            { id: 'love-chia', symbol: '❤️', name: 'Love', chain: 'Chia', assetId: '70010d83542594dd44314efbae75d82b3d9ae7d946921ed981a6cd08f0549e50' },
            { id: 'sprout-chia', symbol: '🌱', name: 'Sprout', chain: 'Chia', assetId: 'ab558b1b841365a24d1ff2264c55982e55664a8b6e45bc107446b7e667bb463b' },
            { id: 'pizza-chia', symbol: '🍕', name: 'Pizza', chain: 'Chia', assetId: 'dd37f678dda586fad9b1daeae1f7c5c137ffa6d947e1ed5c7b4f3c430da80638' },
            
            // Base Network
            { id: 'wxch-base', symbol: 'wXCH', name: 'Wrapped XCH', chain: 'Base', contract: '0x36be1d329444aef5d28df3662ec5b4f965cd93e9' },
            { id: 'caster-base', symbol: '✨❤️‍🔥🧙‍♂️', name: 'Caster', chain: 'Base', contract: '0x09Aa909Eea859f712f2Ae3dd1872671D2363f6f4' },
            { id: 'spellpower-base', symbol: '⚡️🪄', name: 'Spellpower', chain: 'Base', contract: '0x145F14b876051DC443dd18D5f8a7C48c5db75847' },
            { id: 'wiz-base', symbol: '🧙💸', name: 'Wizard Bucks', chain: 'Base', contract: '0x39916e508e389FBB4dDC3d1a38a5801f4eE253c7' },
            { id: 'love-base', symbol: '❤️', name: 'Love', chain: 'Base', contract: '0x817cAb331aaA4c24b4e32024FCa093AD40CBa208' },
            { id: 'sprout-base', symbol: '🌱', name: 'Sprout', chain: 'Base', contract: '0xd1b771CB462a4B0e4d56Bb68b4bF832994CC8820' },
            { id: 'pizza-base', symbol: '🍕', name: 'Pizza', chain: 'Base', contract: '0x84070f2c685b3d4B63c66f0B13fB83Fa6ccb4035' }
        ];

        let tokens = []; // Will be populated with live data
        let displayedTokens = [];
        let currentSort = 'marketCap';

        // ══════════════════════════════════════════════════════════════════════════
        // GLOBAL SPACESCAN RATE LIMIT COORDINATOR
        // ══════════════════════════════════════════════════════════════════════════
        // Spacescan allows ~10 req/10sec from single IP. This queue ensures emoji market
        // and treasury don't conflict by spacing ALL Spacescan calls site-wide.
        const spacescanQueue = {
            queue: [],
            processing: false,
            lastCall: 0,
            MIN_GAP: 2000, // 2s between calls — treasury only, Spacescan rate limits aggressively

            async enqueue(url, timeout = 12000, retries = 1) {
                return new Promise((resolve) => {
                    this.queue.push({ url, timeout, resolve, retries });
                    if (!this.processing) this.processQueue();
                });
            },

            async processQueue() {
                if (this.processing || this.queue.length === 0) return;
                this.processing = true;

                while (this.queue.length > 0) {
                    const now = Date.now();
                    const wait = Math.max(0, this.lastCall + this.MIN_GAP - now);
                    if (wait > 0) await new Promise(r => setTimeout(r, Math.min(wait, 200)));

                    const { url, timeout, resolve, retries } = this.queue.shift();
                    this.lastCall = Date.now();

                    try {
                        const ctrl = new AbortController();
                        const timer = setTimeout(() => ctrl.abort(), timeout);
                        const resp = await fetch(url, { 
                            headers: { Accept: 'application/json' }, 
                            signal: ctrl.signal,
                            cache: 'no-store'
                        });
                        clearTimeout(timer);
                        const data = resp.ok ? await resp.json() : null;
                        
                        // Retry once if failed and retries > 0
                        if (!data && retries > 0) {
                            console.log(`[spacescanQueue] Retrying ${url.slice(-40)}...`);
                            this.queue.push({ url, timeout, resolve, retries: retries - 1 });
                        } else {
                            resolve(data);
                        }
                    } catch(e) {
                        console.warn(`[spacescanQueue] ${url.slice(-40)}: ${e.message}`);
                        // Retry once on error if retries > 0
                        if (retries > 0) {
                            console.log(`[spacescanQueue] Retrying after error...`);
                            this.queue.push({ url, timeout, resolve, retries: retries - 1 });
                        } else {
                            resolve(null);
                        }
                    }
                }

                this.processing = false;
            },

            reset() {
                this.queue = [];
                this.processing = false;
                console.log('[spacescanQueue] Reset');
            }
        };

        // Wrapper for Spacescan API calls - use this everywhere for coordination
        const spacescanFetch = (url, timeout = 12000, retries = 1) => spacescanQueue.enqueue(url, timeout, retries);


        async function fetchChiaData(baseData = []) {
            console.log('--- CHIA PRICES: /api/chia-cat-prices + TibetSwap (no direct Spacescan) ---');

            const chiaTargets = trackedTokens.filter(t => t.chain === 'Chia');
            const catTargets  = chiaTargets.filter(t => t.assetId !== 'Native');
            const results     = [];

            // All three in parallel — none are Spacescan direct, no rate limits
            // Add cache-busting to ensure fresh prices
            const [xchData, tibetRaw, catPriceData] = await Promise.all([
                fetch(`https://api.coingecko.com/api/v3/simple/price?ids=chia&vs_currencies=usd&include_24hr_change=true&include_market_cap=true&t=${Date.now()}`)
                    .then(r => r.ok ? r.json() : {}).catch(() => ({})),
                fetch('https://api.v2.tibetswap.io/pairs?per_page=200')
                    .then(r => r.ok ? r.json() : []).catch(() => []),
                fetch(`/api/chia-cat-prices?t=${Date.now()}`)
                    .then(r => r.ok ? r.json() : {}).catch(() => ({})),
            ]);

            let xchPriceUSD = xchData.chia?.usd || 0;
            let xchMarketCap = xchData.chia?.usd_market_cap || 0;
            // Fallback: if CoinGecko fails, try TibetSwap XCH/USD price
            if (xchPriceUSD === 0 && tibetRaw?.length > 0) {
                const xchUsdPair = tibetRaw.find(p => p.short_name?.toLowerCase().includes('xch-usd'));
                if (xchUsdPair) {
                    xchPriceUSD = parseFloat(xchUsdPair.xch_reserve || 0) / parseFloat(xchUsdPair.asset_reserve || 1);
                }
            }
            if (xchPriceUSD === 0) xchPriceUSD = 2.80;
            const xchChange   = xchData.chia?.usd_24h_change || 0;
            console.log(`XCH: $${xchPriceUSD.toFixed(4)} MCap: $${(xchMarketCap/1e6).toFixed(1)}M`);

            const xchTarget = chiaTargets.find(t => t.assetId === 'Native');
            if (xchTarget) results.push({...xchTarget, price: xchPriceUSD, change24h: xchChange, marketCap: xchMarketCap});

            // TibetSwap map for fallback prices and pair names
            const tibetArr = Array.isArray(tibetRaw) ? tibetRaw : (tibetRaw.results || tibetRaw.pairs || []);
            const tibetMap = {};
            for (const pair of tibetArr) {
                const aid = (pair.asset_id || '').toLowerCase();
                if (!aid) continue;
                const xchRes = parseFloat(pair.xch_reserve  || 0) / 1e12;
                const catRes = parseFloat(pair.asset_reserve || 0) / 1e3;
                tibetMap[aid] = {
                    tvl:        2 * xchRes * xchPriceUSD,
                    priceUsd:   catRes > 0 ? (xchRes / catRes) * xchPriceUSD : 0,
                    short_name: pair.short_name || '',
                    name:       pair.name || ''
                };
            }
            console.log(`TibetSwap: ${Object.keys(tibetMap).length} pools`);

            // Batch prices from serverless function (Spacescan→Dexie fallback on server)
            const batchPrices  = catPriceData.prices  || {};
            const batchChanges = catPriceData.changes || {};
            const batchMcaps   = catPriceData.mcaps   || {};
            const batchSources = catPriceData.sources || {};

            // Pre-fetch circulating supplies for all CATs that need it (parallel with rate limiting)
            const circulatingSupplyMap = {};
            const tokensNeedingSupply = catTargets.filter(t => {
                const aid = t.assetId.toLowerCase();
                const hasBatchMcap = batchMcaps[t.assetId] > 0;
                const hasTibetTvl = tibetMap[aid]?.tvl > 0;
                return !hasBatchMcap; // Fetch supply if we don't have batch mcap
            });

            console.log(`Fetching circulating supply for ${tokensNeedingSupply.length} CATs...`);
            const supplyPromises = tokensNeedingSupply.map(async (t) => {
                try {
                    const d = await spacescanFetch(`https://api.spacescan.io/cat/info/${t.assetId}`, 8000, 1);
                    if (d?.data) {
                        const circ = parseFloat(d.data.circulating_supply || 0);
                        const price = parseFloat(d.data.amount_price || 0);
                        const change = parseFloat(d.data.pricepercentage || 0);
                        return { assetId: t.assetId, circ, price, change };
                    }
                } catch(e) {
                    console.warn(`⚠️ Supply fetch failed for ${t.assetId.slice(0, 8)}...`);
                }
                return { assetId: t.assetId, circ: 0, price: 0, change: 0 };
            });

            const supplyResults = await Promise.all(supplyPromises);
            supplyResults.forEach(r => {
                if (r.circ > 0 || r.price > 0) {
                    circulatingSupplyMap[r.assetId] = r;
                }
            });

            for (const t of catTargets) {
                let price = 0, change = 0, mcap = 0, src = 'none';
                const aid = t.assetId.toLowerCase();
                const supplyData = circulatingSupplyMap[t.assetId];

                // Try serverless batch first (Spacescan or Dexie on server)
                if (batchPrices[t.assetId] > 0) {
                    price  = batchPrices[t.assetId];
                    change = batchChanges[t.assetId] || 0;
                    mcap   = batchMcaps[t.assetId] || 0;
                    src    = batchSources[t.assetId] || 'batch';
                }

                // TibetSwap fallback for price
                const tibet = tibetMap[aid] || {};
                if (price === 0 && tibet.priceUsd > 0) { 
                    price = tibet.priceUsd; 
                    src = 'tibet'; 
                }

                // Use Spacescan price/change if we have it and better than current
                if (supplyData) {
                    if (price === 0 && supplyData.price > 0) {
                        price = supplyData.price;
                        src = 'spacescan';
                    }
                    if (change === 0 && supplyData.change !== 0) {
                        change = supplyData.change;
                    }
                }

                // Calculate mcap: prefer batch, then circulating supply * price, then TibetSwap TVL
                if (mcap === 0 && supplyData?.circ > 0 && price > 0) {
                    mcap = supplyData.circ * price;
                    src = src + '+supply';
                }
                if (mcap === 0 && tibet.tvl > 0) {
                    mcap = tibet.tvl;
                    src = src + '+tvl';
                }

                if (price > 0) console.log(`  ✅ ${t.displayName||t.name}: $${price.toFixed(8)} mcap:$${(mcap/1e6).toFixed(2)}M [${src}]`);
                else           console.warn(`  ⚠️  ${t.displayName||t.name}: no price`);

                results.push({...t, price, change24h: change, marketCap: mcap});
            }

            console.log(`Chia: ${results.filter(r => r.price > 0).length}/${results.length} priced, ${results.filter(r => r.marketCap > 0).length} with mcap`);
            return results;
        }

        async function fetchBaseData() {
            console.log('--- BASE PRICES: DexScreener per-token, GeckoTerminal inline fallback ---');

            const baseTargets     = trackedTokens.filter(t => t.chain === 'Base');
            const withContract    = baseTargets.filter(t => t.contract);
            const withoutContract = baseTargets.filter(t => !t.contract)
                .map(t => ({...t, price: 0, change24h: 0, marketCap: 0}));

            const results = [];

            for (let i = 0; i < withContract.length; i++) {
                if (i > 0) await new Promise(res => setTimeout(res, 100));
                const t = withContract[i];
                let price = 0, change24h = 0, marketCap = 0;

                // ── 1. Try DexScreener ──────────────────────────────────────────
                try {
                    const r = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${t.contract.toLowerCase()}`);
                    if (r.ok) {
                        const d = await r.json();
                        const pairs = d.pairs;  // may be null for low-liquidity tokens
                        if (pairs && Array.isArray(pairs)) {
                            // Filter for WETH/USDC quote tokens (avoid meme-to-meme pairs), then sort by volume
                            const validPairs = pairs.filter(p => {
                                if (p.chainId !== 'base') return false;
                                const quote = (p.quoteToken?.symbol || '').toUpperCase();
                                return quote === 'WETH' || quote === 'USDC' || quote === 'ETH' || quote === 'USDT';
                            });
                            const best = validPairs.sort((a, b) => 
                                (parseFloat(b.volume?.h24 || 0)) - (parseFloat(a.volume?.h24 || 0))
                            )[0];
                            if (best) {
                                price     = parseFloat(best.priceUsd     || 0);
                                change24h = parseFloat(best.priceChange?.h24 || 0);
                                marketCap = parseFloat(best.fdv || best.marketCap || 0);
                            }
                        }
                        // pairs === null means DexScreener has no index for this token
                        // → fall through to GeckoTerminal below
                    } else { console.warn(`  DexScreener HTTP ${r.status} for ${t.name}`); }
                } catch (e) { console.warn(`  DexScreener error for ${t.name}:`, e.message); }

                // ── 2. GeckoTerminal inline fallback ──
                if (price === 0) {
                    try {
                        console.log(`  🔄 DexScreener had no pairs for ${t.name} — trying GeckoTerminal...`);
                        const gtR = await fetch(
                            `https://api.geckoterminal.com/api/v2/networks/base/tokens/${t.contract.toLowerCase()}`
                        );
                        if (gtR.ok) {
                            const gtD = await gtR.json();
                            const attr = gtD?.data?.attributes || {};
                            const gtP = parseFloat(attr.price_usd || 0);
                            if (gtP > 0) {
                                price     = gtP;
                                marketCap = parseFloat(attr.fdv_usd || attr.market_cap_usd || 0);
                                console.log(`  ✅ ${t.name} via GeckoTerminal: $${price.toFixed(10)}`);
                            } else { console.warn(`  ⚠️  ${t.name}: GeckoTerminal also returned $0`); }
                        } else { console.warn(`  GeckoTerminal HTTP ${gtR.status} for ${t.name}`); }
                    } catch (gte) { console.warn(`  GeckoTerminal error for ${t.name}:`, gte.message); }
                }

                if (price > 0) console.log(`  ✅ ${t.name}: $${price.toFixed(10)} mcap:$${marketCap.toFixed(0)}`);
                else           console.warn(`  ⚠️  ${t.name}: no price from DexScreener or GeckoTerminal`);

                results.push({...t, price, change24h, marketCap});
            }

            return [...results, ...withoutContract];
        }


        async function updateData() {
            const loadingHtml = '<div class="loading" style="padding: 20px;">⚡ Fetching Live Data...</div>';
            if (tokens.length === 0) {
                const baseList = document.getElementById('baseTokenList');
                const chiaList = document.getElementById('chiaTokenList');
                if (baseList) baseList.innerHTML = loadingHtml;
                if (chiaList) chiaList.innerHTML = loadingHtml;
            }

            console.log('🔄 Starting data fetch (Base + Chia in parallel)...');
            
            // Fetch Base and Chia in PARALLEL — Base hits DexScreener/GeckoTerminal,
            // Chia hits Spacescan directly (sequential calls with 300ms gaps, no Lambda needed)
            const [baseData, chiaData] = await Promise.all([
                fetchBaseData(),
                fetchChiaData([]),
            ]);
            
            console.log('\n📊 FETCH COMPLETE');
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log(`Base tokens: ${baseData.length}`);
            baseData.forEach(t => {
                if (t.price > 0) {
                    console.log(`  ✅ ${t.symbol}: $${t.price.toFixed(6)}`);
                } else {
                    console.log(`  ⚠️ ${t.symbol}: $0.00`);
                }
            });
            console.log(`\nChia tokens: ${chiaData.length}`);
            chiaData.forEach(t => {
                if (t.price > 0) {
                    console.log(`  ✅ ${t.symbol}: $${t.price.toFixed(6)}`);
                } else {
                    console.log(`  ⚠️ ${t.symbol}: $0.00`);
                }
            });
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n');

            tokens = [...baseData, ...chiaData];
            console.log(`✅ Total tokens combined: ${tokens.length}`);
            console.log(`   Base: ${tokens.filter(t => t.chain === 'Base').length}`);
            console.log(`   Chia: ${tokens.filter(t => t.chain === 'Chia').length}\n`);
            
            refreshData();
            
            // Fetch Merkl pools after initial data load
            fetchMerklPools();
        }

        // Merkl Magic - Fetch 9mm.pro pools
        async function fetchMerklPools() {
            const container = document.getElementById('merkl-pools');
            if (!container) return;
            
            try {
                console.log('✨ Fetching REAL Merkl pools from API...');
                
                // Call our Merkl proxy
                const response = await fetch('/api/merkl-proxy');
                
                if (!response.ok) {
                    throw new Error(`Merkl proxy returned ${response.status}`);
                }
                
                const data = await response.json();
                const pools = data.pools || [];
                
                console.log(`✅ Received ${pools.length} pools from Merkl API`);
                
                if (pools.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No 9mm pools found</div>';
                    return;
                }

                container.innerHTML = pools.map(pool => {
                    const poolName = pool.name || pool.pair || 'Unknown Pool';
                    const apr = pool.apr || 0;
                    const tvl = parseFloat(pool.tvl) || 0;
                    const chain = pool.chainName || pool.chainId || 'Base';
                    
                    return `
                    <a href="https://app.merkl.xyz/?search=ninemm&sort=apr-desc&test=true" target="_blank" style="
                        display: block;
                        text-decoration: none;
                        background: linear-gradient(135deg, rgba(0,0,0,0.88), rgba(0,0,0,0.8));
                        border: none;
                        border: none;
                        padding: 16px;
                        transition: all 0.2s;
                        cursor: pointer;
                    " onmouseover="this.style.border='1px solid rgba(168, 85, 247, 0.6)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.border='1px solid rgba(168, 85, 247, 0.3)'; this.style.transform='translateY(0)';">
                        <div style="
                            font-size: 16px;
                            font-weight: 900;
                            color: white;
                            margin-bottom: 8px;
                            font-family: 'Inter', 'Segoe UI', sans-serif;
                        ">${poolName}</div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-size: 12px; color: rgba(255,255,255,0.6);">APR</span>
                            <span style="font-size: 16px; font-weight: 900; color: #4ade80;">${apr.toFixed(1)}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-size: 12px; color: rgba(255,255,255,0.6);">TVL</span>
                            <span style="font-size: 14px; color: rgba(255,255,255,0.9);">$${tvl > 1000 ? (tvl / 1000).toFixed(0) + 'K' : tvl.toFixed(0)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 12px; color: rgba(255,255,255,0.6);">Chain</span>
                            <span style="font-size: 14px; color: #a855f7;">${chain}</span>
                        </div>
                    </a>
                `}).join('');
                
                console.log('✨ Merkl pools rendered with REAL DATA');
            } catch (e) {
                console.error('❌ Merkl pools error:', e);
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">Unable to load pools. Check console for details.</div>';
            }
        }

        // Treasury view state

        // Render Token Cards (Visual)
        function renderTreasuryTokenCards(baseTokens, chiaTokens) {
            const container = document.getElementById('treasury-token-cards');
            const allTokens = [
                ...baseTokens.map(t => ({ ...t, chain: 'Base' })),
                ...chiaTokens.map(t => ({ ...t, chain: 'Chia' }))
            ].sort((a, b) => (b.value || 0) - (a.value || 0));

            // Update stats
            const lpCount = allTokens.filter(t => t.type === 'lp').length;
            const defiCount = allTokens.filter(t => t.type && t.type.startsWith('defi')).length;
            
            document.getElementById('stat-total-tokens').textContent = allTokens.length;
            document.getElementById('stat-lp-positions').textContent = lpCount;
            document.getElementById('stat-defi-positions').textContent = defiCount;

            if (allTokens.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 60px; color: rgba(255,255,255,0.3); grid-column: 1 / -1;">No tokens found</div>';
                return;
            }

            container.innerHTML = allTokens.map(token => {
                const chainColor = token.chain === 'Base' ? '#0052ff' : '#4ade80';
                const chainGradient = token.chain === 'Base' ? 
                    'linear-gradient(135deg, rgba(0, 82, 255, 0.2), rgba(0, 82, 255, 0.05))' :
                    'linear-gradient(135deg, rgba(74, 222, 128, 0.2), rgba(74, 222, 128, 0.05))';
                
                // Type badge
                let typeBadge = '';
                let typeColor = chainColor;
                if (token.type === 'lp') {
                    typeBadge = '🔄 LP';
                    typeColor = '#a855f7';
                } else if (token.type === 'defi-deposit') {
                    typeBadge = '💎 DeFi';
                    typeColor = '#10b981';
                } else if (token.type === 'defi-staked') {
                    typeBadge = '🔒 Staked';
                    typeColor = '#f59e0b';
                } else if (token.type === 'native') {
                    typeBadge = '⭐ Native';
                    typeColor = '#fbbf24';
                }

                // Protocol badge
                let protocolInfo = '';
                if (token.positionInfo) {
                    protocolInfo = `
                        <div style="
                            font-size: 10px;
                            color: rgba(255,255,255,0.6);
                            margin-top: 4px;
                            padding: 3px 8px;
                            background: rgba(0,0,0,0.4);
                            border: none;
                            display: inline-block;
                        ">🔮 ${token.positionInfo.protocol}</div>
                    `;
                } else if (token.lpInfo) {
                    protocolInfo = `
                        <div style="
                            font-size: 10px;
                            color: rgba(255,255,255,0.6);
                            margin-top: 4px;
                            padding: 3px 8px;
                            background: rgba(0,0,0,0.4);
                            border: none;
                            display: inline-block;
                        ">🏔️ ${token.lpInfo.dex}</div>
                    `;
                }

                return `
                    <div style="
                        background: ${chainGradient};
                        border: none;
                        border: none;
                        padding: 20px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 20px ${chainColor}22;
                        transition: transform 0.2s, box-shadow 0.2s;
                        cursor: pointer;
                    " onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.4), 0 0 30px ${chainColor}44';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3), 0 0 20px ${chainColor}22';">
                        <!-- Chain Badge -->
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                        ">
                            <span style="
                                font-size: 10px;
                                color: ${chainColor};
                                text-transform: uppercase;
                                letter-spacing: 2px;
                                font-weight: 700;
                                font-family: 'Inter', 'Segoe UI', sans-serif;
                            ">${token.chain === 'Base' ? '⛓️ BASE' : '🌱 CHIA'}</span>
                            ${typeBadge ? `<span style="
                                font-size: 10px;
                                color: ${typeColor};
                                padding: 4px 8px;
                                background: rgba(0,0,0,0.4);
                                border: none;
                                border: none;
                                font-weight: 700;
                            ">${typeBadge}</span>` : ''}
                        </div>

                        <!-- Token Symbol (Large) -->
                        <div style="
                            text-align: center;
                            margin: 20px 0;
                        ">
                            <div style="
                                width: 60px;
                                height: 60px;
                                margin: 0 auto 12px;
                                background: linear-gradient(135deg, ${chainColor}, ${typeColor});
                                border: none;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 24px;
                                font-weight: 900;
                                color: white;
                                text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
                                font-family: 'Valve Occult', 'Cinzel', fantasy;
                                box-shadow: 0 0 20px ${chainColor}66;
                            ">${token.symbol.substring(0, 3)}</div>
                            <div style="
                                font-family: 'Inter', 'Segoe UI', sans-serif;
                                font-size: 18px;
                                font-weight: 700;
                                color: white;
                                margin-bottom: 4px;
                            ">${token.symbol}</div>
                            <div style="
                                font-size: 11px;
                                color: rgba(255,255,255,0.5);
                            ">${token.name}</div>
                        </div>

                        <!-- Value & Balance -->
                        <div style="
                            background: rgba(0,0,0,0.4);
                            border: none;
                            padding: 12px;
                            margin-top: 12px;
                        ">
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                margin-bottom: 8px;
                            ">
                                <span style="
                                    font-size: 11px;
                                    color: rgba(255,255,255,0.5);
                                    text-transform: uppercase;
                                    letter-spacing: 1px;
                                ">Value</span>
                                <span style="
                                    font-family: 'Valve Occult', 'Cinzel', fantasy;
                                    font-size: 16px;
                                    font-weight: 900;
                                    color: #4ade80;
                                ">$${(token.value || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                            </div>
                            <div style="
                                display: flex;
                                justify-content: space-between;
                            ">
                                <span style="
                                    font-size: 11px;
                                    color: rgba(255,255,255,0.5);
                                    text-transform: uppercase;
                                    letter-spacing: 1px;
                                ">Balance</span>
                                <span style="
                                    font-size: 12px;
                                    color: rgba(255,255,255,0.8);
                                ">${(token.balance || 0).toLocaleString('en-US', { maximumFractionDigits: 4 })}</span>
                            </div>
                            ${token.price > 0 ? `
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                margin-top: 8px;
                                padding-top: 8px;
                                border-top: 1px solid rgba(255,255,255,0.1);
                            ">
                                <span style="
                                    font-size: 11px;
                                    color: rgba(255,255,255,0.5);
                                    text-transform: uppercase;
                                    letter-spacing: 1px;
                                ">Price</span>
                                <span style="
                                    font-size: 12px;
                                    color: rgba(255,255,255,0.8);
                                ">$${token.price < 0.01 ? token.price.toFixed(8) : token.price.toFixed(6)}</span>
                            </div>
                            ` : ''}
                            ${token.marketCap > 0 ? `
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                margin-top: 8px;
                            ">
                                <span style="
                                    font-size: 11px;
                                    color: rgba(255,255,255,0.5);
                                    text-transform: uppercase;
                                    letter-spacing: 1px;
                                ">Market Cap</span>
                                <span style="
                                    font-size: 12px;
                                    color: ${token.marketCap > 1000000 ? '#fbbf24' : '#4ade80'};
                                    font-weight: 700;
                                ">$${token.marketCap >= 1000000 ? (token.marketCap/1000000).toFixed(1) + 'M' : token.marketCap >= 1000 ? (token.marketCap/1000).toFixed(1) + 'K' : token.marketCap.toFixed(0)}</span>
                            </div>
                            ` : ''}
                        </div>

                        ${protocolInfo}
                    </div>
                `;
            }).join('');
        }

        // Draw Pie Chart
        function drawTreasuryPieChart(data) {
            const canvas = document.getElementById('treasury-pie-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 20;

            const total = data.base.total + data.chia.total;
            if (total === 0) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Calculate segments
            const segments = [];
            
            // Base tokens by type
            const baseByType = {};
            data.base.tokens.forEach(t => {
                const type = t.type || 'token';
                baseByType[type] = (baseByType[type] || 0) + (t.value || 0);
            });

            // Chia tokens
            const chiaTotal = data.chia.total;

            // Create segments with colors
            const colors = {
                'token': '#0052ff',
                'lp': '#a855f7',
                'native': '#fbbf24',
                'defi-deposit': '#10b981',
                'defi-staked': '#f59e0b',
                'defi-borrow': '#ef4444',
                'chia': '#4ade80'
            };

            let currentAngle = -Math.PI / 2; // Start at top

            // Base segments
            Object.keys(baseByType).forEach(type => {
                const value = baseByType[type];
                const angle = (value / total) * 2 * Math.PI;
                segments.push({
                    label: `Base ${type}`,
                    value: value,
                    color: colors[type] || '#666',
                    startAngle: currentAngle,
                    endAngle: currentAngle + angle
                });
                currentAngle += angle;
            });

            // Chia segment
            if (chiaTotal > 0) {
                const angle = (chiaTotal / total) * 2 * Math.PI;
                segments.push({
                    label: 'Chia',
                    value: chiaTotal,
                    color: colors.chia,
                    startAngle: currentAngle,
                    endAngle: currentAngle + angle
                });
            }

            // Draw segments
            segments.forEach(segment => {
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, segment.startAngle, segment.endAngle);
                ctx.lineTo(centerX, centerY);
                ctx.fillStyle = segment.color;
                ctx.fill();

                // Add glow
                ctx.shadowBlur = 15;
                ctx.shadowColor = segment.color;
                ctx.fill();
                ctx.shadowBlur = 0;

                // Border
                ctx.strokeStyle = 'rgba(0,0,0,0.5)';
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            // Draw center circle (donut hole)
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 0.5, 0, 2 * Math.PI);
            ctx.fillStyle = 'rgba(0,0,0,0.8)';
            ctx.fill();

            // Total in center
            ctx.fillStyle = '#fbbf24';
            ctx.font = 'bold 24px "Cinzel", serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`$${(total / 1000).toFixed(1)}K`, centerX, centerY);
        }

        // Load NFTs from wallets — browser-direct Spacescan (CORS: *)
        let nftsLoaded = false;
        let nftsLoading = false;  // prevents duplicate in-flight requests
        async function loadNFTs() {
            if (nftsLoaded)  return;
            if (nftsLoading) return;
            const gallery = document.getElementById('collections-grid');
            if (!gallery) return;

            // Reuse data already fetched by the treasury
            if (window._chiaNFTData && window._chiaNFTData.collections && window._chiaNFTData.collections.length > 0) {
                console.log('✅ NFT data already loaded from treasury, rendering...');
                updateNFTGallery(window._chiaNFTData);
                nftsLoaded = true;
                return;
            }

            nftsLoading = true;
            gallery.innerHTML = '<div style="text-align:center;padding:60px;color:rgba(255,255,255,0.5);grid-column:1/-1;">🔄 Loading NFT collections (browser-direct)...</div>';

            const NFT_WALLETS = [
                'xch10na8nqys9afs0fl74vvd6xl3akgu77p8mvjsp2ywy7rhq2s0jqys3nf7dl',
                'xch1g477lha2wjjq9634kgqmryf4gplft9cjgv2vd29tq3ya26glwlkqp6pyex',
                'xch1el40ydk4v2ccdq2l8d28wvr8hnndar0xywfgqel36f85ps8gj9jqfrm64j',
            ];

            try {
                // Use Lambda proxy (CORS blocked in browser)
                const nftResponses = await Promise.all(
                    NFT_WALLETS.map(async (addr) => {
                        try {
                            const ctrl = new AbortController();
                            setTimeout(() => ctrl.abort(), 10000);
                            const resp = await fetch('/api/chia-address-proxy', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ endpoint: 'nft-balance', address: addr }),
                                signal: ctrl.signal
                            });
                            return resp.ok ? await resp.json() : null;
                        } catch (e) {
                            console.warn(`Failed to load NFTs for ${addr.slice(-20)}:`, e.message);
                            return null;
                        }
                    })
                );

                const xchPrice = window._chiaXchPrice || 4;
                const allNFTs = nftResponses.flatMap(d => d?.balance || []);
                console.log('📦 NFTs loaded via Lambda proxy:', allNFTs.length);

                const colMap = {};
                for (const nft of allNFTs) {
                    const cid = nft.collection_id; if (!cid) continue;
                    if (!colMap[cid]) {
                        const rawName2 = (nft.name || '').trim();
                        const colName = rawName2.replace(/\s+#\d+[\w\s]*$/, '').trim() || rawName2 || cid.slice(0,16) + '…';
                        colMap[cid] = { colId: cid, id: cid, name: colName, image: nft.preview_url || '', count: 0, floor_xch: 0 };
                    }
                    colMap[cid].count++;
                    if (!colMap[cid].image && nft.preview_url) colMap[cid].image = nft.preview_url;
                }

                // MintGarden enrichment (Lambda is fine — it's not Spacescan)
                const allColIds = Object.keys(colMap);
                if (allColIds.length > 0) {
                    try {
                        const cr = await fetch('/api/chia-collections', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ colIds: allColIds }),
                        });
                        if (cr.ok) {
                            const mgMap = (await cr.json()).collections || {};
                            for (const cid of allColIds) {
                                const mg = mgMap[cid]; if (!mg) continue;
                                if (mg.name)      colMap[cid].name  = mg.name;
                                if (mg.thumbnail) colMap[cid].image = mg.thumbnail;
                                colMap[cid].floor_xch = mg.floor_xch || 0;
                            }
                        }
                    } catch (e) { console.warn('MintGarden optional enrichment failed:', e.message); }
                }

                const cols = Object.values(colMap).sort((a, b) => b.count - a.count);
                const nftData = { collections: cols, totalNFTs: allNFTs.length, totalCollections: cols.length,
                    totalValue: cols.reduce((s,c) => s+(c.count*c.floor_xch*xchPrice), 0),
                    totalXch: cols.reduce((s,c) => s+(c.count*c.floor_xch), 0) };
                window._chiaNFTData  = nftData;
                window._chiaXchPrice = xchPrice;
                console.log('✅ NFTs:', allNFTs.length, 'in', cols.length, 'collections');
                updateNFTGallery(nftData);
                nftsLoaded = true;

            } catch (err) {
                console.error('NFT loading error:', err);
                const g = document.getElementById('collections-grid');
                if (g) g.innerHTML = '<div style="text-align:center;padding:60px;color:#ef4444;grid-column:1/-1;">⚠️ Error loading NFT collections — click to retry</div>';
            } finally {
                nftsLoading = false;
            }
        }

        function renderNFTGallery(gallery, nftData, xchPrice) {
            const collections = nftData.collections || [];
            const totalNFTs   = nftData.totalNFTs   || 0;

            // Update stat counters
            const nftCountEl  = document.getElementById('total-nft-count');
            const collCountEl = document.getElementById('total-collections');
            if (nftCountEl)  nftCountEl.textContent  = totalNFTs;
            if (collCountEl) collCountEl.textContent = collections.length;

            if (collections.length === 0) {
                gallery.innerHTML = '<div style="text-align:center;padding:60px;color:rgba(255,255,255,0.3);grid-column:1/-1;">🖼️ No NFT collections found across treasury wallets</div>';
                return;
            }

            const cardStyle = `background:linear-gradient(135deg,rgba(74,222,128,0.12),rgba(0,0,0,0.4));border:1px solid rgba(74,222,128,0.2);border-radius:12px;overflow:hidden;cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;`;

            const cards = collections.map(col => {
                const mintUrl = col.id === 'uncategorized' ? 'https://mintgarden.io' : `https://mintgarden.io/collections/${col.id}`;
                const img = col.image
                    ? `<img src="${col.image}" style="width:100%;height:160px;object-fit:cover;" loading="lazy"
                         onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                       <div style="display:none;width:100%;height:160px;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;font-size:40px;">🌱</div>`
                    : `<div style="width:100%;height:160px;background:linear-gradient(135deg,rgba(74,222,128,0.15),rgba(0,0,0,0.5));display:flex;align-items:center;justify-content:center;font-size:40px;">🌱</div>`;
                return `
                <div style="${cardStyle}" onclick="window.open('${mintUrl}','_blank')"
                     onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 24px rgba(74,222,128,0.2)'"
                     onmouseout="this.style.transform='';this.style.boxShadow=''">
                    ${img}
                    <div style="padding:10px 12px;">
                        <div style="font-family:'Cinzel',serif;font-size:12px;font-weight:700;color:white;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:4px;" title="${col.name.replace(/"/g,'&quot;')}">${col.name}</div>
                        <span style="font-size:11px;color:rgba(74,222,128,0.8);font-weight:600;">${col.count} NFT${col.count>1?'s':''}</span>
                    </div>
                </div>`;
            }).join('');

            const header = `<div style="grid-column:1/-1;margin:8px 0 4px;font-family:'Cinzel',serif;font-size:13px;color:rgba(74,222,128,0.8);letter-spacing:2px;text-transform:uppercase;">
                🌱 Chia NFT Collections — ${totalNFTs} NFTs across ${collections.length} collections (3 wallets)
            </div>`;
            gallery.innerHTML = header + cards;
        }


        // BOUNCING SCREENSAVER-STYLE BACKGROUND
        const bouncingImages = [];
        
        function initBackground() {
            const collage = document.getElementById('bgCollage');
            collage.innerHTML = ''; // Clear existing

            const images = [
                'images/wizard1.png', 'images/wizard2.png', 'images/wizard3.png',
                'images/wizard4.png', 'images/wizard5.png', 'images/wizard6.png',
                'images/1768724161355_image.png', 'images/1768770350230_image.png',
                'images/1768770712319_image.png', 'images/1768771847908_image.png',
                'images/1768772304325_image.png', 'images/uploaded_image_2_1768636844588.png',
                'images/uploaded_image_3_1768636844588.png', 'images/uploaded_image_4_1768636844588.jpg',
                'images/uploaded_image_1_1768638579775.png', 'images/uploaded_image_2_1768638579775.png',
                'images/uploaded_image_3_1768638579775.png', 'images/uploaded_image_4_1768638579775.jpg',
                'images/uploaded_image_1_1768638691015.png', 'images/uploaded_image_2_1768638691015.png',
                'images/uploaded_image_3_1768638691015.png', 'images/uploaded_image_4_1768638691015.jpg',
                'images/uploaded_image_1_1768638712026.jpg', 'images/uploaded_image_2_1768638712026.jpg',
                'images/uploaded_image_3_1768638712026.png', 'images/uploaded_image_4_1768638712026.jpg',
                'images/IMG_5410.jpeg', 'images/IMG_5288.jpeg', 'images/IMG_9197.jpeg',
                'images/IMG_2987.jpeg', 'images/IMG_7865.jpeg', 'images/IMG_7828.jpeg',
                'images/IMG_7578.jpeg', 'images/IMG_7496.jpeg', 'images/IMG_8330.jpeg',
                'images/Untitled_Artwork_Original.png', 'images/IMG_0199.jpeg', 'images/IMG_0205.jpeg',
                'images/IMG_7866.jpeg', 'images/IMG_8048.jpeg', 'images/IMG_8371.jpeg',
                'images/image0.jpeg', 'images/plant_your_seed.png',
                'images/Screenshot_2026-01-17_232436-removebg-preview.png'
            ];

            // Create 80 bouncing images
            const totalImages = 80;
            
            for (let i = 0; i < totalImages; i++) {
                const src = images[i % images.length];
                const size = Math.random() * 100 + 80; // 80-180px
                
                // Random z-index: some go above gradient (11-14) to pop into header, but stay behind text (15)
                const zIndex = Math.random() > 0.3 ? Math.floor(Math.random() * 4) + 11 : 5; // 70% chance to pop above, 30% stay below
                
                // Create image element with lazy loading
                const img = document.createElement('img');
                img.dataset.src = src; // Store src in data attribute for lazy loading
                img.loading = 'lazy'; // Native lazy loading
                img.style.cssText = `
                    position: fixed;
                    width: ${size}px;
                    height: ${size}px;
                    object-fit: contain;
                    filter: drop-shadow(0 0 10px rgba(255, 0, 0, 0.3));
                    pointer-events: none;
                    opacity: 0.8;
                    z-index: ${zIndex};
                `;
                
                // Load immediately for first batch, lazy load rest
                if (i < 8) {
                    img.src = src;
                } else {
                    requestIdleCallback(() => { img.src = src; });
                }
                
                collage.appendChild(img);
                
                // Physics properties
                const imageData = {
                    element: img,
                    x: Math.random() * window.innerWidth,
                    y: Math.random() * window.innerHeight,
                    vx: (Math.random() - 0.5) * 0.4, // Slightly faster than 0.5
                    vy: (Math.random() - 0.5) * 0.4,
                    size: size,
                    zIndex: zIndex,
                    lifetime: Math.random() * 30000 + 20000, // 20-50 seconds before respawn
                    born: Date.now(),
                    visible: true
                };
                
                bouncingImages.push(imageData);
            }
            
            // Start animation loop
            animateBouncingImages();
        }
        
        function animateBouncingImages() {
            const now = Date.now();
            
            bouncingImages.forEach(img => {
                // Check if image should respawn
                if (now - img.born > img.lifetime) {
                    // Disappear for a moment
                    if (img.visible) {
                        img.element.style.opacity = '0';
                        img.visible = false;
                        img.respawnTime = now + Math.random() * 3000 + 1000; // 1-4 seconds
                    } else if (now > img.respawnTime) {
                        // Respawn at new random position with new z-index!
                        img.x = Math.random() * window.innerWidth;
                        img.y = Math.random() * window.innerHeight;
                        img.vx = (Math.random() - 0.5) * 0.4;
                        img.vy = (Math.random() - 0.5) * 0.4;
                        
                        // Randomize z-index on respawn - dynamic layering!
                        const newZIndex = Math.random() > 0.3 ? Math.floor(Math.random() * 4) + 11 : 5;
                        img.zIndex = newZIndex;
                        img.element.style.zIndex = newZIndex;
                        
                        img.born = now;
                        img.visible = true;
                        img.element.style.opacity = '0.8';
                    }
                }
                
                if (!img.visible) return;
                
                // Update position
                img.x += img.vx;
                img.y += img.vy;
                
                // Bounce off edges (like DVD screensaver!)
                if (img.x <= 0 || img.x + img.size >= window.innerWidth) {
                    img.vx *= -1;
                    img.x = Math.max(0, Math.min(window.innerWidth - img.size, img.x));
                }
                
                if (img.y <= 0 || img.y + img.size >= window.innerHeight) {
                    img.vy *= -1;
                    img.y = Math.max(0, Math.min(window.innerHeight - img.size, img.y));
                }
                
                // Apply position
                img.element.style.left = img.x + 'px';
                img.element.style.top = img.y + 'px';
            });
            
            requestAnimationFrame(animateBouncingImages);
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            bouncingImages.forEach(img => {
                img.x = Math.min(img.x, window.innerWidth - img.size);
                img.y = Math.min(img.y, window.innerHeight - img.size);
            });
        });
        function updateVisitorCount() {
            const visitorEl = document.getElementById('visitorCount');
            if (visitorEl) {
                const baseCount = 133769;
                const increment = Math.floor(Math.random() * 3);
                const currentCount = parseInt(visitorEl.textContent) || baseCount;
                visitorEl.textContent = (currentCount + increment).toLocaleString();
            }
        }

// Token ID constants for emoji market linking
const CHIA_TOKENS = {
    'CASTER': 'a09af8b0d12b27772c64f89cf0d1db95186dca5b1871babc5108ff44f36305e6',
    'SPELLPOWER': 'eb2155a177b6060535dd8e72e98ddb0c77aea21fab53737de1c1ced3cb38e4c4',
    'WIZ': 'ae1536f56760e471ad85ead45f00d680ff9cca73b8cc3407be778f1c0c606eac',
    'LOVE': '70010d83542594dd44314efbae75d82b3d9ae7d946921ed981a6cd08f0549e50',
    'SPROUT': 'ab558b1b841365a24d1ff2264c55982e55664a8b6e45bc107446b7e667bb463b',
    'PIZZA': 'dd37f678dda586fad9b1daeae1f7c5c137ffa6d947e1ed5c7b4f3c430da80638'
};

const BASE_TOKENS = {
    'wCAST': '0x09Aa909Eea859f712f2Ae3dd1872671D2363f6f4',
    'wSPELLPOWER': '0x145F14b876051DC443dd18D5f8a7C48c5db75847',
    'wWIZ': '0x39916e508e389FBB4dDC3d1a38a5801f4eE253c7',
    'wLOVE': '0x817cAb331aaA4c24b4e32024FCa093AD40CBa208',
    'wSPROUT': '0xd1b771CB462a4B0e4d56Bb68b4bF832994CC8820',
    'wPIZZA': '0x84070f2c685b3d4B63c66f0B13fB83Fa6ccb4035'
};

function updateEmojiMarket(chiaTokens, baseTokens) {
    const EMOJI_MAP = {
        'CASTER': '✨❤️‍🔥🧙‍♂️',
        'wCAST': '✨❤️‍🔥🧙‍♂️',
        'SPELLPOWER': '⚡️🪄',
        'wSPELLPOWER': '⚡️🪄',
        'WIZ': '🧙💸',
        'wWIZ': '🧙💸',
        'LOVE': '❤️',
        'wLOVE': '❤️',
        'SPROUT': '🌱',
        'wSPROUT': '🌱',
        'PIZZA': '🍕',
        'wPIZZA': '🍕'
    };
    
    // Create price maps for easy lookup
    const chiaPriceMap = {};
    const basePriceMap = {};
    
    chiaTokens.forEach(t => {
        const key = t.symbol.replace(/^w/, ''); // Remove 'w' prefix
        chiaPriceMap[key] = t.price || 0;
    });
    
    baseTokens.forEach(t => {
        const key = t.symbol.replace(/^w/, ''); // Remove 'w' prefix
        basePriceMap[key] = {
            price: t.price || 0,
            change24h: t.change24h || 0
        };
    });
    
    // Update Base side - show 24h change
    const baseList = document.getElementById('baseTokenList');
    if (baseList) {
        const baseHTML = baseTokens.map(token => {
            const emoji = EMOJI_MAP[token.symbol] || token.symbol;
            const change = token.change24h || 0;
            
            return `
                <div style="
                    padding: 10px 12px;
                    border: 2px solid rgba(0, 82, 255, 0.7);
                    border-radius: 6px;
                    background: rgba(0, 82, 255, 0.05);
                    cursor: pointer;
                    text-align: center;
                " onclick="window.open('https://dexscreener.com/base/${BASE_TOKENS[token.symbol]}', '_blank')">
                    <div style="font-size: 32px; margin-bottom: 6px;">${emoji}</div>
                    <div style="font-weight: 700; color: #4ade80; font-size: 14px; margin-bottom: 6px;">$${(token.price || 0).toFixed(6)}</div>
                    <div style="font-size: 13px; font-weight: 700; ${change >= 0 ? 'color: #4ade80;' : 'color: #ef4444;'}">
                        ${change >= 0 ? '↑' : '↓'} ${Math.abs(change).toFixed(1)}%
                    </div>
                </div>
            `;
        }).join('');
        baseList.innerHTML = baseHTML;
    }
    
    // Update Chia side - show arbitrage vs Base
    const chiaList = document.getElementById('chiaTokenList');
    if (chiaList) {
        const chiaHTML = chiaTokens.map(token => {
            const key = token.symbol.replace(/^w/, '');
            const emoji = EMOJI_MAP[token.symbol] || token.symbol;
            const chiaPrice = token.price || 0;
            const basePrice = basePriceMap[key]?.price || 0;
            
            console.log(`Arbitrage calc for ${key}: Chia=$${chiaPrice.toFixed(6)}, Base=$${basePrice.toFixed(6)}`);
            
            // Calculate arbitrage
            const diff = basePrice - chiaPrice;
            const diffPercent = basePrice > 0 ? (diff / basePrice) * 100 : 0;
            const diffDollars = Math.abs(diff);
            
            // Determine color and label — always show actual %, no suppression
            let arbColor = '#888';
            let arbLabel;
            let arbIcon;
            
            if (basePrice === 0 || chiaPrice === 0) {
                arbColor = 'rgba(255,255,255,0.3)';
                arbLabel = 'cannot fetch';
                arbIcon = '⚠️';
            } else if (diff > 0) {
                arbColor = '#4ade80';
                arbLabel = `${Math.abs(diffPercent).toFixed(1)}% cheaper`;
                arbIcon = '🟢';
            } else if (diff < 0) {
                arbColor = '#ef4444';
                arbLabel = `${Math.abs(diffPercent).toFixed(1)}% premium`;
                arbIcon = '🔴';
            } else {
                arbColor = 'rgba(255,255,255,0.3)';
                arbLabel = '0.0% diff';
                arbIcon = '⚪';
            }
            
            console.log(`${key}: ${arbIcon} ${arbLabel}`);
            
            return `
                <div style="
                    padding: 10px 12px;
                    border: 2px solid rgba(74, 222, 128, 0.7);
                    border-radius: 6px;
                    background: rgba(74, 222, 128, 0.05);
                    cursor: pointer;
                    text-align: center;
                " onclick="window.open('https://www.tibetswap.io/swap?asset_id=${CHIA_TOKENS[key]}', '_blank')">
                    <div style="font-size: 32px; margin-bottom: 6px;">${emoji}</div>
                    <div style="font-weight: 700; color: #4ade80; font-size: 14px; margin-bottom: 4px;">$${chiaPrice.toFixed(6)}</div>
                    <div style="font-size: 10px; color: rgba(255,255,255,0.5); margin-bottom: 4px;">vs Base: $${basePrice.toFixed(6)}</div>
                    <div style="font-size: 13px; color: ${arbColor}; font-weight: 700;">
                        ${arbIcon} ${arbLabel}
                        ${(diffDollars > 0 && basePrice > 0 && chiaPrice > 0) ? `<div style="font-size: 10px; color: rgba(255,255,255,0.6); margin-top: 2px;">$${diffDollars.toFixed(6)} diff</div>` : ''}
                    </div>
                </div>
            `;
        }).join('');
        chiaList.innerHTML = chiaHTML;
    }
}

        function renderTokens(tokensToRender = tokens) {
            console.log(`\n🎨 RENDERING TOKENS`);
            console.log(`   Total to render: ${tokensToRender.length}`);
            
            const baseList = document.getElementById('baseTokenList');
            const chiaList = document.getElementById('chiaTokenList');

            // Clear current lists
            baseList.innerHTML = '';
            chiaList.innerHTML = '';

            // Find XCH and wXCH for featured boxes
            const xchToken = tokensToRender.find(t => t.symbol === 'XCH' && t.chain === 'Chia');
            const wxchToken = tokensToRender.find(t => t.symbol === 'wXCH' && t.chain === 'Base');

            // Update XCH featured box
            if (xchToken) {
                document.getElementById('xch-price').textContent = `$${xchToken.price ? xchToken.price.toFixed(2) : '0.00'}`;
                const xchChange = xchToken.change24h || 0;
                document.getElementById('xch-change').innerHTML = `
                    <span style="color: ${xchChange >= 0 ? '#4ade80' : '#ef4444'}">
                        ${xchChange >= 0 ? '↑' : '↓'} ${Math.abs(xchChange).toFixed(1)}%
                    </span>
                `;
            }

            // Update wXCH featured box
            if (wxchToken) {
                document.getElementById('wxch-price').textContent = `$${wxchToken.price ? wxchToken.price.toFixed(2) : '0.00'}`;
                const wxchChange = wxchToken.change24h || 0;
                document.getElementById('wxch-change').innerHTML = `
                    <span style="color: ${wxchChange >= 0 ? '#4ade80' : '#ef4444'}">
                        ${wxchChange >= 0 ? '↑' : '↓'} ${Math.abs(wxchChange).toFixed(1)}%
                    </span>
                `;
            }

            // Filter tokens by chain, EXCLUDING XCH and wXCH from main lists
            const baseTokens = tokensToRender.filter(t => t.chain === 'Base' && t.symbol !== 'wXCH');
            const chiaTokens = tokensToRender.filter(t => t.chain === 'Chia' && t.symbol !== 'XCH');

            console.log(`   Base tokens to render: ${baseTokens.length} (excluding wXCH)`);
            console.log(`   Chia tokens to render: ${chiaTokens.length} (excluding XCH)`);

            // Helper to create Base token card HTML (shows 24h change)
            const EMOJI_MAP = {
                'CAST':       '✨❤️‍🔥🧙‍♂️',
                'CASTER':     '✨❤️‍🔥🧙‍♂️',
                'wCAST':      '✨❤️‍🔥🧙‍♂️',
                'SPELL':      '⚡️🪄',
                'SPELLPOWER': '⚡️🪄',
                'wSPELL':     '⚡️🪄',
                'BYC':        '🧙💸',
                'WIZ':        '🧙💸',
                'wBYC':       '🧙💸',
                'LOVE':       '❤️',
                'wLOVE':      '❤️',
                'SPROUT':     '🌱',
                'wSPROUT':    '🌱',
                'PIZZA':      '🍕',
                'wPIZZA':     '🍕'
            };
            const getEmoji = (sym) => {
                // If already emoji/non-ASCII (trackedTokens store emoji as symbol), use as-is
                if (/[^\u0000-\u007F]/.test(sym)) return sym;
                // Otherwise look up in map
                return EMOJI_MAP[sym] || EMOJI_MAP[sym.replace(/^w/,'')] || sym;
            };

            const createBaseCard = (token) => `
                <div class="token-card" onclick="openTokenLink('${token.chain}', '${token.assetId || token.contract}', '${token.symbol}')">
                    <div class="token-header">
                        <div class="token-info">
                            <div style="
                                width: 52px;
                                height: 52px;
                                background: linear-gradient(135deg, rgba(251, 191, 36, 0.12), rgba(220, 38, 38, 0.08));
                                border-radius: 12px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                box-shadow: 0 4px 12px rgba(251, 191, 36, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1);
                                border: 1px solid rgba(251, 191, 36, 0.2);
                                flex-shrink: 0;
                            ">
                                <div class="token-symbol">${getEmoji(token.symbol)}</div>
                            </div>
                            <div>
                                <div class="token-name">${token.displayName || token.name}</div>
                                <div style="font-size: 10px; color: rgba(255,255,255,0.35); font-family: 'Inter', sans-serif; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">Base Chain</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="token-price">$${token.price ? (
                                token.price < 0.0001 ? token.price.toFixed(10) :
                                token.price < 0.001 ? token.price.toFixed(8) :
                                token.price < 0.01 ? token.price.toFixed(8) :
                                token.price < 1 ? token.price.toFixed(6) :
                                token.price.toFixed(2)
                            ) : '0.00'}</div>
                            <div class="token-change" style="
                                color: ${token.change24h >= 0 ? '#4ade80' : '#ef4444'};
                                font-size: 13px;
                                font-weight: 700;
                                font-family: 'Inter', sans-serif;
                                display: flex;
                                align-items: center;
                                justify-content: flex-end;
                                gap: 3px;
                                margin-top: 3px;
                            ">
                                <span style="font-size: 14px;">${token.change24h >= 0 ? '↑' : '↓'}</span>
                                <span>${Math.abs(token.change24h || 0).toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-top: 10px;
                        padding-top: 10px;
                        border-top: 1px solid rgba(251, 191, 36, 0.1);
                        background: linear-gradient(90deg, rgba(251, 191, 36, 0.03), transparent);
                        padding: 8px 0;
                        border-radius: 6px;
                    ">
                        <span style="font-size: 11px; color: rgba(255,255,255,0.4); font-family: 'Inter', sans-serif; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Market Cap</span>
                        <span style="font-size: 13px; color: #fbbf24; font-weight: 700; font-family: 'Cinzel', serif;">${token.marketCap > 1e6 ? '$'+(token.marketCap/1e6).toFixed(1)+'M' : token.marketCap > 1e3 ? '$'+(token.marketCap/1e3).toFixed(0)+'K' : token.marketCap > 0 ? '$'+token.marketCap.toFixed(0) : '—'}</span>
                    </div>
                </div>
            `;

            // Helper to create Chia token card HTML (shows arbitrage vs Base)
            const BYC_ASSET_ID = 'ae1536f56760e471ad85ead45f00d680ff9cca73b8cc3407be778f1c0c606eac';
            const createChiaCard = (token) => {
                // BYC (Bytecash on Chia) = Wizard Bucks on Base once bridged
                // Match by assetId for BYC, otherwise by symbol
                let baseToken;
                if (token.assetId === BYC_ASSET_ID) {
                    baseToken = baseTokens.find(b => b.name === 'Wizard Bucks');
                } else {
                    baseToken = baseTokens.find(b => b.symbol === token.symbol);
                }
                
                let arbDisplay = '';
                let arbColor = '#888';
                
                if (baseToken && baseToken.price > 0 && token.price > 0) {
                    const diff = baseToken.price - token.price;
                    const diffPercent = (diff / baseToken.price) * 100;
                    // Always show the actual % difference — no "same price" suppression
                    if (diff > 0) {
                        arbColor = '#4ade80';
                        arbDisplay = `🟢 ${Math.abs(diffPercent).toFixed(1)}% cheaper`;
                    } else if (diff < 0) {
                        arbColor = '#ef4444';
                        arbDisplay = `🔴 ${Math.abs(diffPercent).toFixed(1)}% premium`;
                    } else {
                        arbColor = 'rgba(255,255,255,0.3)';
                        arbDisplay = `⚪ 0.0% diff`;
                    }
                } else {
                    arbColor = 'rgba(255,255,255,0.25)';
                    arbDisplay = '⚠️ cannot fetch';
                }

                const mcap = token.marketCap || 0;
                const fmt  = n => n > 1e6 ? '$'+(n/1e6).toFixed(2)+'M' : n > 1e3 ? '$'+(n/1e3).toFixed(1)+'K' : n > 0 ? '$'+n.toFixed(0) : '—';

                return `
                <div class="token-card" onclick="openTokenLink('${token.chain}', '${token.assetId || token.contract}', '${token.symbol}')">
                    <div class="token-header">
                        <div class="token-info">
                            <div style="
                                width: 52px;
                                height: 52px;
                                background: linear-gradient(135deg, rgba(74, 222, 128, 0.12), rgba(34, 197, 94, 0.08));
                                border-radius: 12px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                box-shadow: 0 4px 12px rgba(74, 222, 128, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1);
                                border: 1px solid rgba(74, 222, 128, 0.2);
                                flex-shrink: 0;
                            ">
                                <div class="token-symbol">${getEmoji(token.symbol)}</div>
                            </div>
                            <div>
                                <div class="token-name">${token.displayName || token.name}</div>
                                <div style="font-size: 10px; color: rgba(255,255,255,0.35); font-family: 'Inter', sans-serif; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px;">Chia Network</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="token-price">$${token.price ? (
                                token.price < 0.0001 ? token.price.toFixed(10) :
                                token.price < 0.001 ? token.price.toFixed(8) :
                                token.price < 0.01 ? token.price.toFixed(8) :
                                token.price < 1 ? token.price.toFixed(6) :
                                token.price.toFixed(2)
                            ) : '0.00'}</div>
                            <div class="token-change" style="
                                color: ${arbColor};
                                font-size: 13px;
                                font-weight: 700;
                                font-family: 'Inter', sans-serif;
                                display: flex;
                                align-items: center;
                                justify-content: flex-end;
                                gap: 3px;
                                margin-top: 3px;
                            ">
                                ${arbDisplay}
                            </div>
                        </div>
                    </div>
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-top: 10px;
                        padding-top: 10px;
                        border-top: 1px solid rgba(74, 222, 128, 0.1);
                        background: linear-gradient(90deg, rgba(74, 222, 128, 0.03), transparent);
                        padding: 8px 0;
                        border-radius: 6px;
                    ">
                        <span style="font-size: 11px; color: rgba(255,255,255,0.4); font-family: 'Inter', sans-serif; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">${token.isTvl ? 'Total Value Locked' : 'Market Cap'}</span>
                        <span style="font-size: 13px; color: #4ade80; font-weight: 700; font-family: 'Cinzel', serif;">${mcap > 0 ? fmt(mcap) : '—'}</span>
                    </div>
                </div>
            `;
            };

            baseList.innerHTML = baseTokens.map(createBaseCard).join('');
            chiaList.innerHTML = chiaTokens.map(createChiaCard).join('');
            
            console.log(`   ✅ Rendering complete\n`);
        }

        function openTokenLink(chain, id, symbol) {
            if (chain === 'Chia') {
                if (id === 'Native') {
                    window.open(`https://spacescan.io/xch/coin/xch`, '_blank');
                } else {
                    window.open(`https://spacescan.io/xch/token/${id}`, '_blank');
                }
            } else if (chain === 'Base') {
                // Link to 9mm Pro swap with specific token
                if (id && id !== 'Native') {
                    window.open(`https://dex.9mm.pro/swap?outputCurrency=${id}`, '_blank');
                } else {
                    window.open(`https://dex.9mm.pro`, '_blank');
                }
            }
        }

        

        function sortTokens(sortBy, element) {
            currentSort = sortBy;

            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            } else {
                // If no element passed, find and activate the button matching current sort
                const buttons = document.querySelectorAll('.filter-btn');
                buttons.forEach(btn => {
                    const btnText = btn.textContent.toLowerCase();
                    if ((sortBy === 'name' && btnText.includes('name')) ||
                        (sortBy === 'marketCap' && btnText.includes('market')) ||
                        (sortBy === 'change' && btnText.includes('change')) ||
                        (sortBy === 'arbitrage' && btnText.includes('arbitrage'))) {
                        btn.classList.add('active');
                    }
                });
            }

            // Make sure we have tokens to sort
            if (!displayedTokens || displayedTokens.length === 0) {
                displayedTokens = [...tokens];
            }

            let sorted = [...displayedTokens];

            switch (sortBy) {
                case 'name': {
                    // "Bytecash" (BYC on Chia) is the same asset as "Wizard Bucks" (on Base).
                    // Sort them both as "Wizard Bucks" so they appear together naturally.
                    const toSortName = t => t.name === 'Bytecash' ? 'Wizard Bucks' : t.name;
                    sorted.sort((a, b) => {
                        const cmp = toSortName(a).localeCompare(toSortName(b));
                        if (cmp !== 0) return cmp;
                        // Secondary sort: Chia before Base within same name group
                        if (a.chain === 'Chia' && b.chain === 'Base') return -1;
                        if (a.chain === 'Base' && b.chain === 'Chia') return 1;
                        return 0;
                    });
                    break;
                }
                case 'marketCap': {
                    // Sort Chia tokens by market cap, Base tokens stick next to their Chia match
                    const BYC_MC = 'ae1536f56760e471ad85ead45f00d680ff9cca73b8cc3407be778f1c0c606eac';
                    const chiaMC = sorted.filter(t => t.chain === 'Chia').sort((a, b) => (b.marketCap||0) - (a.marketCap||0));
                    sorted = [];
                    for (const ct of chiaMC) {
                        sorted.push(ct);
                        const bt = (ct.assetId === BYC_MC)
                            ? displayedTokens.find(t => t.chain === 'Base' && t.name === 'Wizard Bucks')
                            : displayedTokens.find(t => t.chain === 'Base' && t.symbol === ct.symbol);
                        if (bt) sorted.push(bt);
                    }
                    const pairedMC = sorted.filter(t => t.chain === 'Base');
                    displayedTokens.filter(t => t.chain === 'Base' && !pairedMC.includes(t)).forEach(t => sorted.push(t));
                    break;
                }
                case 'change':
                    sorted.sort((a, b) => (b.change24h || 0) - (a.change24h || 0));
                    break;
                case 'arbitrage': {
                    // Group tokens into pairs and sort by arbitrage opportunity
                    // BYC (ae1536... on Chia) bridges to Wizard Bucks on Base
                    const BYC_ID = 'ae1536f56760e471ad85ead45f00d680ff9cca73b8cc3407be778f1c0c606eac';
                    const pairs = [];
                    const chiaTokensArb = sorted.filter(t => t.chain === 'Chia' && t.assetId !== 'Native');
                    
                    chiaTokensArb.forEach(chiaToken => {
                        // BYC pairs with Wizard Bucks by name, all others by symbol
                        const baseToken = (chiaToken.assetId === BYC_ID)
                            ? sorted.find(t => t.chain === 'Base' && t.name === 'Wizard Bucks')
                            : sorted.find(t => t.chain === 'Base' && t.symbol === chiaToken.symbol);
                        
                        let arbitragePercent = 0;
                        if (baseToken && baseToken.price > 0 && chiaToken.price > 0) {
                            const diff = baseToken.price - chiaToken.price;
                            arbitragePercent = Math.abs((diff / baseToken.price) * 100);
                        }
                        
                        pairs.push({ chiaToken, baseToken, arbitragePercent });
                    });
                    
                    // Sort pairs by arbitrage percentage (highest opportunity first)
                    pairs.sort((a, b) => b.arbitragePercent - a.arbitragePercent);
                    
                    // Rebuild sorted array: Chia token + its Base pair side-by-side
                    sorted = [];
                    pairs.forEach(pair => {
                        sorted.push(pair.chiaToken);
                        if (pair.baseToken) sorted.push(pair.baseToken);
                    });
                    
                    // Add XCH and wXCH at the end
                    const xchT = tokens.find(t => t.symbol === 'XCH');
                    const wxchT = tokens.find(t => t.symbol === 'wXCH' || (t.chain === 'Base' && t.name === 'Wrapped Chia'));
                    if (xchT) sorted.push(xchT);
                    if (wxchT) sorted.push(wxchT);
                    
                    // Add any Base tokens that have no Chia counterpart
                    const pairedBase = pairs.map(p => p.baseToken).filter(Boolean);
                    const unpairedBase = sorted.filter(t => t.chain === 'Base' && t.assetId !== 'Native' && !pairedBase.includes(t));
                    sorted.push(...unpairedBase);
                    break;
                }
            }

            renderTokens(sorted);
        }

        // ── PERFORMANCE UTILITIES ─────────────────────────────────────────────────
        
        // Debounce function for search/filter operations
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Lazy load images when they enter viewport
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src && !img.src) {
                        img.src = img.dataset.src;
                        imageObserver.unobserve(img);
                    }
                }
            });
        }, { rootMargin: '50px' });

        // Request idle callback polyfill
        window.requestIdleCallback = window.requestIdleCallback || function(cb) {
            const start = Date.now();
            return setTimeout(() => {
                cb({ didTimeout: false, timeRemaining: () => Math.max(0, 50 - (Date.now() - start)) });
            }, 1);
        };

        // ── END PERFORMANCE UTILITIES ─────────────────────────────────────────────

        function filterTokens() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            displayedTokens = tokens.filter(t =>
                (t.name && t.name.toLowerCase().includes(search)) ||
                (t.symbol && t.symbol.toLowerCase().includes(search))
            );
            sortTokens(currentSort);
        }

        async function searchDexTokens(query) {
            // Search function on Base specifically
            const baseList = document.getElementById('baseTokenList');
            baseList.innerHTML = '<div class="loading"><div class="spinner"></div>Searching...</div>';

            try {
                const response = await fetch(`https://api.dexscreener.com/latest/dex/search?q=${query}`);
                if (response.ok) {
                    const data = await response.json();
                    const basePairs = data.pairs.filter(p => p.chainId === 'base');

                    if (basePairs.length > 0) {
                        const newBaseTokens = basePairs.map(p => ({
                            symbol: p.baseToken.symbol,
                            name: p.baseToken.name,
                            price: parseFloat(p.priceUsd) || 0,
                            change24h: p.priceChange.h24 || 0,
                            marketCap: p.fdv || 0,
                            chain: 'Base',
                            contract: p.baseToken.address
                        }));

                        const createCard = (token) => `
                            <div class="token-card" style="border: none;" onclick="openTokenLink('${token.chain}', '${token.contract}', '${token.symbol}')">
                                <div class="token-header">
                                    <div class="token-info">
                                        <div class="token-avatar">${token.symbol.substring(0, 2)}</div>
                                        <div>
                                            <div class="token-symbol">
                                                <span>${token.symbol}</span>
                                            </div>
                                            <div class="token-name">♪ ${token.name} ♪</div>
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div class="token-price">$${Number(token.price).toLocaleString(undefined, { maximumSignificantDigits: 4 })}</div>
                                        <div class="token-change" style="color: ${token.change24h >= 0 ? '#4ade80' : '#ef4444'}">
                                            ${token.change24h >= 0 ? '↑' : '↓'} ${Math.abs(token.change24h).toFixed(2)}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        baseList.innerHTML = newBaseTokens.map(createCard).join('');
                    } else {
                        baseList.innerHTML = '<div style="padding:20px;">No results found on Base.</div>';
                    }
                }
            } catch (error) {
                baseList.innerHTML = '<div style="color: #ef4444; padding: 20px;">Error searching DEX</div>';
            }
        }

        // Debounced search handler for better performance
        const debouncedHandleSearch = debounce(function() {
            const searchValue = document.getElementById('searchInput').value.trim();

            if (!searchValue) {
                refreshData();
                return;
            }

            if (searchValue.startsWith('0x')) {
                searchDexTokens(searchValue);
                return;
            }

            filterTokens();
        }, 300);

        function handleSearch() {
            debouncedHandleSearch();
        }

        function refreshData() {
            displayedTokens = [...tokens];
            sortTokens(currentSort);
        }

        async function trackAddress() {
            const address = document.getElementById('walletAddress').value.trim();
            if (!address.startsWith('0x') || address.length !== 42) {
                alert('Please enter a valid Base wallet address (0x...)');
                return;
            }

            // Show scanning state
            const btn = document.getElementById('track-btn');
            if (btn) { btn.textContent = '⏳ Scanning...'; btn.disabled = true; }
            document.getElementById('trackedAddressDisplay').innerHTML = `
                <div style="margin-top:8px; font-size:11px; color:rgba(255,255,255,0.5); font-family:monospace;">
                    📡 Scanning: <span style="color:#fbbf24">${address.slice(0,8)}...${address.slice(-6)}</span>
                </div>`;
            document.getElementById('portfolioList').innerHTML = `
                <div style="text-align:center; padding:60px 20px;">
                    <div style="font-size:40px; margin-bottom:16px; animation:pulse 1.5s infinite;">⚡</div>
                    <div style="font-size:16px; color:#fbbf24; font-weight:700; margin-bottom:8px;">Scanning the chain...</div>
                    <div style="font-size:13px; color:rgba(255,255,255,0.4);">Fetching tokens, LP positions &amp; pricing via DexScreener + RPC</div>
                </div>`;
            document.getElementById('bag-summary').style.display = 'none';

            try {
                const resp = await fetch('/api/treasury-comprehensive?address=' + address + '&chain=base');
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();
                if (data.error) throw new Error(data.error);
                renderBagResults(address, data);
            } catch (err) {
                console.error('Bag scan error:', err);
                document.getElementById('portfolioList').innerHTML =
                    '<div style="text-align:center; padding:60px 20px; color:#ef4444;">' +
                    '<div style="font-size:40px; margin-bottom:16px;">&#9888;&#65039;</div>' +
                    '<div style="font-size:18px; font-weight:700; margin-bottom:8px;">Scan Failed</div>' +
                    '<div style="font-size:13px; color:rgba(255,255,255,0.5);">' + err.message + '</div>' +
                    '</div>';
            } finally {
                if (btn) { btn.textContent = '\u2728 SCAN BAG'; btn.disabled = false; }
            }
        }

        function fmtUsd(v) {
            if (!v || v <= 0) return '$0';
            if (v >= 1e6) return '$' + (v/1e6).toFixed(2) + 'M';
            if (v >= 1e3) return '$' + (v/1e3).toFixed(1) + 'K';
            return '$' + v.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
        }

        function fmtBal(v) {
            if (!v || v === 0) return '0';
            if (v >= 1e6) return (v/1e6).toFixed(2) + 'M';
            if (v >= 1e3) return (v/1e3).toFixed(1) + 'K';
            if (v >= 1) return v.toLocaleString(undefined, {maximumFractionDigits:4});
            return v.toPrecision(4);
        }

        const BAG_COLORS = ['#fbbf24','#60a5fa','#4ade80','#a855f7','#f87171','#34d399','#fb923c','#c084fc','#e879f9','#38bdf8'];

        function renderBagResults(address, data) {
            const tokens = (data.tokens || []).sort((a,b) => (b.value||0) - (a.value||0));
            const total = data.total || tokens.reduce((s,t) => s+(t.value||0), 0);
            const lpTokens = tokens.filter(t => t.type === 'lp');
            const regularTokens = tokens.filter(t => t.type !== 'lp');
            const lpValue = lpTokens.reduce((s,t) => s+(t.value||0), 0);
            const topTokens = tokens.filter(t => (t.value||0) >= 1).slice(0, 10);

            // Update summary
            document.getElementById('bag-summary').style.display = 'block';
            document.getElementById('bag-total-value').textContent = fmtUsd(total);
            document.getElementById('bag-position-count').textContent = tokens.length;
            document.getElementById('bag-lp-count').textContent = lpTokens.length;
            document.getElementById('bag-lp-value').textContent = fmtUsd(lpValue);

            // Allocation bar
            if (total > 0 && topTokens.length > 0) {
                const bar = document.getElementById('bag-alloc-bar');
                const legend = document.getElementById('bag-alloc-legend');
                let otherVal = total - topTokens.reduce((s,t)=>s+(t.value||0),0);
                const barItems = topTokens.map((t,i) => ({sym: t.symbol, val: t.value||0, color: BAG_COLORS[i]||'#888'}));
                if (otherVal > 0.01 * total) barItems.push({sym:'Other', val:otherVal, color:'#555'});
                bar.innerHTML = barItems.map(it => {
                    const pct = ((it.val/total)*100).toFixed(1);
                    return `<div style="flex:${it.val};background:${it.color};min-width:2px;" title="${it.sym}: ${pct}%"></div>`;
                }).join('');
                legend.innerHTML = barItems.slice(0,6).map(it => {
                    const pct = ((it.val/total)*100).toFixed(1);
                    return `<div style="display:flex;align-items:center;gap:4px;font-size:10px;color:rgba(255,255,255,0.6);">
                        <span style="width:8px;height:8px;background:${it.color};border-radius:2px;display:inline-block;"></span>
                        <span>${it.sym} ${pct}%</span>
                    </div>`;
                }).join('');
            }

            // Build position cards
            if (tokens.length === 0) {
                document.getElementById('portfolioList').innerHTML = `
                    <div style="text-align:center;padding:60px 20px;color:rgba(255,255,255,0.4);">
                        <div style="font-size:48px;margin-bottom:16px;">📭</div>
                        <div style="font-size:18px;margin-bottom:8px;">No positions found</div>
                        <div style="font-size:13px;">This wallet has no ERC-20 tokens on Base</div>
                    </div>`;
                return;
            }

            // Section headers
            let html = '';

            // LP Positions section (most important - show first)
            if (lpTokens.length > 0) {
                html += `<div style="margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
                        <div style="width:3px;height:24px;background:linear-gradient(180deg,#63b3ed,#3b82f6);border-radius:2px;"></div>
                        <span style="font-size:16px;font-weight:900;color:#63b3ed;text-transform:uppercase;letter-spacing:1px;">🔄 LP Positions</span>
                        <span style="font-size:12px;color:rgba(255,255,255,0.4);">${lpTokens.length} pools · ${fmtUsd(lpValue)}</span>
                    </div>
                    <div style="display:grid;gap:12px;">`;
                for (const tok of lpTokens) {
                    const val = tok.value || 0;
                    const pct = total > 0 ? ((val/total)*100).toFixed(1) : '0';
                    const share = tok.userSharePct ? parseFloat(tok.userSharePct) : 0;
                    const poolLiq = tok.totalLiqUsd || 0;
                    html += `<div style="
                        background:linear-gradient(135deg,rgba(20,30,50,0.9),rgba(10,15,30,0.95));
                        border:2px solid rgba(99,179,237,0.35);
                        border-radius:14px;padding:18px;
                        transition:all 0.25s;cursor:pointer;position:relative;overflow:hidden;"
                        onmouseover="this.style.borderColor='rgba(99,179,237,0.7)';this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(99,179,237,0.2)';"
                        onmouseout="this.style.borderColor='rgba(99,179,237,0.35)';this.style.transform='translateY(0)';this.style.boxShadow='none';"
                        onclick="window.open('https://dex.9mm.pro',\'_blank\')">
                        <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(99,179,237,0.5),transparent);"></div>
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div style="width:44px;height:44px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">🔄</div>
                                <div>
                                    <div style="font-size:17px;font-weight:800;color:white;margin-bottom:2px;">${tok.symbol}</div>
                                    <div style="font-size:11px;color:rgba(99,179,237,0.8);font-weight:600;">LP Position · 9mm.pro</div>
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:22px;font-weight:900;color:#63b3ed;">${fmtUsd(val)}</div>
                                <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px;">${pct}% of bag</div>
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.06);">
                            <div><div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Your Share</div><div style="font-size:14px;font-weight:700;color:white;">${share > 0 ? share.toFixed(3) + "%" : "—"}</div></div>
                            <div><div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Pool Liq</div><div style="font-size:14px;font-weight:700;color:#63b3ed;">${poolLiq > 0 ? fmtUsd(poolLiq) : "—"}</div></div>
                            ${tok.price0 > 0 ? '<div><div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">' + (tok.pairName||tok.symbol||'').split('/')[0] + ' Price</div><div style="font-size:13px;font-weight:700;color:#fbbf24;">$' + (tok.price0 < 0.001 ? tok.price0.toExponential(3) : tok.price0.toLocaleString(undefined,{maximumSignificantDigits:4})) + '</div></div>' : '<div><div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Balance</div><div style="font-size:13px;font-weight:700;color:white;">' + fmtBal(tok.balance) + ' LP</div></div>'}
                            ${tok.price1 > 0 ? '<div><div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">' + (tok.pairName||tok.symbol||'').split('/')[1] + ' Price</div><div style="font-size:13px;font-weight:700;color:#4ade80;">$' + (tok.price1 < 0.001 ? tok.price1.toExponential(3) : tok.price1.toLocaleString(undefined,{maximumSignificantDigits:4})) + '</div></div>' : '<div><div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">LP Tokens</div><div style="font-size:13px;font-weight:700;color:rgba(255,255,255,0.6);">' + fmtBal(tok.balance) + '</div></div>'}
                        </div>
                    </div>`;
                }
                html += '</div></div>';
            }

            // Regular tokens section
            if (regularTokens.filter(t => (t.value||0) >= 0.01).length > 0) {
                const showTokens = regularTokens.filter(t => (t.value||0) >= 0.01);
                html += `<div style="margin-bottom:12px;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;${lpTokens.length>0?'margin-top:28px;':''}">
                        <div style="width:3px;height:24px;background:linear-gradient(180deg,#fbbf24,#f59e0b);border-radius:2px;"></div>
                        <span style="font-size:16px;font-weight:900;color:#fbbf24;text-transform:uppercase;letter-spacing:1px;">💎 Tokens</span>
                        <span style="font-size:12px;color:rgba(255,255,255,0.4);">${showTokens.length} assets</span>
                    </div>
                    <div style="display:grid;gap:10px;">`;
                for (const tok of showTokens) {
                    const val = tok.value || 0;
                    const pct = total > 0 ? ((val/total)*100).toFixed(1) : '0';
                    const isNative = tok.type === 'native';
                    const gradient = isNative ? 'linear-gradient(135deg,#627eea,#4a5fd8)' : 'linear-gradient(135deg,#fbbf24,#f59e0b)';
                    const borderCol = isNative ? 'rgba(99,102,241,0.35)' : 'rgba(251,191,36,0.25)';
                    const borderHov = isNative ? 'rgba(99,102,241,0.7)' : 'rgba(251,191,36,0.6)';
                    const valCol = isNative ? '#818cf8' : '#fbbf24';
                    const priceStr = tok.price > 0 ? (tok.price < 0.001 ? '$'+tok.price.toFixed(8) : '$'+tok.price.toLocaleString(undefined,{maximumSignificantDigits:5})) : '—';
                    html += `<div style="
                        background:linear-gradient(135deg,rgba(20,20,30,0.85),rgba(10,10,20,0.9));
                        border:2px solid ${borderCol};border-radius:12px;padding:14px 18px;
                        transition:all 0.2s;cursor:${isNative?'default':'pointer'};"
                        onmouseover="this.style.borderColor='${borderHov}';this.style.transform='translateY(-1px)';"
                        onmouseout="this.style.borderColor='${borderCol}';this.style.transform='translateY(0)';"
                        onclick="${!isNative&&tok.contract?'window.open(\'https://dex.9mm.pro/swap?outputCurrency='+tok.contract+'\',\'_blank\')':''}">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div style="width:40px;height:40px;background:${gradient};border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:900;color:white;flex-shrink:0;">${tok.symbol.slice(0,3)}</div>
                                <div>
                                    <div style="font-size:15px;font-weight:800;color:white;">${tok.symbol}</div>
                                    <div style="font-size:11px;color:rgba(255,255,255,0.4);">${fmtBal(tok.balance)} · ${priceStr}</div>
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:18px;font-weight:800;color:${valCol}">${fmtUsd(val)}</div>
                                <div style="font-size:11px;color:rgba(255,255,255,0.35);">${pct}% of bag</div>
                            </div>
                        </div>
                        <div style="margin-top:10px;height:3px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden;">
                            <div style="height:100%;width:${Math.min(parseFloat(pct)*2,100)}%;background:${gradient};border-radius:2px;transition:width 0.6s;"></div>
                        </div>
                    </div>`;
                }
                html += '</div></div>';
            }

            document.getElementById('portfolioList').innerHTML = html;
        }
        // Initialize
        window.onload = function () {
            // ── Hash-based routing: restore the active tab from URL ──────────
            (function() {
                const validTabs = ['market', 'portfolio', 'treasury', 'howto', 'book', 'valley'];
                const hash = window.location.hash.replace('#', '');
                const activeTab = (hash && validTabs.includes(hash)) ? hash : 'market';
                
                const btn = document.querySelector(`.tab[onclick*="'${activeTab}'"]`);
                if (btn) {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    const el = document.getElementById(activeTab);
                    if (el) el.classList.add('active');
                    if (activeTab === 'treasury') {
                        // Load treasury - cache loads instantly, fresh data in background
                        setTimeout(loadComprehensiveTreasury, 200);
                    }
                }
            })();
            // ────────────────────────────────────────────────────────────────
            console.clear();
            console.log('%c🧙‍♂️ aWizard Treasury System Initialized', 'font-size: 20px; color: #fbbf24; font-weight: bold;');
            console.log('%c═══════════════════════════════════════════', 'color: #fbbf24;');
            console.log('%c📍 Treasury Wallet Addresses:', 'font-weight: bold; font-size: 14px; color: #0052ff;');
            console.log('   Base Network:');
            console.log('   ├─ 0x8d8cb6D19E32115823Cf0008701A84fB07F43467');
            console.log('   └─ 0xEEDC069F861880eC1B5f41c9bC7a747DC1cE32b9');
            console.log('   Chia Network:');
            console.log('   └─ xch10na8nqys9afs0fl74vvd6xl3akgu77p8mvjsp2ywy7rhq2s0jqys3nf7dl');
            console.log('');
            console.log('%c🪙 Tracked Tokens Configuration:', 'font-weight: bold; font-size: 14px; color: #4ade80;');
            console.log('   Base Network (8 tokens):');
            console.log('   ├─ wXCH (Wrapped XCH)');
            console.log('   ├─ ✨🧙 Caster');
            console.log('   ├─ ⚡️🪄 Spellpower');
            console.log('   ├─ 🧙💸 Wizard Bucks');
            console.log('   ├─ ❤️ Love');
            console.log('   ├─ 🌱 Sprout');
            console.log('   └─ 🍕 Pizza');
            console.log('');
            console.log('   Chia Network (7 tokens):');
            console.log('   ├─ XCH (Native)');
            console.log('   ├─ ✨🧙 Caster');
            console.log('   ├─ ⚡️🪄 Spellpower');
            console.log('   ├─ 🧙💸 Wizard Bucks');
            console.log('   ├─ ❤️ Love');
            console.log('   ├─ 🌱 Sprout');
            console.log('   └─ 🍕 Pizza');
            console.log('%c═══════════════════════════════════════════', 'color: #fbbf24;');
            console.log('');
            console.log('%c⏳ Starting data fetch...', 'color: #a855f7;');
            console.log('');
            
            initBackground();

            // Start fetching live data
            updateData();

            document.getElementById('visitorCount').textContent = '133,769';
            setInterval(updateVisitorCount, Math.random() * 5000 + 5000);

            // Auto refresh every 60s
            setInterval(updateData, 60000);
        };
    </script>

    <script src="https://open.spotify.com/embed/iframe-api/v1" async></script>
    <script>
        (function() {
            const albums = [
                { uri: 'spotify:album:0EMrZkL3qXmiwcHVTgmAiO', label: 'Album A' },
                { uri: 'spotify:album:0CwFHInuT37IygomIdyrul', label: 'Album B' },
            ];

            const ui = {
                container: document.getElementById('spotify-miniplayer'),
                album: document.getElementById('spotify-mini-album'),
                open: document.getElementById('spotify-mini-open'),
                close: document.getElementById('spotify-mini-close'),
                play: document.getElementById('spotify-mini-play'),
                prev: document.getElementById('spotify-mini-prev'),
                next: document.getElementById('spotify-mini-next'),
                shuffle: document.getElementById('spotify-mini-shuffle'),
            };

            let controller = null;
            let currentIndex = 0;
            let isPaused = true;

            const pickRandomIndex = (exclude) => {
                if (albums.length <= 1) return 0;
                let idx = Math.floor(Math.random() * albums.length);
                if (idx === exclude) idx = (idx + 1) % albums.length;
                return idx;
            };

            const updateAlbumUI = () => {
                const current = albums[currentIndex];
                if (ui.album) ui.album.textContent = current.label;
                if (ui.open) ui.open.href = `https://open.spotify.com/album/${current.uri.split(':')[2]}`;
            };

            const loadAlbum = (index, autoplay) => {
                currentIndex = index;
                updateAlbumUI();
                if (controller) {
                    controller.loadUri(albums[currentIndex].uri);
                    if (autoplay) {
                        setTimeout(() => {
                            if (isPaused) controller.togglePlay();
                        }, 300);
                    }
                }
            };

            const updatePlayButton = () => {
                if (!ui.play) return;
                ui.play.textContent = isPaused ? '▶' : '⏸';
            };

            if (ui.close && ui.container) {
                ui.close.addEventListener('click', () => {
                    ui.container.style.display = 'none';
                    if (controller && !isPaused) controller.togglePlay();
                });
            }

            if (ui.play) {
                ui.play.addEventListener('click', () => {
                    if (controller) controller.togglePlay();
                });
            }

            if (ui.prev) {
                ui.prev.addEventListener('click', () => {
                    if (controller) controller.previous();
                });
            }

            if (ui.next) {
                ui.next.addEventListener('click', () => {
                    if (controller) controller.next();
                });
            }

            if (ui.shuffle) {
                ui.shuffle.addEventListener('click', () => {
                    const nextIndex = pickRandomIndex(currentIndex);
                    loadAlbum(nextIndex, true);
                });
            }

            window.onSpotifyIframeApiReady = (IFrameAPI) => {
                const element = document.getElementById('spotify-embed');
                if (!element) return;

                currentIndex = pickRandomIndex(-1);
                updateAlbumUI();

                IFrameAPI.createController(element, {
                    uri: albums[currentIndex].uri,
                    width: '100%',
                    height: 152,
                    theme: 'dark'
                }, (ctrl) => {
                    controller = ctrl;

                    ctrl.addListener('playback_update', (e) => {
                        if (e && e.data) {
                            isPaused = !!e.data.isPaused;
                            updatePlayButton();
                        }
                    });

                    ctrl.addListener('ready', () => {
                        updatePlayButton();
                    });
                });
            };
        })();
    </script>

    <!-- COMPREHENSIVE TREASURY & MARKET LOADER -->
    <script>
// =================================================================
// COMPREHENSIVE FIXED JAVASCRIPT - ALL FEATURES WORKING
// =================================================================

// Treasury addresses
const BASE_TREASURY = '0x8d8cb6D19E32115823Cf0008701A84fB07F43467';
const CHIA_TREASURY = 'xch10na8nqys9afs0fl74vvd6xl3akgu77p8mvjsp2ywy7rhq2s0jqys3nf7dl';

// User's Base address for bag tracker
let USER_BASE_ADDRESS = '0x8d8cb6D19E32115823Cf0008701A84fB07F43467'; // Default to treasury

// Token definitions handled in main script block above

// =================================================================
// 2. BAG TRACKER - ACTUALLY WORKS NOW
// =================================================================

// loadBagTracker is now handled by trackAddress/renderBagResults above

// =================================================================
// 3. TREASURY - ACCURATE & SLEEK
// =================================================================// =================================================================
// 3. TREASURY - ACCURATE & SLEEK
// =================================================================

// Merge two Base token arrays — sum balance+value for same contract, keep price/type
function mergeBaseTokens(arr1, arr2) {
    const map = new Map();
    for (const t of [...arr1, ...arr2]) {
        const key = (t.address || t.symbol || '').toLowerCase();
        if (map.has(key)) {
            const existing = map.get(key);
            existing.balance = (existing.balance || 0) + (t.balance || 0);
            existing.value   = (existing.value   || 0) + (t.value   || 0);
            // LP-specific fields
            if (t.type === 'lp') {
                existing.totalLiqUsd = (existing.totalLiqUsd || 0) + (t.totalLiqUsd || 0);
                // userSharePct only makes sense per-wallet, keep both as separate entries
                // Actually safest: LP positions are per-wallet, don't merge them
            }
        } else {
            map.set(key, { ...t });
        }
    }
    return Array.from(map.values());
}

function mergeChiaTokens(arr1, arr2) {
    // Merge two Chia token arrays — sum balances by assetId (or 'XCH' for native)
    const map = new Map();
    for (const t of [...arr1, ...arr2]) {
        const key = t.assetId || t.symbol || 'XCH';
        if (!map.has(key)) {
            map.set(key, { ...t });
        } else {
            const ex = map.get(key);
            ex.balance = (ex.balance || 0) + (t.balance || 0);
            ex.value   = (ex.value   || 0) + (t.value   || 0);
            // keep whichever price is non-zero
            if (!ex.price && t.price) ex.price = t.price;
        }
    }
    return Array.from(map.values());
}

function mergeChiaNFTs(cols1, cols2) {
    // Merge two NFT collection arrays — sum counts by collection id
    const map = new Map();
    for (const col of [...cols1, ...cols2]) {
        const key = col.id || col.name || 'uncategorized';
        if (!map.has(key)) {
            map.set(key, { ...col, nfts: [...(col.nfts || [])] });
        } else {
            const ex = map.get(key);
            ex.count = (ex.count || 0) + (col.count || 0);
            // keep first found image if we don't have one yet
            if (!ex.image && col.image) ex.image = col.image;
            if (ex.nfts.length < 1 && col.nfts?.length > 0) ex.nfts.push(col.nfts[0]);
        }
    }
    return Array.from(map.values()).sort((a, b) => b.count - a.count);
}


async function forceChiaRefresh() {
    // Clear the unified Chia cache then reload treasury
    try {
        localStorage.removeItem('awiz_chia_treasury_v3');
        localStorage.removeItem('awiz_chia_wallets_v3');
        localStorage.removeItem('awizard_chia_tokens_v2');
        localStorage.removeItem('awizard_chia_tokens_v3');
        localStorage.removeItem('awizard_chia_tokens_v6');
        localStorage.removeItem('awizard_chia_tokens_v7');
        localStorage.removeItem('awizard_cat_prices_v1'); // also clear emoji market price cache
    } catch {}
    _treasuryLastLoad = 0; // reset cooldown so it can reload immediately
    return loadComprehensiveTreasury(true);
}

let _treasuryLastLoad = 0;
let isRefreshingChiaTreasury = false;
async function loadComprehensiveTreasury(force = false) {
    const now = Date.now();
    if (!force && now - _treasuryLastLoad < 600000) {
        console.log(`⏳ Treasury loaded ${Math.round((now - _treasuryLastLoad)/1000)}s ago, using cache (expires in ${Math.round((600000 - (now - _treasuryLastLoad))/1000)}s)`);
        return;
    }
    _treasuryLastLoad = now;
    const BASE_WALLET_1 = '0x8d8cb6D19E32115823Cf0008701A84fB07F43467';
    const BASE_WALLET_2 = '0xEEDC069F861880eC1B5f41c9bC7a747DC1cE32b9';
    const CHIA_WALLET_1 = 'xch10na8nqys9afs0fl74vvd6xl3akgu77p8mvjsp2ywy7rhq2s0jqys3nf7dl';
    const CHIA_WALLET_2 = 'xch1g477lha2wjjq9634kgqmryf4gplft9cjgv2vd29tq3ya26glwlkqp6pyex';
    const CHIA_WALLET_3 = 'xch1el40ydk4v2ccdq2l8d28wvr8hnndar0xywfgqel36f85ps8gj9jqfrm64j';

    console.log('💰 Loading treasury — 2 Base wallets + 3 Chia wallets...');
    console.log(`   Base #1: ${BASE_WALLET_1}`);
    console.log(`   Base #2: ${BASE_WALLET_2}`);
    console.log(`   Chia #1: ${CHIA_WALLET_1}`);
    console.log(`   Chia #2: ${CHIA_WALLET_2}`);
    console.log(`   Chia #3: ${CHIA_WALLET_3}`);
    
    // Show loading state
    document.getElementById('portfolio-grand-total').textContent = 'Loading...';
    document.getElementById('base-network-total').textContent = 'Loading...';
    document.getElementById('chia-network-total').textContent = 'Loading...';
    
    try {
        // Fetch all three wallets — Base two in parallel, Chia sequential after
        console.log('📡 Fetching both Base wallets in parallel...');
        const [base1Resp, base2Resp] = await Promise.all([
            fetch(`/api/treasury-comprehensive?address=${BASE_WALLET_1}&chain=base`),
            fetch(`/api/treasury-comprehensive?address=${BASE_WALLET_2}&chain=base`)
        ]);
        const [base1Data, base2Data] = await Promise.all([base1Resp.json(), base2Resp.json()]);
        console.log(`✅ Base #1: $${(base1Data.total||0).toFixed(2)}, ${base1Data.tokens?.length||0} tokens`);
        console.log(`✅ Base #2: $${(base2Data.total||0).toFixed(2)}, ${base2Data.tokens?.length||0} tokens`);
        if (base1Data.error) console.warn('⚠️ Base #1 error:', base1Data.error);
        if (base2Data.error) console.warn('⚠️ Base #2 error:', base2Data.error);

        // Merge Base data — LP positions stay separate (unique per wallet), tokens merged by contract
        const lpTokens1 = (base1Data.tokens || []).filter(t => t.type === 'lp');
        const lpTokens2 = (base2Data.tokens || []).filter(t => t.type === 'lp');
        const reg1 = (base1Data.tokens || []).filter(t => t.type !== 'lp');
        const reg2 = (base2Data.tokens || []).filter(t => t.type !== 'lp');
        const mergedTokens = [
            ...mergeBaseTokens(reg1, reg2),   // regular tokens summed by contract
            ...lpTokens1, ...lpTokens2         // LP positions kept separate
        ];
        const baseData = {
            tokens: mergedTokens,
            total: (base1Data.total || 0) + (base2Data.total || 0),
            wallets: [BASE_WALLET_1, BASE_WALLET_2]
        };
        console.log(`✅ Base combined: $${baseData.total.toFixed(2)}, ${baseData.tokens.length} tokens (${lpTokens1.length+lpTokens2.length} LPs)`);

        // ── Chia: 100% Browser-Direct — ALL CALLS FIRE SIMULTANEOUSLY ───────────────
        // Fire all 11 requests at once upfront so token-balance is in-flight BEFORE
        // any rate limiting kicks in. Fast calls resolve in ~2s (render XCH+NFTs).
        // Slow token-balance W0 resolves in ~16s → update tokens when ready.

        const CHIA_WALLETS = [
            'xch10na8nqys9afs0fl74vvd6xl3akgu77p8mvjsp2ywy7rhq2s0jqys3nf7dl',
            'xch1g477lha2wjjq9634kgqmryf4gplft9cjgv2vd29tq3ya26glwlkqp6pyex',
            'xch1el40ydk4v2ccdq2l8d28wvr8hnndar0xywfgqel36f85ps8gj9jqfrm64j',
        ];

        const CHIA_TOKEN_OVERRIDES = {
            'a09af8b0d12b27772c64f89cf0d1db95186dca5b1871babc5108ff44f36305e6': { name: 'Caster', symbol: '✨❤️‍🔥🧙‍♂️' },
            'eb2155a177b6060535dd8e72e98ddb0c77aea21fab53737de1c1ced3cb38e4c4': { name: 'Spellpower', symbol: '⚡️🪄' },
            'ae1536f56760e471ad85ead45f00d680ff9cca73b8cc3407be778f1c0c606eac': { name: 'Bytecash', symbol: '💸' },
            '70010d83542594dd44314efbae75d82b3d9ae7d946921ed981a6cd08f0549e50': { name: 'Love', symbol: '❤️' },
            'ab558b1b841365a24d1ff2264c55982e55664a8b6e45bc107446b7e667bb463b': { name: 'Sprout', symbol: '🌱' },
            'dd37f678dda586fad9b1daeae1f7c5c137ffa6d947e1ed5c7b4f3c430da80638': { name: 'Pizza', symbol: '🍕' },
        };

        let mergedChiaTokens = [], mergedChiaTotal = 0, mergedNFTCols = [], mergedNFTCount = 0;
        let chiaXchPrice = window._chiaXchPrice || 2.80;
        let chiaTreasuryCacheAge = 0; // Track cache age for display
        let isRefreshingChiaTreasury = false; // Prevent multiple simultaneous refreshes

        // Helper: format cache age for display
        function formatCacheAge(ms) {
            const sec = Math.floor(ms / 1000);
            if (sec < 60) return sec + 's ago';
            const min = Math.floor(sec / 60);
            if (min < 60) return min + 'm ago';
            const hr = Math.floor(min / 60);
            if (hr < 24) return hr + 'h ago';
            const days = Math.floor(hr / 24);
            return days + 'd ago';
        }

        // Update last updated timestamp display
        function updateChiaTimestamp(age) {
            const el = document.getElementById('chia-last-updated');
            if (el && age !== undefined) {
                el.textContent = age === 0 ? 'Just updated' : `Updated ${formatCacheAge(age)}`;
            }
        }

        // ── Helper: fetch with abort timeout ─────────────────────────────────────
        // ── LOAD CHIA TREASURY: Direct browser calls ──────────────────────────────
        // XCH balance from xchscan (no rate limits)
        // Tokens + NFTs from Spacescan via spacescanQueue (browser IPs work)
        // localStorage cache: serve stale data instantly, refresh in background
        async function loadChiaTreasury(useCache = true) {
            window._chiaLastFromCache = false;
            const CACHE_KEY = 'awiz_chia_treasury_v3';
            const CACHE_KEY_WALLETS = 'awiz_chia_wallets_v3';
            const CACHE_TTL = 3 * 60 * 60 * 1000; // 3 hour auto-refresh
            const STALE_TTL = 7 * 24 * 60 * 60 * 1000; // 7 days max stale

            // ALWAYS try cache first for instant display
            let cached = null;
            let cacheAge = 0;
            let shouldRefresh = false;
            
            if (useCache) {
                try {
                    const raw = localStorage.getItem(CACHE_KEY);
                    if (raw) {
                        const parsed = JSON.parse(raw);
                        cacheAge = Date.now() - (parsed.ts || 0);
                        if (parsed.ts && cacheAge < STALE_TTL && parsed.data && parsed.data.length > 0) {
                            console.log('⚡ Treasury snapshot loaded (' + formatCacheAge(cacheAge) + ')');
                            cached = parsed.data;
                            chiaTreasuryCacheAge = cacheAge; // Store for display
                            updateChiaTimestamp(cacheAge);
                            
                            // Show cache status in UI
                            const statusEl = document.getElementById('chia-cache-status');
                            if (statusEl) {
                                statusEl.textContent = 'Snapshot from Spacescan (' + formatCacheAge(cacheAge) + ')';
                            }
                            
                            // Return cached IMMEDIATELY - don't wait for refresh
                            // Determine if we should refresh in background
                            shouldRefresh = cacheAge > CACHE_TTL;
                            
                            const hasNonXchAssets = cached.some(w => (w.tokens?.length || 0) > 0 || (w.nfts?.length || 0) > 0);
                            if (!hasNonXchAssets) {
                                console.warn('⚠️ Snapshot has no CATs/NFTs, refreshing from Spacescan');
                                shouldRefresh = true;
                            }

                            if (!shouldRefresh) {
                                console.log('✅ Snapshot is fresh (<3h), using it');
                                window._chiaLastFromCache = true;
                                return cached;
                            } else {
                                console.log('⌛ Snapshot is old (>3h), refreshing from Spacescan');
                                // Continue to fetch fresh data; fall back to cached if fetch fails
                            }
                        }
                    }
                } catch(e) { 
                    console.warn('Cache read error:', e); 
                }
            }

            try {
                const [xchData, tibetRaw] = await Promise.all([
                    fetch('https://api.coingecko.com/api/v3/simple/price?ids=chia&vs_currencies=usd', { cache: 'no-store' })
                        .then(r => r.ok ? r.json() : {}).catch(() => ({})),
                    fetch('https://api.v2.tibetswap.io/pairs?per_page=200')
                        .then(r => r.ok ? r.json() : []).catch(() => []),
                ]);

                let xchPrice = xchData?.chia?.usd || 0;
                const tibetArr = Array.isArray(tibetRaw) ? tibetRaw : (tibetRaw.results || tibetRaw.pairs || []);
                if (!xchPrice && tibetArr.length > 0) {
                    const xchUsdPair = tibetArr.find(p => (p.short_name || '').toLowerCase().includes('xch-usd'));
                    if (xchUsdPair) {
                        const xr = parseFloat(xchUsdPair.xch_reserve || 0) / 1e12;
                        const ar = parseFloat(xchUsdPair.asset_reserve || 1) / 1e3;
                        xchPrice = ar > 0 ? xr / ar : 0;
                    }
                }
                if (!xchPrice || xchPrice <= 0) xchPrice = 2.8;
                chiaXchPrice = xchPrice;
                window._chiaXchPrice = xchPrice;

                const tibetMap = {};
                for (const pair of tibetArr) {
                    const aid = (pair.asset_id || '').toLowerCase();
                    if (!aid) continue;
                    const xchRes = parseFloat(pair.xch_reserve || 0) / 1e12;
                    const catRes = parseFloat(pair.asset_reserve || 0) / 1e3;
                    const priceUsd = catRes > 0 ? (xchRes / catRes) * xchPrice : 0;
                    tibetMap[aid] = {
                        priceUsd,
                        short_name: pair.short_name || '',
                        name: pair.name || ''
                    };
                }

                const fetchSpacescanWithFallback = async (endpoint, wallet, timeout) => {
                    // Direct browser calls using rate-limited queue
                    const url = `https://api.spacescan.io/address/${endpoint}/${wallet}`;
                    const data = await spacescanFetch(url, timeout || 20000, 1);
                    return data || null;
                };

                // Load per-wallet cache for progressive display
                const walletCacheMap = new Map();
                try {
                    const wcRaw = localStorage.getItem(CACHE_KEY_WALLETS);
                    if (wcRaw) {
                        const wc = JSON.parse(wcRaw);
                        for (const [wallet, data] of Object.entries(wc)) {
                            if (data.ts && Date.now() - data.ts < STALE_TTL) {
                                walletCacheMap.set(wallet, data.value);
                            }
                        }
                    }
                } catch(e) { console.warn('Per-wallet cache read error:', e); }

                // Fetch XCH balances from xchscan in parallel (fast, no rate limit)
                console.log('📡 Fetching Chia treasury (xchscan + Spacescan browser)...');
                const balanceResults = await Promise.allSettled(
                    CHIA_WALLETS.map(w =>
                        fetch(`https://xchscan.com/api/account/balance?address=${w}`, { cache: 'no-store' })
                            .then(r => r.ok ? r.json() : {})
                            .then(d => parseFloat(d?.xch || 0))
                            .catch(() => 0)
                    )
                );
                console.log('  ✅ XCH balances:', balanceResults.map((r,i) => 
                    CHIA_WALLETS[i].slice(-8) + '=' + (r.status === 'fulfilled' ? r.value.toFixed(4) : 'ERR')
                ));

                // Fetch tokens + NFTs from Spacescan via queue (sequential, 2s gaps)
                const results = [];
                const walletCacheUpdate = {};
                for (let idx = 0; idx < CHIA_WALLETS.length; idx++) {
                    const wallet = CHIA_WALLETS[idx];
                    const xchBalResult = balanceResults[idx];
                    const xchBal = xchBalResult.status === 'fulfilled' ? xchBalResult.value : 0;
                    let tokens = [], nfts = [];

                    // Use cached wallet data if fresh fetch fails
                    const walletCache = walletCacheMap.get(wallet);

                    // Tokens
                    try {
                        const tokData = await fetchSpacescanWithFallback('token-balance', wallet, 20000);
                        if (tokData?.data) {
                            tokens = tokData.data
                                .filter(t => parseFloat(t.balance || 0) > 0)
                                .map(t => {
                                    const aid = (t.asset_id || '').toLowerCase();
                                    const override = CHIA_TOKEN_OVERRIDES[aid];
                                    const tibet = tibetMap[aid] || null;
                                    let name = (t.name || t.symbol || '').trim();
                                    if (override?.name) name = override.name;
                                    if (!name || name.toLowerCase() === 'cat') name = tibet?.name || tibet?.short_name || name;
                                    if (!name) name = `Token ${aid.slice(0, 6).toUpperCase()}`;

                                    let symbol = (t.symbol || '').trim();
                                    if (override?.symbol) symbol = override.symbol;
                                    if (!symbol || symbol.toLowerCase() === 'cat') symbol = tibet?.short_name || name;

                                    const balance = parseFloat(t.balance || 0);
                                    const priceRaw = parseFloat(t.price || 0);
                                    const price = priceRaw > 0 ? priceRaw : (tibet?.priceUsd || 0);
                                    const rawValue = parseFloat(t.total_value || 0);
                                    const totalValue = rawValue > 0 ? rawValue : (price > 0 ? balance * price : 0);

                                    return {
                                        asset_id: t.asset_id || '',
                                        name,
                                        symbol,
                                        balance,
                                        price,
                                        total_value: totalValue
                                    };
                                });
                        } else if (walletCache?.tokens) {
                            console.log(`  ⚠️ Using cached tokens for ${wallet.slice(-8)}`);
                            tokens = walletCache.tokens;
                        }
                    } catch(e) {
                        console.warn(`Token fetch error for ${wallet.slice(-8)}:`, e.message);
                        if (walletCache?.tokens) {
                            console.log(`  💾 Using cached tokens for ${wallet.slice(-8)}`);
                            tokens = walletCache.tokens;
                        }
                    }
                    // NFTs
                    try {
                        const nftData = await fetchSpacescanWithFallback('nft-balance', wallet, 15000);
                        if (nftData?.balance) {
                            nfts = nftData.balance.map(n => ({
                                nft_id: n.nft_id || '', name: n.name || '',
                                collection_id: n.collection_id || '', preview_url: n.preview_url || ''
                            }));
                        } else if (walletCache?.nfts) {
                            console.log(`  ⚠️ Using cached NFTs for ${wallet.slice(-8)}`);
                            nfts = walletCache.nfts;
                        }
                    } catch(e) {
                        console.warn(`NFT fetch error for ${wallet.slice(-8)}:`, e.message);
                        if (walletCache?.nfts) {
                            console.log(`  💾 Using cached NFTs for ${wallet.slice(-8)}`);
                            nfts = walletCache.nfts;
                        }
                    }

                    console.log(`  ✅ ${wallet.slice(-8)}: ${xchBal.toFixed(4)} XCH, ${nfts.length} NFTs, ${tokens.length} tokens`);

                    // Store per-wallet cache
                    walletCacheUpdate[wallet] = {
                        ts: Date.now(),
                        value: { tokens: tokens.map(t => ({ ...t })), nfts: [...nfts] }
                    };

                    results.push({
                        idx, wallet, xchBal, nfts,
                        tokens: tokens.map(t => {
                            const aid = (t.asset_id || '').toLowerCase();
                            const tibetEntry = tibetMap[aid] || null;
                            // Enhanced name resolution: use name → symbol → readable fallback
                            let name = (t.name || t.symbol || '').trim();
                            if (!name) name = `Token ${(t.asset_id || '').slice(0,6).toUpperCase()}`;
                            
                            // Ensure symbol has a fallback (never empty)
                            const symbol = (t.symbol || name.slice(0,8) || (t.asset_id || '').slice(0,8) || 'CAT');
                            
                            const isLP = name.toLowerCase().includes('tibet') || name.toLowerCase().includes(' lp ') || (tibetEntry?.short_name || '').toLowerCase().startsWith('tibet-');
                            const balance = t.balance;
                            const price = t.price;
                            const rawVal = t.total_value > 0 ? t.total_value : (balance * price);
                            // LP tokens: use actual value from Spacescan (no doubling)
                            const value = rawVal;
                            // LP pair name: "TibetSwap LP LOVE-XCH" → "LOVE/XCH"
                            let pairName = '';
                            if (isLP) {
                                const m = name.match(/LP\s+(.+?)(?:\s*$)/i);
                                if (m) pairName = m[1].replace(/-/g, '/');
                                if (!pairName && tibetEntry?.short_name) {
                                    pairName = tibetEntry.short_name.replace(/^TIBET-/i, '').replace(/-XCH$/i, '/XCH');
                                }
                            }
                            const tok = {
                                symbol, name, assetId: t.asset_id,
                                balance, price, value,
                                type: isLP ? 'lp' : 'cat', image: ''
                            };
                            if (pairName) tok.pairName = pairName;
                            return tok;
                        })
                    });
                }

                // Cache the fresh data (both full and per-wallet) with extended TTL
                try { 
                    const cacheData = { ts: Date.now(), data: results };
                    localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData)); 
                    localStorage.setItem(CACHE_KEY_WALLETS, JSON.stringify(walletCacheUpdate));
                    chiaTreasuryCacheAge = 0; // Fresh data
                    console.log('💾 Treasury snapshot saved (auto-refresh every 3h)');
                    updateChiaTimestamp(0);
                    
                    // Update cache status in UI
                    const statusEl = document.getElementById('chia-cache-status');
                    if (statusEl) {
                        statusEl.textContent = 'Data refreshed from Spacescan';
                    }
                } catch(e) { 
                    console.warn('Cache write error:', e);
                    // Try to clear old cache if write failed due to quota
                    try {
                        const oldKeys = ['awiz_chia_treasury_v1', 'awiz_chia_treasury_v2', 'awiz_chia_wallets_v1', 'awiz_chia_wallets_v2'];
                        oldKeys.forEach(k => localStorage.removeItem(k));
                        localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), data: results }));
                        console.log('💾 Cleared old cache, retry successful');
                    } catch(e2) {
                        console.error('Failed to save cache even after cleanup:', e2);
                    }
                }

                return results;

            } catch (error) {
                console.error('Error fetching Chia treasury:', error.message, error.stack);
                // ALWAYS return fallback cache if available
                if (cached && cached.length > 0) { 
                    console.log('⚡ Using fallback cache due to fetch error'); 
                    return cached; 
                }
                // Try to reset queue if stuck
                spacescanQueue.reset();
                console.error('❌ No cached data available and fetch failed');
                return [];
            }
        }

        // ── Helper: build token list from token-balance response ──────────────────
        const buildChiaTokens = (raw, tibetMap, lpSet, pairMap) =>
            (raw?.data || []).filter(t => parseFloat(t.balance||0) > 0).map(t => {
                const aid  = (t.asset_id||'').toLowerCase();
                // Enhanced name resolution: Spacescan → TibetSwap → symbol → readable fallback
                let name = (t.name||t.symbol||'').trim();
                if (!name && tibetMap[aid]) name = tibetMap[aid].name || tibetMap[aid].short_name || '';
                if (!name) name = t.symbol || '';
                // Use a more readable fallback if still empty (first 6 chars + asset type marker)
                if (!name) name = `Token ${aid.slice(0,6).toUpperCase()}`;
                
                const sym  = t.symbol || name.slice(0,8) || aid.slice(0,8);
                const lnam = name.toLowerCase();
                const lsym = (tibetMap[aid]?.short_name||'').toLowerCase();
                const isLP = lpSet.has(aid) || lnam.toLowerCase().includes('tibet') || lnam.includes(' lp ') || lsym.startsWith('tibet-');
                const price   = parseFloat(t.price||0);
                const balance = parseFloat(t.balance||0);
                const totVal  = parseFloat(t.total_value||0);
                const value   = isLP ? (totVal>0 ? totVal : balance*price)
                                     : (price>0&&balance>0 ? balance*price : totVal);
                const tok = { symbol: sym, name, assetId: t.asset_id||aid, balance, price, value,
                    type: isLP?'lp':'cat', image: t.preview_url||'' };
                if (isLP) {
                    let pn = pairMap[aid] || '';
                    if (!pn && tibetMap[aid]?.short_name) pn = tibetMap[aid].short_name.replace(/^TIBET-/i,'').replace(/-XCH$/i,'/XCH');
                    if (pn) tok.pairName = pn;
                }
                return tok;
            });

        // ── Helper: merge tokens into tMap ────────────────────────────────────────
        const mergeIntoTMap = (tMap, tokens) => {
            for (const t of tokens) {
                const k = t.assetId || t.symbol;
                if (!tMap.has(k)) tMap.set(k, {...t});
                else { const ex=tMap.get(k); ex.balance=(ex.balance||0)+(t.balance||0); ex.value=(ex.value||0)+(t.value||0); }
            }
        };

        // ── Helper: build NFT collection map from flat NFT list ───────────────────
        const buildNFTCols = (allNFTs) => {
            const colMap = {};
            for (const nft of allNFTs) {
                const cid = nft.collection_id; if (!cid) continue;
                if (!colMap[cid]) {
                    const raw = (nft.name||'').trim();
                    colMap[cid] = { colId:cid, id:cid, name: raw.replace(/\s+#\d+[\w\s]*$/,'').trim()||raw||'…', image:nft.preview_url||'', count:0, floor_xch:0 };
                }
                colMap[cid].count++;
                if (!colMap[cid].image && nft.preview_url) colMap[cid].image = nft.preview_url;
            }
            return colMap;
        };
        // ── Show loading placeholder ───────────────────────────────────────────────
        const chiaList = document.getElementById('chia-holdings-list');
        if (chiaList) chiaList.innerHTML = `<div style="text-align:center;padding:40px 20px;color:rgba(255,255,255,0.4);font-size:12px;">
            <div style="font-size:24px;margin-bottom:8px;">⏳</div>
            <div>Loading treasury snapshot…</div>
            <div id="chia-cache-status" style="font-size:11px;margin-top:8px;opacity:0.5;">Loading Spacescan data...</div>
        </div>`;

        // ── CALL CHIA-CAT-PRICES LAMBDA (treasury mode) ──────────────────────────
        console.log('📡 Calling chia-cat-prices Lambda (treasury mode)...');
        
        const chiaWalletsData = await loadChiaTreasury(!force);
        const usedChiaCache = !!window._chiaLastFromCache && !force;
        
        if (!chiaWalletsData || chiaWalletsData.length === 0) {
            console.error('❌ Failed to load Chia treasury (no snapshot available)');
            if (chiaList) {
                chiaList.innerHTML = `<div style="text-align:center;padding:40px 20px;color:rgba(255,100,100,0.8);font-size:14px;">
                    <div style="font-size:32px;margin-bottom:12px;">⚠️</div>
                    <div style="font-weight:bold;margin-bottom:8px;">No Treasury Data Available</div>
                    <div style="font-size:11px;opacity:0.6;">Spacescan API unavailable and no cached snapshot. Click Refresh to try again.</div>
                </div>`;
            }
            updateChiaTimestamp(undefined);
            mergedChiaTokens = [];
            mergedChiaTotal = 0;
            mergedNFTCols = [];
            mergedNFTCount = 0;
            const chiaData = { tokens: [], total: 0, xchPrice: chiaXchPrice };
            const nftData = { collections: [], totalNFTs: 0, totalValue: 0, totalXch: 0, totalCollections: 0 };
            updateTreasuryDisplay(baseData, chiaData, nftData);
            return;
        }

        const renderChiaTreasury = (wallets) => {
            console.log(`✅ chia-all returned ${wallets.length} wallets`);

            // Build token map and NFT collections from wallet response
            const tMap = new Map();
            const allNFTs = [];
            let colMap = {};

            for (let i = 0; i < wallets.length; i++) {
                const w = wallets[i];
                console.log(`✅ W${i}: ${w.xchBal.toFixed(4)} XCH, ${w.nfts.length} NFTs, ${w.tokens.length} tokens`);

                // Add XCH balance
                if (w.xchBal > 0) {
                    if (!tMap.has('XCH_NATIVE')) {
                        tMap.set('XCH_NATIVE', {
                            symbol: 'XCH',
                            name: 'Chia',
                            assetId: 'XCH_NATIVE',
                            balance: 0,
                            price: chiaXchPrice,
                            value: 0,
                            type: 'native',
                            image: ''
                        });
                    }
                    const xchToken = tMap.get('XCH_NATIVE');
                    xchToken.balance += w.xchBal;
                    xchToken.value += w.xchBal * chiaXchPrice;
                }

                // Add CAT/LP tokens
                for (const tok of w.tokens) {
                    const key = tok.assetId || tok.symbol;
                    if (tMap.has(key)) {
                        const existing = tMap.get(key);
                        existing.balance += tok.balance;
                        existing.value += tok.value;
                    } else {
                        tMap.set(key, { ...tok });
                    }
                }

                // Collect NFTs
                allNFTs.push(...w.nfts);
            }

            // Build NFT collections
            mergedNFTCount = allNFTs.length;
            if (mergedNFTCount > 0) {
                colMap = buildNFTCols(allNFTs);
                mergedNFTCols = Object.values(colMap).sort((a, b) => b.count - a.count);
                nftsLoaded = true;
                console.log(`✅ NFTs: ${mergedNFTCount} in ${mergedNFTCols.length} collections`);
            }

            // Render everything
            mergedChiaTokens = Array.from(tMap.values());
            mergedChiaTotal = mergedChiaTokens.reduce((s, t) => s + (t.value || 0), 0);
            console.log(`✅ Chia treasury loaded: ${mergedChiaTokens.length} tokens, $${mergedChiaTotal.toFixed(2)}, ${mergedNFTCount} NFTs`);

            const cacheAgeEl = document.getElementById('chia-cache-age');
            if (cacheAgeEl) cacheAgeEl.style.display = 'none';

            const chiaData = { tokens: mergedChiaTokens, total: mergedChiaTotal, xchPrice: chiaXchPrice };
            const nftData = { collections: mergedNFTCols, totalNFTs: mergedNFTCount, totalValue: 0, totalXch: 0, totalCollections: mergedNFTCols.length };
            window._chiaNFTData = nftData;
            window._chiaXchPrice = chiaXchPrice;

            // Cache the treasury data for quick restoration when switching tabs
            _treasuryCache.baseData = baseData;
            _treasuryCache.chiaData = chiaData;
            _treasuryCache.nftData = nftData;
            _treasuryCache.timestamp = Date.now();
            console.log('💾 Treasury data cached for tab switching');

            updateTreasuryDisplay(baseData, chiaData, nftData);
            console.log('✅ Treasury display updated');

            // ── Background: MintGarden enrichment for NFT collection names ────────────
            if (mergedNFTCount > 0) {
                const allColIds = Object.keys(colMap);
                (async () => {
                    try {
                        const ctrl = new AbortController();
                        setTimeout(() => ctrl.abort(), 25000);
                        const colResp = await fetch('/api/chia-collections', {
                            method: 'POST', headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({ colIds: allColIds }), signal: ctrl.signal,
                        });
                        if (colResp.ok) {
                            const mgMap = (await colResp.json()).collections || {};
                            let enriched = 0;
                            for (const cid of allColIds) {
                                const mg = mgMap[cid]; if (!mg) continue;
                                if (mg.name)      colMap[cid].name      = mg.name;
                                if (mg.thumbnail) colMap[cid].image     = mg.thumbnail;
                                colMap[cid].floor_xch = mg.floor_xch || 0;
                                enriched++;
                            }
                            mergedNFTCols = Object.values(colMap).sort((a,b)=>b.count-a.count);
                            console.log(`✅ MintGarden: enriched ${enriched}/${allColIds.length} collections`);
                            const enrichedNFTData = {collections:mergedNFTCols, totalNFTs:mergedNFTCount, totalValue:0, totalXch:0, totalCollections:mergedNFTCols.length};
                            window._chiaNFTData = enrichedNFTData;
                            updateNFTGallery(enrichedNFTData);
                        }
                    } catch(e) { console.warn('⚠️ MintGarden enrichment skipped:', e.message); }
                })();
            }
        };

        renderChiaTreasury(chiaWalletsData);

        if (usedChiaCache) {
            loadChiaTreasury(false).then((freshWallets) => {
                if (freshWallets && freshWallets.length > 0) {
                    console.log('🔁 Refreshing Chia treasury with live data');
                    renderChiaTreasury(freshWallets);
                }
            }).catch((e) => console.warn('⚠️ Live Chia refresh failed:', e.message));
        }
        
    } catch (error) {
        console.error('❌ Treasury error:', error.message);
        document.getElementById('base-network-total').textContent = 'Error';
        document.getElementById('chia-network-total').textContent = 'Error';
        
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'text-align: center; padding: 40px; color: #ef4444; background: rgba(239,68,68,0.1); border: 2px solid rgba(239,68,68,0.3); border-radius: 12px; margin: 20px;';
        errorDiv.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
            <div style="font-size: 20px; font-weight: 700; margin-bottom: 8px;">Treasury Loading Failed</div>
            <div style="font-size: 14px; opacity: 0.8;">${error.message}</div>
            <div style="margin-top: 16px; font-size: 12px; opacity: 0.6;">Check console (F12) for details</div>
        `;
        const cont = document.querySelector('#treasury');
        if (cont) cont.prepend(errorDiv);
    }
}

function updateTreasuryDisplay(baseData, chiaData, nftData) {
    console.log('📊 Updating treasury display...');

    // Store NFT data globally so the NFT tab can use it without a second Lambda call
    if (nftData && nftData.collections && nftData.collections.length > 0) {
        window._chiaNFTData  = nftData;
        window._chiaXchPrice = chiaData?.xchPrice || 4;
    }
    
    const baseTotal = baseData?.total || 0;
    const chiaTotal = chiaData?.total || 0;
    const grandTotal = baseTotal + chiaTotal;
    
    console.log('   Calculated totals:', { baseTotal, chiaTotal, grandTotal });
    
    // Update header totals
    const grandTotalEl = document.getElementById('portfolio-grand-total');
    if (grandTotalEl) {
        grandTotalEl.textContent = `$${grandTotal.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        })}`;
        console.log('   ✅ Updated grand total');
    } else {
        console.error('   ❌ portfolio-grand-total element not found');
    }
    
    const baseNetworkEl = document.getElementById('base-network-total');
    if (baseNetworkEl) {
        baseNetworkEl.textContent = `$${baseTotal.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        })}`;
        console.log('   ✅ Updated base network total');
    } else {
        console.error('   ❌ base-network-total element not found');
    }
    
    const chiaNetworkEl = document.getElementById('chia-network-total');
    if (chiaNetworkEl) {
        chiaNetworkEl.textContent = `$${chiaTotal.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        })}`;
        console.log('   ✅ Updated chia network total');
    } else {
        console.error('   ❌ chia-network-total element not found');
    }
    
    // Update holdings
    const baseTokens = baseData?.tokens || [];
    const chiaTokens = chiaData?.tokens || [];
    console.log(`   Updating holdings: ${baseTokens.length} base, ${chiaTokens.length} chia`);
    updateHoldingsColumn('base', baseTokens);
    updateHoldingsColumn('chia', chiaTokens);
    
    // Update NFTs
    if (nftData && nftData.collections && nftData.collections.length > 0) {
        console.log(`   Updating NFTs: ${nftData.collections.length} collections`);
        updateNFTGallery(nftData);
    } else {
        console.log('   ⚠️ No NFT data to display');
        const collectionsGrid = document.getElementById('collections-grid');
        if (collectionsGrid) {
            collectionsGrid.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: rgba(255, 255, 255, 0.5);">
                    <div style="font-size: 48px; margin-bottom: 16px;">🖼️</div>
                    <div style="font-size: 18px; margin-bottom: 8px;">No NFT collections found</div>
                    <div style="font-size: 14px; opacity: 0.7;">NFTs will appear here once loaded</div>
                </div>
            `;
        }
    }
    
    console.log('✅ Treasury display updated successfully');
}

function fmtPrice(price) {
    if (!price || price === 0) return '—';
    if (price < 0.000001) return '$' + price.toExponential(2);
    if (price < 0.0001)   return '$' + price.toFixed(8);
    if (price < 0.01)     return '$' + price.toFixed(6);
    if (price < 1)        return '$' + price.toFixed(4);
    return '$' + price.toLocaleString(undefined, {maximumSignificantDigits: 5});
}

function fmtBal2(bal) {
    if (!bal || bal === 0) return '0';
    if (bal >= 1e9) return (bal/1e9).toFixed(2) + 'B';
    if (bal >= 1e6) return (bal/1e6).toFixed(2) + 'M';
    if (bal >= 1e3) return bal.toLocaleString(undefined, {maximumFractionDigits: 0});
    if (bal >= 1)   return bal.toLocaleString(undefined, {maximumFractionDigits: 4});
    return bal.toPrecision(4);
}

function buildTokenCard(token) {
    const isLP = token.type === 'lp';
    const borderColor = isLP ? 'rgba(99,179,237,0.4)' : 'rgba(251,191,36,0.3)';
    const hoverBorder = isLP ? 'rgba(99,179,237,0.8)' : 'rgba(251,191,36,0.6)';
    const valueColor  = isLP ? '#63b3ed' : '#4ade80';
    const val   = token.value   || 0;
    const bal   = token.balance || 0;
    const price = token.price   || 0;

    let detailHtml = '';
    if (isLP) {
        const poolFmt  = (token.totalLiqUsd || 0) > 0
            ? '$' + (token.totalLiqUsd).toLocaleString(undefined, {maximumFractionDigits: 0}) : '—';
        const shareFmt = parseFloat(token.userSharePct || 0) > 0
            ? parseFloat(token.userSharePct).toFixed(3) + '%' : '—';
        const p0Fmt = token.price0 > 0 ? fmtPrice(token.price0) : null;
        const p1Fmt = token.price1 > 0 ? fmtPrice(token.price1) : null;
        const [sym0, sym1] = (token.pairName || '/').split('/');
        const priceRow = (p0Fmt || p1Fmt)
            ? `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:11px;color:rgba(255,255,255,0.55);margin-top:5px;">
                 ${p0Fmt ? `<span style="color:#fbbf24;">${sym0}: ${p0Fmt}</span>` : '<span></span>'}
                 ${p1Fmt ? `<span style="color:#4ade80;">${sym1}: ${p1Fmt}</span>` : '<span></span>'}
               </div>` : '';
        detailHtml = `
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;color:rgba(255,255,255,0.6);margin-top:8px;">
                <span>Share: ${shareFmt}</span>
                <span>Pool: ${poolFmt}</span>
            </div>
            ${priceRow}`;
    } else {
        detailHtml = `
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;color:rgba(255,255,255,0.6);margin-top:8px;">
                <span>Bal: ${fmtBal2(bal)}</span>
                <span>Price: ${fmtPrice(price)}</span>
            </div>`;
    }

    // Build explorer link — LP positions are never clickable
    // Chia CATs → TailDatabase, Base tokens → BaseScan
    let explorerUrl = '';
    if (!isLP) {
        if (token.assetId && token.assetId !== 'XCH_NATIVE') {
            explorerUrl = `https://www.taildatabase.com/tail/${token.assetId}`;
        } else if (token.assetId === 'XCH_NATIVE') {
            explorerUrl = 'https://www.spacescan.io';
        } else if (token.contract) {
            explorerUrl = `https://basescan.org/token/${token.contract}`;
        }
    }
    const clickHandler = explorerUrl ? `onclick="window.open('${explorerUrl}','_blank')"` : '';

    return `
    <div style="
        background:linear-gradient(135deg,rgba(30,30,40,0.7),rgba(15,15,25,0.9));
        border:2px solid ${borderColor};border-radius:12px;padding:14px;margin-bottom:10px;
        transition:all 0.3s;cursor:${explorerUrl ? 'pointer' : 'default'};
        will-change:transform;contain:layout style paint;"
        ${clickHandler}
        onmouseover="this.style.borderColor='${hoverBorder}';this.style.transform='translateX(4px)';this.style.boxShadow='0 4px 16px rgba(251,191,36,0.15)';"
        onmouseout="this.style.borderColor='${borderColor}';this.style.transform='translateX(0)';this.style.boxShadow='none';">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <span style="font-size:15px;font-weight:700;color:white;max-width:65%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${token.symbol || 'Unknown'}${isLP ? ' <span style="font-size:11px;color:#63b3ed;font-weight:600;opacity:0.85;">(LP)</span>' : ''}${explorerUrl ? ' <span style="font-size:10px;opacity:0.4;">↗</span>' : ''}</span>
            <span style="font-size:16px;font-weight:700;color:${valueColor};">$${val >= 1000 ? val.toLocaleString(undefined,{maximumFractionDigits:0}) : val.toFixed(2)}</span>
        </div>
        ${detailHtml}
    </div>`;
}

function updateHoldingsColumn(chain, tokensRaw) {
    let tokens = tokensRaw || [];
    const listId  = chain === 'base' ? 'base-holdings-list' : 'chia-holdings-list';
    const countId = chain === 'base' ? 'base-token-count'   : 'chia-token-count';
    const totalId = chain === 'base' ? 'base-column-total'  : 'chia-column-total';

    tokens = [...tokens].sort((a, b) => (b.value || 0) - (a.value || 0));

    const total = tokens.reduce((s, t) => s + (t.value || 0), 0);
    document.getElementById(totalId).textContent = `$${total.toLocaleString(undefined, {minimumFractionDigits:2,maximumFractionDigits:2})}`;

    // Split into valued vs zero-value
    const valued = tokens.filter(t => (t.value || 0) >= 0.01);
    const zeros  = tokens.filter(t => (t.value || 0) < 0.01);
    document.getElementById(countId).textContent = `${tokens.length} tokens`;

    if (tokens.length === 0) {
        document.getElementById(listId).innerHTML = `<div style="text-align:center;padding:60px 20px;color:rgba(255,255,255,0.4);">No tokens found</div>`;
        return;
    }

    // Show all tokens — valued first, then zero-value, no collapsible
    const html = [...valued, ...zeros].map(buildTokenCard).join('');
    document.getElementById(listId).innerHTML = html;
}

function updateNFTGallery(nftData) {
    console.log('🖼️ Updating NFT gallery...');
    console.log('   nftData:', nftData);
    
    if (!nftData) {
        console.log('   ⚠️ No NFT data provided');
        return;
    }
    
    if (!nftData.collections || nftData.collections.length === 0) {
        console.log('   ⚠️ No collections in NFT data');
        const g = document.getElementById('collections-grid');
        if (g) g.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:rgba(255,255,255,0.4);">No NFT collections found</div>';
        return;
    }
    
    console.log(`   Found ${nftData.collections.length} collections`);
    console.log(`   Total NFTs: ${nftData.totalNFTs || 0}`);
    console.log(`   Total value: $${nftData.totalValue || 0}`);
    
    // Update summary stats
    const nftCountEl = document.getElementById('total-nft-count');
    if (nftCountEl) {
        nftCountEl.textContent = nftData.totalNFTs || nftData.nftCount || 0;
        console.log('   ✅ Updated NFT count');
    }
    
    const collectionsCountEl = document.getElementById('total-collections');
    if (collectionsCountEl) {
        collectionsCountEl.textContent = nftData.collections?.length || 0;
        console.log('   ✅ Updated collections count');
    }
    
    // Generate collection cards — each links to MintGarden collection page
    const html = nftData.collections.map((col, index) => {
        const mgUrl = `https://mintgarden.io/collections/${col.colId || col.id || ''}`;
        const hasImg = !!col.image;
        return `
        <div onclick="window.open('${mgUrl}','_blank')" style="
            background: linear-gradient(135deg, rgba(30, 30, 40, 0.8), rgba(15, 15, 25, 0.9));
            border: 2px solid rgba(168, 85, 247, 0.4);
            border-radius: 14px;
            padding: 14px;
            transition: all 0.25s;
            cursor: pointer;
            backdrop-filter: blur(10px);
        " onmouseover="this.style.borderColor='rgba(168,85,247,0.75)';this.style.transform='translateY(-3px)';this.style.boxShadow='0 10px 28px rgba(168,85,247,0.28)';"
           onmouseout="this.style.borderColor='rgba(168,85,247,0.4)';this.style.transform='translateY(0)';this.style.boxShadow='none';">
            <!-- Thumbnail with count badge -->
            <div style="position:relative; width:100%; padding-top:100%; border-radius:10px; overflow:visible; margin-bottom:10px;">
                <div style="position:absolute;inset:0;border-radius:10px;overflow:hidden;background:rgba(168,85,247,0.1);border:1px solid rgba(168,85,247,0.3);">
                    ${hasImg
                        ? `<img src="${col.image}" alt="${col.name}" style="width:100%;height:100%;object-fit:cover;display:block;" onerror="this.style.display='none';this.parentElement.innerHTML+='<div style=\'display:flex;width:100%;height:100%;align-items:center;justify-content:center;font-size:36px;\'>🖼️</div>'">`
                        : `<div style="display:flex;width:100%;height:100%;align-items:center;justify-content:center;font-size:36px;">🖼️</div>`
                    }
                </div>
                <div style="position:absolute;top:-7px;right:-7px;background:linear-gradient(135deg,#a855f7,#7c3aed);color:white;font-size:11px;font-weight:800;border-radius:9px;padding:2px 7px;border:2px solid rgba(10,10,20,0.9);min-width:20px;text-align:center;z-index:2;">
                    ${col.count}
                </div>
            </div>
            <!-- Full title — no truncation -->
            <div style="font-size:13px;font-weight:700;color:white;line-height:1.35;word-break:break-word;margin-bottom:4px;">${col.name}</div>
            <div style="font-size:11px;color:rgba(168,85,247,0.7);font-weight:600;">View on MintGarden ↗</div>
        </div>
    `;
    }).join('');
    
    const collectionsGrid = document.getElementById('collections-grid');
    if (collectionsGrid) {
        collectionsGrid.innerHTML = html || `
            <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: rgba(255,255,255,0.5);">
                <div style="font-size: 48px; margin-bottom: 16px;">🖼️</div>
                <div>No NFT collections found</div>
            </div>
        `;
        console.log('   ✅ NFT gallery updated successfully');
    } else {
        console.error('   ❌ collections-grid element not found');
    }
}

// =================================================================
// 4. MERKL MAGIC - REAL APR POOLS
// =================================================================

async function loadMerklMagic() {
    console.log('✨ Loading Merkl Magic with REAL APR data...');
    
    try {
        const resp = await fetch('/api/merkl-pools');
        const data = await resp.json();
        
        // Ensure we have an array
        const pools = Array.isArray(data) ? data : [];
        
        // Sort by APR and get top 3
        const topPools = pools
            .filter(p => p && p.apr > 0)
            .sort((a, b) => b.apr - a.apr)
            .slice(0, 3);
        
        updateMerklDisplay(topPools);
        
    } catch (error) {
        console.error('Merkl error:', error);
        updateMerklDisplay([]);
    }
}

function updateMerklDisplay(pools) {
    const container = document.getElementById('merkl-pools');
    if (!container) return;
    
    if (pools.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                No active pools found
            </div>
        `;
        return;
    }
    
    const html = pools.map((pool, index) => `
        <div style="
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(220, 38, 38, 0.15));
            border: 2px solid rgba(251, 191, 36, 0.4);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 700; font-size: 16px; color: #fbbf24;">#${index + 1} ${pool.name || pool.symbol}</span>
                <span style="font-size: 20px; font-weight: 900; color: #4ade80;">${pool.apr.toFixed(2)}% APR</span>
            </div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">
                TVL: $${formatNumber(pool.tvl || 0)}
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

// =================================================================
// UTILITIES
// =================================================================

function formatNumber(num) {
    if (!num || isNaN(num)) return '0';
    if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
    return num.toFixed(2);
}

// =================================================================
// INITIALIZATION
// =================================================================

document.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 All systems initialized!');
    
    // Load emoji market immediately
    // REMOVED - updateEmojiMarket called after main fetch
    
    // Load Merkl Magic
    loadMerklMagic();
    
    // Setup manual treasury refresh button
    const refreshBtn = document.getElementById('refresh-chia-treasury');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', async () => {
            if (isRefreshingChiaTreasury) {
                alert('⏱️ Already refreshing from Spacescan, please wait...');
                return;
            }
            refreshBtn.textContent = '⏳ Fetching...';
            refreshBtn.disabled = true;
            isRefreshingChiaTreasury = true;
            
            try {
                const chiaList = document.getElementById('chia-holdings-list');
                if (chiaList) {
                    chiaList.innerHTML = `<div style="text-align:center;padding:40px 20px;color:rgba(255,255,255,0.4);font-size:12px;">
                        <div style="font-size:24px;margin-bottom:8px;">⏳</div>
                        <div>Refreshing Chia treasury…</div>
                        <div style="font-size:11px;margin-top:8px;opacity:0.5;">Bypassing cache and reloading from Spacescan</div>
                    </div>`;
                }
                // Force a full treasury refresh (bypass cache + cooldown)
                await forceChiaRefresh();
                alert('✅ Treasury refreshed from Spacescan!');
            } catch(e) {
                console.error('Refresh error:', e);
                alert('❌ Refresh failed: ' + e.message);
            } finally {
                refreshBtn.textContent = '🔄 Refresh';
                refreshBtn.disabled = false;
                isRefreshingChiaTreasury = false;
            }
        });
    }
    
    // Note: treasury loading is handled by showTab() via onclick - no duplicate listener needed
});

    </script>

    <!-- Floating Video Miniplayer -->
    <div id="video-miniplayer" style="
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 360px;
        height: 320px;
        background: linear-gradient(135deg, rgba(10, 10, 20, 0.95), rgba(20, 20, 35, 0.95));
        border: 1.5px solid rgba(251, 191, 36, 0.5);
        border-radius: 16px;
        box-shadow: 
            0 20px 60px rgba(0, 0, 0, 0.9),
            0 0 0 1px rgba(251, 191, 36, 0.2),
            0 0 50px rgba(251, 191, 36, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 999999;
        cursor: move;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        user-select: none;
    ">
        <!-- Drag Handle Header -->
        <div id="video-miniplayer-header" style="
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(220, 38, 38, 0.08));
            border-bottom: 1px solid rgba(251, 191, 36, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
            position: relative;
        ">
            <div style="
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 1px;
                background: linear-gradient(90deg, transparent, rgba(251, 191, 36, 0.7), transparent);
            "></div>
            <div style="
                display: flex;
                align-items: center;
                gap: 7px;
                font-size: 12px;
                font-weight: 900;
                color: #fbbf24;
                font-family: 'Cinzel', serif;
                letter-spacing: 0.5px;
                text-shadow: 0 3px 10px rgba(251, 191, 36, 0.5);
            ">
                <span style="font-size: 16px;">🎬</span>
                <span>WTV</span>
            </div>
            <button id="close-miniplayer" style="
                background: linear-gradient(135deg, rgba(220, 38, 38, 0.3), rgba(153, 27, 27, 0.2));
                border: 1px solid rgba(220, 38, 38, 0.5);
                border-radius: 6px;
                color: #fca5a5;
                font-size: 12px;
                cursor: pointer;
                padding: 4px 8px;
                font-weight: 900;
                transition: all 0.2s;
                box-shadow: 0 2px 6px rgba(220, 38, 38, 0.25);
            " onmouseover="this.style.background='linear-gradient(135deg, rgba(220,38,38,0.5), rgba(153,27,27,0.4))'; this.style.transform='scale(1.08)'; this.style.boxShadow='0 4px 12px rgba(220,38,38,0.4)';" onmouseout="this.style.background='linear-gradient(135deg, rgba(220,38,38,0.3), rgba(153,27,27,0.2))'; this.style.transform=''; this.style.boxShadow='0 2px 6px rgba(220,38,38,0.25)';"
                title="Close WTV">
                ✕
            </button>
        </div>

        <!-- Video Container -->
        <div style="
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: linear-gradient(135deg, #000000, #0a0a0a);
            box-shadow: inset 0 1px 8px rgba(0, 0, 0, 0.7);
            min-height: 140px;
            flex: 1;
        ">
            <div id="miniplayer-container" style="
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                background: #000;
                overflow: hidden;
            ">
                <video id="miniplayer-video" style="
                    width: 100%;
                    height: 100%;
                    object-fit: contain;
                    display: none;
                " controls></video>
                <iframe id="miniplayer-iframe" style="
                    width: 100%;
                    height: 100%;
                    border: none;
                    border-radius: 8px;
                    display: none;
                    margin: 0 auto;
                    background: #000;
                " allowfullscreen></iframe>
            </div>
            <!-- Video overlay gradient -->
            <div style="
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: radial-gradient(circle at center, transparent 40%, rgba(0, 0, 0, 0.1) 100%);
                pointer-events: none;
            "></div>
        </div>

        <!-- Controls -->
        <div style="
            padding: 12px 14px;
            background: linear-gradient(180deg, rgba(10, 10, 20, 0.6), rgba(0, 0, 0, 0.85));
            border-top: 1px solid rgba(251, 191, 36, 0.2);
            margin-top: auto;
        ">
            <!-- Video Title -->
            <div id="video-title" style="
                font-size: 11px;
                color: rgba(251, 191, 36, 0.95);
                margin-bottom: 6px;
                text-align: center;
                font-family: 'Cinzel', serif;
                font-weight: 700;
                letter-spacing: 0.5px;
                text-shadow: 0 2px 6px rgba(251, 191, 36, 0.4);
            ">The Last Wizard</div>

            <!-- Control Buttons -->
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 7px;">
                <button id="video-prev" style="
                    background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(251, 191, 36, 0.1));
                    border: 1px solid rgba(251, 191, 36, 0.4);
                    border-radius: 8px;
                    color: #fbbf24;
                    padding: 6px 10px;
                    cursor: pointer;
                    font-size: 13px;
                    transition: all 0.2s;
                    box-shadow: 0 2px 8px rgba(251, 191, 36, 0.15);
                    flex: 1;
                    text-align: center;
                " onmouseover="this.style.background='linear-gradient(135deg, rgba(251,191,36,0.35), rgba(251,191,36,0.25))'; this.style.boxShadow='0 4px 12px rgba(251,191,36,0.3)';" onmouseout="this.style.background='linear-gradient(135deg, rgba(251,191,36,0.2), rgba(251,191,36,0.1))'; this.style.boxShadow='0 2px 8px rgba(251,191,36,0.15)';">⏮️</button>

                <button id="video-playpause" style="
                    background: linear-gradient(135deg, rgba(251, 191, 36, 0.35), rgba(220, 38, 38, 0.28));
                    border: 1px solid rgba(251, 191, 36, 0.5);
                    border-radius: 8px;
                    color: white;
                    padding: 7px 14px;
                    cursor: pointer;
                    font-size: 15px;
                    font-weight: bold;
                    transition: all 0.2s;
                    flex: 1.5;
                    box-shadow: 0 3px 10px rgba(251, 191, 36, 0.25);
                " onmouseover="this.style.background='linear-gradient(135deg, rgba(251,191,36,0.5), rgba(220,38,38,0.4))'; this.style.boxShadow='0 5px 16px rgba(251,191,36,0.4)';" onmouseout="this.style.background='linear-gradient(135deg, rgba(251,191,36,0.35), rgba(220,38,38,0.28))'; this.style.boxShadow='0 3px 10px rgba(251,191,36,0.25)';">⏸️</button>

                <button id="video-next" style="
                    background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(251, 191, 36, 0.1));
                    border: 1px solid rgba(251, 191, 36, 0.4);
                    border-radius: 8px;
                    color: #fbbf24;
                    padding: 6px 10px;
                    cursor: pointer;
                    font-size: 13px;
                    transition: all 0.2s;
                    box-shadow: 0 2px 8px rgba(251, 191, 36, 0.15);
                    flex: 1;
                    text-align: center;
                " onmouseover="this.style.background='linear-gradient(135deg, rgba(251,191,36,0.35), rgba(251,191,36,0.25))'; this.style.boxShadow='0 4px 12px rgba(251,191,36,0.3)';" onmouseout="this.style.background='linear-gradient(135deg, rgba(251,191,36,0.2), rgba(251,191,36,0.1))'; this.style.boxShadow='0 2px 8px rgba(251,191,36,0.15)';">⏭️</button>

                <button id="video-shuffle" style="
                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(37, 99, 235, 0.15));
                    border: 1px solid rgba(96, 165, 250, 0.5);
                    border-radius: 8px;
                    color: #93c5fd;
                    padding: 6px 10px;
                    cursor: pointer;
                    font-size: 13px;
                    transition: all 0.2s;
                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
                    flex: 1;
                    text-align: center;
                " onmouseover="this.style.background='linear-gradient(135deg, rgba(96,165,250,0.35), rgba(59,130,246,0.25))'; this.style.boxShadow='0 4px 12px rgba(59,130,246,0.3)';" onmouseout="this.style.background='linear-gradient(135deg, rgba(59,130,246,0.25), rgba(37,99,235,0.15))'; this.style.boxShadow='0 2px 8px rgba(59,130,246,0.2)';">🔀</button>
            </div>
        </div>
    </div>

    <style>
        /* Progress bar styling */
        #video-progress::-webkit-slider-thumb,
        #video-volume::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 
                0 2px 8px rgba(251, 191, 36, 0.6),
                0 0 0 2px rgba(251, 191, 36, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.2s;
        }

        #video-progress::-webkit-slider-thumb:hover,
        #video-volume::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 
                0 4px 12px rgba(251, 191, 36, 0.8),
                0 0 0 3px rgba(251, 191, 36, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        #video-progress::-moz-range-thumb,
        #video-volume::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 
                0 2px 8px rgba(251, 191, 36, 0.6),
                0 0 0 2px rgba(251, 191, 36, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        /* Miniplayer hidden state */
        #video-miniplayer.hidden {
            display: none;
        }
    </style>

    <script>
        // Video Miniplayer Playlist & Controls
        (function() {
            // Google Drive video file IDs and titles
            const googleDriveVideos = [
                '16TQ9vT6-DBc4eBkNOEtispHbP29UxCuN',  // The Last Wizard
                '16aRwSsYWfiUhvdpFTPZkqW7O7_FwdrNX',  // aWizard Magic
                '1H9rR4Lx8_Cdr8QOTDA_gogSDT3zfjoDU',  // Sprout Magic
                '1VO1AQ0Fs0UjXVcayQBi5sKg5yt6nvRsS',  // Hear The Drums in the Distance
                '1G1ei4pCVrP6nJlIiBEWA63-S5sPurhRG',  // Keys Falls Slow Like Winter Rain
                '14Wlka69GO-25-qv5lAFia0ctK8V2T7Sm',  // 🌱🧙‍♂️
                '1TKn2oUN-OEjGdJfftmzNU0Jc2pJsQAXk'   // Astral Realm Caster
            ];
            
            const videoTitles = [
                'The Last Wizard',
                'aWizard Magic',
                'Sprout Magic',
                'Hear The Drums in the Distance',
                'Keys Falls Slow Like Winter Rain',
                '🌱🧙‍♂️',
                'Astral Realm Caster'
            ];

            let currentIndex = 0;
            const video = document.getElementById('miniplayer-video');
            const iframe = document.getElementById('miniplayer-iframe');
            const playPauseBtn = document.getElementById('video-playpause');
            const prevBtn = document.getElementById('video-prev');
            const nextBtn = document.getElementById('video-next');
            const shuffleBtn = document.getElementById('video-shuffle');
            const closeBtn = document.getElementById('close-miniplayer');
            const miniplayer = document.getElementById('video-miniplayer');

            let isIframePaused = false;

            const setRestoreVisible = (visible) => {
                const restoreBtn = document.getElementById('wtv-restore-btn');
                if (restoreBtn) {
                    restoreBtn.style.display = visible ? 'flex' : 'none';
                }
            };

            const hideMiniplayer = () => {
                miniplayer.classList.add('hidden');
                miniplayer.style.display = 'none';
                localStorage.setItem('videoMiniplayerHidden', 'true');
                setRestoreVisible(true);
            };

            const showMiniplayer = () => {
                miniplayer.classList.remove('hidden');
                miniplayer.style.display = 'flex';
                localStorage.removeItem('videoMiniplayerHidden');
                setRestoreVisible(false);
            };

            window._showWtvMiniplayer = showMiniplayer;
            window._hideWtvMiniplayer = hideMiniplayer;

            // Load Google Drive video
            function loadVideo(index) {
                if (index >= 0 && index < googleDriveVideos.length) {
                    currentIndex = index;
                    const fileId = googleDriveVideos[currentIndex];
                    
                    // Build Google Drive embed URL
                    const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
                    
                    console.log(`🎬 Loading Google Drive video ${currentIndex + 1}/${googleDriveVideos.length}: ${videoTitles[currentIndex]}`);
                    
                    // Use iframe for Google Drive videos
                    iframe.src = embedUrl;
                    iframe.dataset.lastSrc = embedUrl;
                    iframe.style.display = 'block';
                    video.style.display = 'none';
                    isIframePaused = false;
                    playPauseBtn.textContent = '⏸️';
                    
                    // Update title and playlist info
                    const videoTitle = document.getElementById('video-title');
                    if (videoTitle) {
                        videoTitle.textContent = videoTitles[currentIndex];
                    }
                }
            }

            // Previous
            prevBtn.addEventListener('click', () => {
                if (googleDriveVideos.length > 0) {
                    loadVideo((currentIndex - 1 + googleDriveVideos.length) % googleDriveVideos.length);
                }
            });

            // Next
            nextBtn.addEventListener('click', () => {
                if (googleDriveVideos.length > 0) {
                    loadVideo((currentIndex + 1) % googleDriveVideos.length);
                }
            });

            // Play/Pause button
            playPauseBtn.addEventListener('click', () => {
                if (iframe.style.display === 'block') {
                    if (!isIframePaused) {
                        iframe.dataset.pausedSrc = iframe.src;
                        iframe.src = 'about:blank';
                        isIframePaused = true;
                        playPauseBtn.textContent = '▶️';
                    } else {
                        const resumeSrc = iframe.dataset.pausedSrc || iframe.dataset.lastSrc;
                        if (resumeSrc) {
                            iframe.src = resumeSrc;
                        }
                        isIframePaused = false;
                        playPauseBtn.textContent = '⏸️';
                    }
                    return;
                }

                if (video.paused) {
                    video.play();
                    playPauseBtn.textContent = '⏸️';
                } else {
                    video.pause();
                    playPauseBtn.textContent = '▶️';
                }
            });

            // Shuffle playlist
            if (shuffleBtn) {
                shuffleBtn.addEventListener('click', () => {
                    for (let i = googleDriveVideos.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [googleDriveVideos[i], googleDriveVideos[j]] = [googleDriveVideos[j], googleDriveVideos[i]];
                        [videoTitles[i], videoTitles[j]] = [videoTitles[j], videoTitles[i]];
                    }
                    currentIndex = 0;
                    loadVideo(currentIndex);
                });
            }

            // Close miniplayer
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                console.log('🔴 Closing WTV miniplayer...');
                hideMiniplayer();
                console.log('✅ WTV restore button shown');
            });

            // WTV is OPEN by default - only hide if explicitly closed before
            // Remove the check completely so WTV always starts open
            // User can close it if they want, but default state is VISIBLE

            // Make miniplayer draggable & resizable
            let isDragging = false;
            let isResizing = false;
            let currentX, currentY, initialX, initialY, initialWidth, initialHeight, resizeAspect;
            const header = document.getElementById('video-miniplayer-header');

            // Create resize handle - clean design without weird shadows
            const resizeHandle = document.createElement('div');
            resizeHandle.style.cssText = 'position: absolute; bottom: 2px; right: 2px; width: 16px; height: 16px; cursor: nwse-resize; background: transparent; z-index: 10; display: flex; align-items: center; justify-content: center; font-size: 10px; color: rgba(251,191,36,0.6); user-select: none;';
            resizeHandle.innerHTML = '⋰';
            resizeHandle.title = 'Drag to resize';
            miniplayer.appendChild(resizeHandle);

            // Dragging
            header.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            function dragStart(e) {
                // Don't start dragging if clicking on resize handle
                if (e.target === resizeHandle || isResizing) {
                    return;
                }
                initialX = e.clientX - miniplayer.offsetLeft;
                initialY = e.clientY - miniplayer.offsetTop;
                if (e.target === header || e.target.parentElement === header || e.target.parentElement.parentElement === header) {
                    isDragging = true;
                    miniplayer.style.cursor = 'grabbing';
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    const maxX = window.innerWidth - miniplayer.offsetWidth;
                    const maxY = window.innerHeight - miniplayer.offsetHeight;
                    
                    currentX = Math.max(0, Math.min(currentX, maxX));
                    currentY = Math.max(0, Math.min(currentY, maxY));

                    miniplayer.style.left = currentX + 'px';
                    miniplayer.style.top = currentY + 'px';
                    miniplayer.style.bottom = 'auto';
                }
            }

            function dragEnd() {
                if (isDragging) {
                    isDragging = false;
                    miniplayer.style.cursor = 'move';
                    localStorage.setItem('videoMiniplayerX', miniplayer.style.left);
                    localStorage.setItem('videoMiniplayerY', miniplayer.style.top);
                }
            }

            // Resizing via handle
            resizeHandle.addEventListener('mousedown', resizeStart);
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', resizeEnd);

            function resizeStart(e) {
                e.preventDefault();
                e.stopPropagation();
                isResizing = true;
                isDragging = false; // Ensure dragging is off
                initialX = e.clientX;
                initialY = e.clientY;
                initialWidth = miniplayer.offsetWidth;
                initialHeight = miniplayer.offsetHeight;
                resizeAspect = initialHeight / initialWidth;
                document.body.style.userSelect = 'none';
            }

            function resize(e) {
                if (isResizing) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Calculate new width and lock overall aspect ratio
                    const deltaX = e.clientX - initialX;
                    const newWidth = Math.max(260, Math.min(800, initialWidth + deltaX));
                    const newHeight = Math.round(newWidth * resizeAspect);
                    miniplayer.style.width = newWidth + 'px';
                    miniplayer.style.height = newHeight + 'px';
                }
            }

            function resizeEnd() {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.userSelect = '';
                    localStorage.setItem('videoMiniplayerWidth', miniplayer.style.width);
                    localStorage.setItem('videoMiniplayerHeight', miniplayer.style.height);
                }
            }

            // Restore saved position & size
            const savedX = localStorage.getItem('videoMiniplayerX');
            const savedY = localStorage.getItem('videoMiniplayerY');
            const savedWidth = localStorage.getItem('videoMiniplayerWidth');
            const savedHeight = localStorage.getItem('videoMiniplayerHeight');
            
            if (savedX && savedY) {
                miniplayer.style.left = savedX;
                miniplayer.style.top = savedY;
                miniplayer.style.bottom = 'auto';
            }
            
            if (savedWidth) {
                miniplayer.style.width = savedWidth;
            }
            
            if (savedHeight) {
                miniplayer.style.height = savedHeight;
            }

            // Store miniplayer reference globally for restore button
            window._wtvMiniplayer = miniplayer;

            const wasHidden = localStorage.getItem('videoMiniplayerHidden') === 'true';
            window._wtvHiddenAtLoad = wasHidden;
            if (wasHidden) {
                hideMiniplayer();
            } else {
                showMiniplayer();
            }

            // Load first video
            console.log('🎬 WTV initialized with local video playlist');
            loadVideo(0);
        })();
    </script>

    <!-- WTV Drawer Overlay (mobile only) -->
    <div id="wtv-drawer-overlay" style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        z-index: 999998;
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        transition: opacity 0.3s;
    " onclick="if(window._wtvCloseDrawer) window._wtvCloseDrawer();"></div>

    <!-- WTV Mobile Edge Tab (right side pull handle) -->
    <button id="wtv-mobile-tab" style="
        display: none;
        position: fixed;
        right: 0;
        top: 55%;
        transform: translateY(-50%);
        width: 22px;
        height: 70px;
        background: linear-gradient(180deg, rgba(251,191,36,0.9), rgba(220,38,38,0.5));
        border: 2px solid rgba(251,191,36,0.8);
        border-right: none;
        border-radius: 12px 0 0 12px;
        color: white;
        font-size: 16px;
        cursor: pointer;
        z-index: 999997;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 3px;
        box-shadow: -4px 0 20px rgba(251,191,36,0.35);
        transition: all 0.25s;
        font-family: 'Space Grotesk', sans-serif;
        writing-mode: vertical-rl;
        text-orientation: mixed;
        padding: 5px 2px;
        animation: wtv-tab-glow 3s infinite;
    " onclick="if(window._wtvOpenDrawer) window._wtvOpenDrawer();">
        <span style="font-size: 12px; writing-mode: horizontal-tb;">🎬</span>
    </button>

    <!-- WTV Restore Button - More Visible (desktop only) -->
    <button id="wtv-restore-btn" style="
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.8), rgba(220, 38, 38, 0.4));
        border: 3px solid rgba(251, 191, 36, 1);
        border-radius: 15px;
        color: #fbbf24;
        font-size: 16px;
        font-weight: 900;
        cursor: pointer;
        z-index: 999998;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        box-shadow: 0 0 25px rgba(251, 191, 36, 0.6), inset 0 0 15px rgba(251, 191, 36, 0.2);
        font-family: 'Cinzel', serif;
        text-align: center;
        line-height: 1.2;
        gap: 4px;
        animation: wtv-pulse 2s infinite;
    " onmouseover="this.style.background='linear-gradient(135deg, rgba(251,191,36,1), rgba(220,38,38,0.6))'; this.style.transform='scale(1.15)'; this.style.boxShadow='0 0 35px rgba(251,191,36,0.85), inset 0 0 20px rgba(251,191,36,0.4)';" onmouseout="this.style.background='linear-gradient(135deg, rgba(251,191,36,0.8), rgba(220,38,38,0.4))'; this.style.transform=''; this.style.boxShadow='0 0 25px rgba(251,191,36,0.6), inset 0 0 15px rgba(251,191,36,0.2)';"
        onclick="if (window._showWtvMiniplayer) window._showWtvMiniplayer();"
        title="Click to restore WTV miniplayer">
        <span style="font-size: 28px;">🎬</span>
        <span style="font-size: 10px; opacity: 0.9;">WTV</span>
    </button>

    <style>
        @keyframes wtv-pulse {
            0%, 100% {
                box-shadow: 0 0 25px rgba(251, 191, 36, 0.6), inset 0 0 15px rgba(251, 191, 36, 0.2);
            }
            50% {
                box-shadow: 0 0 40px rgba(251, 191, 36, 0.9), inset 0 0 20px rgba(251, 191, 36, 0.4);
            }
        }
        @keyframes wtv-tab-glow {
            0%, 100% {
                box-shadow: -4px 0 20px rgba(251, 191, 36, 0.3);
            }
            50% {
                box-shadow: -4px 0 30px rgba(251, 191, 36, 0.6), 0 0 12px rgba(251, 191, 36, 0.2);
            }
        }
    </style>

    <script>
        // WTV Restore Button Handler + Mobile Drawer Logic
        (function() {
            const restoreBtn = document.getElementById('wtv-restore-btn');
            const miniplayer = window._wtvMiniplayer || document.getElementById('video-miniplayer');
            const mobileTab = document.getElementById('wtv-mobile-tab');
            const overlay = document.getElementById('wtv-drawer-overlay');

            const isMobile = () => window.innerWidth <= 768;

            // --- Mobile drawer open/close ---
            window._wtvOpenDrawer = function() {
                if (!miniplayer) return;
                miniplayer.classList.remove('hidden', 'mobile-drawer-closed');
                miniplayer.style.display = 'flex';
                if (overlay) overlay.style.display = 'block';
                if (mobileTab) mobileTab.style.display = 'none';
                localStorage.removeItem('videoMiniplayerHidden');
            };

            window._wtvCloseDrawer = function() {
                if (!miniplayer) return;
                miniplayer.classList.add('mobile-drawer-closed');
                if (overlay) overlay.style.display = 'none';
                if (mobileTab) mobileTab.style.display = 'flex';
                // After slide-out animation finishes, fully hide
                setTimeout(() => {
                    if (miniplayer.classList.contains('mobile-drawer-closed')) {
                        miniplayer.style.display = 'none';
                        localStorage.setItem('videoMiniplayerHidden', 'true');
                    }
                }, 400);
            };

            // Override close button behavior on mobile
            const closeBtn = document.getElementById('close-miniplayer');
            if (closeBtn) {
                const origClose = closeBtn.onclick;
                closeBtn.addEventListener('click', (e) => {
                    if (isMobile()) {
                        e.stopPropagation();
                        e.preventDefault();
                        window._wtvCloseDrawer();
                        return false;
                    }
                });
            }

            // Override show/hide for mobile awareness
            const origShow = window._showWtvMiniplayer;
            const origHide = window._hideWtvMiniplayer;

            window._showWtvMiniplayer = function() {
                if (isMobile()) {
                    window._wtvOpenDrawer();
                } else if (origShow) {
                    origShow();
                }
            };

            window._hideWtvMiniplayer = function() {
                if (isMobile()) {
                    window._wtvCloseDrawer();
                } else if (origHide) {
                    origHide();
                }
            };

            // --- Desktop restore button ---
            if (restoreBtn && miniplayer) {
                const hiddenAtLoad = window._wtvHiddenAtLoad || localStorage.getItem('videoMiniplayerHidden') === 'true';
                if (hiddenAtLoad) {
                    if (isMobile()) {
                        miniplayer.classList.add('mobile-drawer-closed');
                        miniplayer.style.display = 'none';
                        if (mobileTab) mobileTab.style.display = 'flex';
                    } else {
                        restoreBtn.style.display = 'flex';
                        miniplayer.classList.add('hidden');
                        miniplayer.style.display = 'none';
                    }
                } else if (isMobile()) {
                    // WTV starts open on mobile: show drawer
                    miniplayer.classList.remove('mobile-drawer-closed');
                    miniplayer.style.display = 'flex';
                    if (mobileTab) mobileTab.style.display = 'none';
                    if (overlay) overlay.style.display = 'block';
                }
                restoreBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    console.log('🎬 Restoring WTV miniplayer...');
                    window._showWtvMiniplayer();
                    console.log('✅ WTV miniplayer restored successfully');
                });
                console.log('✅ WTV restore button listener attached');
            } else {
                console.error('❌ Could not find restore button or miniplayer');
            }

            // On resize, sync state
            window.addEventListener('resize', () => {
                const hidden = localStorage.getItem('videoMiniplayerHidden') === 'true';
                if (isMobile()) {
                    if (restoreBtn) restoreBtn.style.display = 'none';
                    if (hidden) {
                        miniplayer.classList.add('mobile-drawer-closed');
                        miniplayer.style.display = 'none';
                        if (mobileTab) mobileTab.style.display = 'flex';
                        if (overlay) overlay.style.display = 'none';
                    }
                } else {
                    if (mobileTab) mobileTab.style.display = 'none';
                    if (overlay) overlay.style.display = 'none';
                    miniplayer.classList.remove('mobile-drawer-closed');
                    if (hidden) {
                        miniplayer.style.display = 'none';
                        if (restoreBtn) restoreBtn.style.display = 'flex';
                    } else {
                        miniplayer.style.display = 'flex';
                    }
                }
            });
        })();

        // ══════════════════════════════════════════════════════════════════════════
        // MOBILE SWIPE NAVIGATION
        // ══════════════════════════════════════════════════════════════════════════
        (function initSwipeNavigation() {
            if (window.innerWidth > 768) return; // Desktop only uses clicks

            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            const minSwipeDistance = 50; // minimum distance for swipe in pixels

            const container = document.querySelector('.container');
            if (!container) return;

            container.addEventListener('touchstart', (e) => {
                // Don't interfere with swipes on the WTV drawer or overlay
                if (e.target.closest('#video-miniplayer') || e.target.closest('#wtv-drawer-overlay')) return;
                
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            container.addEventListener('touchend', (e) => {
                // Don't interfere with swipes on the WTV drawer or overlay
                if (e.target.closest('#video-miniplayer') || e.target.closest('#wtv-drawer-overlay')) return;
                
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipe();
            }, { passive: true });

            function handleSwipe() {
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                
                // Only trigger swipe if horizontal movement is greater than vertical
                if (Math.abs(deltaX) < Math.abs(deltaY)) return;
                if (Math.abs(deltaX) < minSwipeDistance) return;

                // Get current active tab
                const currentContent = document.querySelector('.content.active');
                if (!currentContent) return;
                
                const currentTabName = currentContent.id;
                const currentIndex = tabOrder.indexOf(currentTabName);
                if (currentIndex === -1) return;

                let newIndex = currentIndex;
                let direction = null;

                if (deltaX > 0) {
                    // Swipe right -> go to previous tab
                    if (currentIndex > 0) {
                        newIndex = currentIndex - 1;
                        direction = 'right';
                    }
                } else {
                    // Swipe left -> go to next tab
                    if (currentIndex < tabOrder.length - 1) {
                        newIndex = currentIndex + 1;
                        direction = 'left';
                    }
                }

                if (newIndex !== currentIndex && direction) {
                    const newTabName = tabOrder[newIndex];
                    showTab(newTabName, direction);
                }
            }

            // Re-initialize on orientation change or resize from desktop to mobile
            window.addEventListener('resize', () => {
                if (window.innerWidth <= 768) {
                    // Already initialized, do nothing
                } else {
                    // Switched to desktop, remove listeners if needed
                    // (not removing for simplicity since condition checks width)
                }
            });
        })();
    </script>

</body>

</html>